name: Create compare reference (Linux worker)

on:
  pull_request:
  push:
    tags:
      - 'ammr-*'
  workflow_dispatch:
    inputs:
      git_reference:
        description: 'Which Git reference to check out. Examples: "refs/tags/v0.2.1", "refs/heads/master".'
        default: refs/tags/vX.Y.Z
        required: true


concurrency: 
  group: compare-test-${{ github.ref }}
  cancel-in-progress: true


jobs:
  test:
    runs-on: [self-hosted, linux]
    container: ghcr.io/anybody/anybodycon-linux:latest

    steps:
      - name: Set variables
        env:
          DEFAULT_GIT_REFERENCE: refs/heads/master
        run: |
          echo "GIT_REFERENCE=${{ github.event.inputs.git_reference || env.DEFAULT_GIT_REFERENCE }}" >> $GITHUB_ENV


      - name: Checkout repository at ${{ env.GIT_REFERENCE }}
        uses: actions/checkout@v2
        with:
          ref: ${{ env.GIT_REFERENCE }}
          fetch-depth: 0


      - name: Run test for compare
        env:
          RLM_LICENSE_PASSWORD: ${{ secrets.LICENSE_PASSWORD }}
        run: |
          pytest --anytest-output=${{runner.temp}} --anytest-name=${{ env.GIT_REFERENCE }} Tests/Applications/test_JumpingJack.any

      # - name: Compress compare data
      #   run: |
      #     cd ${{runner.temp}}
      #     tar -zcvf compare-data.tar.gz ./${{ env.GIT_REFERENCE }}

      - name: Storage container name
        shell: python
        run: |
          import os, anypytools
          name = anypytools.tools.anybodycon_version()
          name = ver.partition(" (")[0].replace(" ","")
          name = "linux-ams-"+name.replace(".","-")
          with open(os.environ["GITHUB_ENV"], "a") as fp:
            fp.write(f"CONTAINER_NAME=name")

      - uses: LanceMcCarthy/Action-AzureBlobUpload@v1.9.0
        name: Azure Blob Upload with Destination folder defined
        with:
          connection_string: ${{ secrets.AZURE_CONN_STR }}
          container_name: ${{env.CONTAINER_NAME}}
          source_folder: ${{runner.temp}}/${{ env.GIT_REFERENCE }}
          destination_folder: ${{ env.GIT_REFERENCE }}
          clean_destination_folder: true
          fail_if_source_empty: true

      # - name: Create Upload script
      #   env: 
      #     AZURE_CONN_STR: ${{ secrets.AZURE_CONN_STR }}
      #     AZURE_BLOB_NAME: ${{ env.COMPARE_TEST_NAME }}
      #   shell: python
      #   run: |
      #     import os, sys
      #     from azure.storage.blob import BlobServiceClient
      #     container_name = "linux-ams-" + os.environ['AMS_VERSION'].replace('.','-')
      #     blob_name = os.environ["AZURE_BLOB_NAME"]
      #     container_client = BlobServiceClient.from_connection_string(
      #         os.environ["AZURE_CONN_STR"]
      #     ).get_container_client(container_name)
      #     if not container_client.exists():
      #       container_client.create_container()
      #     with open("${{runner.temp}}/compare-data.tar.gz", "rb") as fh:
      #         container_client.upload_blob(blob_name, fh, overwrite=True)

