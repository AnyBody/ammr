BodyModel.Right.Leg.Jnt = {
  AnyRevoluteJoint Inv_TF = {
    Axis = z;
    AnyRefFrame &InvFemur = Main.HumanModel.BodyModel.Right.Leg.Seg.InvisibleFemur_TF;
    AnyRefFrame &InvTibia= Main.HumanModel.BodyModel.Right.Leg.Seg.InvisibleTibia;
  };
  
  AnyKinMeasureOrg Knee = {
  AnyKinEq Constraints = {
    AnyKinMeasure &InvisibleFemurMedialEFCDriver = .InvisibleFemurMedialEFCDriver_LinComb;
    AnyKinMeasure &InvisibleFemurLateralEFCDriver  = .InvisibleFemurLateralEFCDriver_LinComb;
    AnyKinMeasure &InvisibleFemurZRot = .InvisibleFemurZRot_org; 
    AnyKinMeasure &InvisibleTibiaMedialEFCDriver = .InvisibleTibiaMedialEFCDriver_LinComb; 
    AnyKinMeasure &InvisibleTibiaLateralEFCDriver = .InvisibleTibiaLateralEFCDriver_LinComb; 
    AnyKinMeasure &InvisibleTibiaZRot = .InvisibleTibiaZRot_org; 
  };

  
  
  ////--------------------------------------------
  //// NEED TO UPDATE THESE MEASURES  WITH INVISIBLE JOINT DRIVERS EOS CODE!
  ////--------------------------------------------
  AnyKinMeasureLinComb InvisibleFemurMedialEFCDriver_LinComb = {
      Coef = {{1.0,0.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.Medial_TF_FFC.sRel[0]-...Seg.Thigh.Medial_TF_EFC.sRel[0])},{0.0,1.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.Medial_TF_FFC.sRel[1]-...Seg.Thigh.Medial_TF_EFC.sRel[1])},{0.0,0.0,1.0,1.0/(pi/2.0)*(...Seg.Thigh.Medial_TF_FFC.sRel[2]-...Seg.Thigh.Medial_TF_EFC.sRel[2])}};
      Const ={0.0,0.0,0.0};
      AnyKinLinear FemurTrans = {
        Ref = 0;
        AnyRefFrame &ref1 = ....Seg.Thigh.Medial_TF_EFC;
        AnyRefFrame &ref2 = ....Seg.InvisibleFemur_TF.MA_AnatomicalFrame.Medial_TF_EFC;
      };
      AnyKinMeasure &KneeFlexion = ..Inv_TF;
      OutDim = 3;  
    };
  
    AnyKinMeasureLinComb InvisibleFemurLateralEFCDriver_LinComb = {
      Coef = {{1.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.Lateral_TF_FFC_new.sRel[0]-...Seg.Thigh.Lateral_TF_EFC.sRel[0])},{0.0,1.0,1.0/(pi/2.0)*(...Seg.Thigh.Lateral_TF_FFC_new.sRel[1]-...Seg.Thigh.Lateral_TF_EFC.sRel[1])}};
      Const ={0.0,0.0};
      AnyKinMeasureOrg org = {
        AnyKinLinear FemurTrans = {
          Ref = 0; 
          AnyRefFrame &ref1 = .....Seg.Thigh.Lateral_TF_EFC;
          AnyRefFrame &ref2 = .....Seg.InvisibleFemur_TF.MA_AnatomicalFrame.Lateral_TF_EFC;
        };
                MeasureOrganizer = {0,1}; 
              };
      AnyKinMeasure &KneeFlexion = ..Inv_TF;
      OutDim = 2;  
    };
  
    AnyKinMeasureOrg InvisibleFemurZRot_org = {
      AnyKinRotational InvisibleFemurZRot_rot = {
        Type = RotAxesAngles;
        Axis1 = z; //z
        Axis2 = x; //x
        Axis3 = y; //y
        AnyRefFrame &ref1 = ....Seg.Thigh.KneeJointAnatomicalFrame.InvisibleFemurRotationNode;
        AnyRefFrame &ref2 = ....Seg.InvisibleFemur_TF;          
      };
      MeasureOrganizer = {0};// 0
    };

    AnyKinMeasureLinComb InvisibleTibiaMedialEFCDriver_LinComb = {
      Coef = {{1.0,0.0,0.0,1.0/(pi/2.0)*(...Seg.Shank.Medial_TF_FFC.sRel[0]-...Seg.Shank.Medial_TF_EFC.sRel[0])},{0.0,1.0,0.0,1.0/(pi/2.0)*(...Seg.Shank.Medial_TF_FFC.sRel[1]-...Seg.Shank.Medial_TF_EFC.sRel[1])},{0.0,0.0,1.0,1.0/(pi/2.0)*(...Seg.Shank.Medial_TF_FFC.sRel[2]-...Seg.Shank.Medial_TF_EFC.sRel[2])}};
      Const ={0.0,0.0,0.0};
      AnyKinLinear TibiaTrans = {
        Ref = 0;
        AnyRefFrame &ref1 = ....Seg.Shank.Medial_TF_EFC;
        AnyRefFrame &ref2 = ....Seg.InvisibleTibia.MA_AnatomicalFrame.Medial_TF_EFC;
      };
      AnyKinMeasure &KneeFlexion = ..Inv_TF;
      OutDim = 3;  
    };
  
    AnyKinMeasureLinComb InvisibleTibiaLateralEFCDriver_LinComb = {
      Coef = {{1.0,0.0,1.0/(pi/2.0)*(...Seg.Shank.Lateral_TF_FFC_new.sRel[0]-...Seg.Shank.Lateral_TF_EFC.sRel[0])},{0.0,1.0,1.0/(pi/2.0)*(...Seg.Shank.Lateral_TF_FFC_new.sRel[1]-...Seg.Shank.Lateral_TF_EFC.sRel[1])}};
      Const ={0.0,0.0};
      AnyKinMeasureOrg org = {
        AnyKinLinear TibiaTrans = {
          Ref = 0; 
          AnyRefFrame &ref1 = .....Seg.Shank.Lateral_TF_EFC;
          AnyRefFrame &ref2 = .....Seg.InvisibleTibia.MA_AnatomicalFrame.Lateral_TF_EFC;
        };
        MeasureOrganizer = {0,1};
      };
      AnyKinMeasure &KneeFlexion = ..Inv_TF;         
      OutDim = 2;  
    };
  
    AnyKinMeasureOrg InvisibleTibiaZRot_org = {
      AnyKinRotational InvisibleTibiaZRot_rot = {
        Type = RotAxesAngles;
        Axis1 = z;
        Axis2 = x;
        Axis3 = y;
        AnyRefFrame &ref1 = ....Seg.Shank.KneeJointAnatomicalFrame.InvisibleFemurRotationNode;
        AnyRefFrame &ref2 = ....Seg.InvisibleTibia;          
      };
      MeasureOrganizer = {0};
    };
  };
};
