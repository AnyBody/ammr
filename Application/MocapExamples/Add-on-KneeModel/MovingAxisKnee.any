
// RIGHT KNEE ONLY
AnyFolder MovingAxisKnee = {
  // exclude knee joint
  AnyFolder Exclusions = {
    AnyObjectPtrArray l1 = ObjSearch("..HumanModel.BodyModel.Right.Leg.Seg.Thigh.KneeJoint","AnyMechObject");
    AnyObjectPtrArray l2 = ObjSearchRecursive("..HumanModel.BodyModel.Right.Leg.Jnt.Knee","*","AnyMechObject"); 
    
    AnyObjectPtrArray l3 = ObjSearch("..HumanModel.BodyModel.Right.Leg.Seg.Thigh.PatellaFemurJoint","AnyMechObject");
    AnyObjectPtrArray l4 = ObjSearchRecursive("..HumanModel.BodyModel.Right.Leg.Jnt.PatellaFemur","*","AnyMechObject");
    
    AnyObjectPtrArray KneeExcludeList = arrcat(l1,l2);
    AnyObjectPtrArray PatellaExcludeList = arrcat(l3,l4);
    
    #if TF_MOVING_AXIS_KNEE == 1 & PF_MOVING_AXIS_KNEE == 1  
    AnyObjectPtrArray excludelist = arrcat(KneeExcludeList,PatellaExcludeList);
    #endif
    
    #if TF_MOVING_AXIS_KNEE == 1 & PF_MOVING_AXIS_KNEE == 0
    AnyObjectPtrArray excludelist = arrcat(KneeExcludeList);  
    #endif
    
    #if TF_MOVING_AXIS_KNEE == 0 & PF_MOVING_AXIS_KNEE == 1
    AnyObjectPtrArray excludelist = arrcat(PatellaExcludeList);  
    #endif
    
  };
  
  Main.Studies.HumanModel.BodyModel.Right.Leg.Seg = {
    AnyFolder UnitVectors = {
      // Length between Tibiofemoral EFCs m->l (Femur Registration)
      // Unit Vector directed along Tibiofemoral FFCs m->l (Femur Registration)
      AnyVar L1 = vnorm(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC -Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC,2.0);
      AnyVec3 e1 = (Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_FFC - Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_FFC)/vnorm(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_FFC-Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_FFC); 
      // Length between Patellofemoral EFCs m->l (Femur Registration)
      // Unit Vector directed alont Patellofemoral FFCs m->l (Femur Registration)
      AnyVar L2 = vnorm(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC -Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC,2.0);
      AnyVec3 e2 = (Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_FFC - Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_FFC)/vnorm(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_FFC-Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_FFC); 
      // Length between Tibiofemoral ECFs m->l (Femur Registration)
      // Unit Vector directed along Tibiofemoral FFCs m->l (Tibia Registration)
      AnyVar L3 = vnorm(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC - Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC,2.0);
      AnyVec3 e3 = (Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Lateral_TF_FFC - Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Medial_TF_FFC)/vnorm(Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Lateral_TF_FFC -Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Medial_TF_FFC); 
      // Length between Patellofemoral EFCs m->l (Femur Registration)
      // Unit Vector directed along Patellofemoral m->l FFCs (Patella Registration)
      AnyVar L4 = vnorm(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC -Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC,2.0);
      AnyVec3 e4 = (Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Lateral_PF_FFC - Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Medial_PF_FFC)/vnorm(Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Lateral_PF_FFC-Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Medial_PF_FFC); 
    };
  };
           
  // Add new moving axis knee model
  Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.Thigh = {
    AnyRefNode MRIAnatomicalReferenceFrame = {
//      AnyDrawRefFrame drw ={};
      AnyMat33 AOffset = RotMat(.CustomMarkerScaling(.LateralDistalFemurEdge.sRel_us),.CustomMarkerScaling(.FemurNotch.sRel_us),.CustomMarkerScaling(.HipJointCenter.sRel_us))*RotMat(-pi/2,y);
      AnyVec3 rOffset = .CustomMarkerScaling(.FemurNotch.sRel_us);
      ARel = AOffset;
      sRel = rOffset;
      
#if TF_MOVING_AXIS_KNEE == 1       
      AnyRefNode Lateral_TF_EFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC)
//        AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};         
      };
      AnyRefNode TEMP_Lateral_TF_FFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_FFC)
        //        AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};         
      };
      AnyRefNode Medial_TF_EFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC)
//        AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};         
      };
      AnyRefNode Medial_TF_FFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_FFC)
        AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={1,1,1};}; 
      };
 
     AnyRefNode InvisibleFemurRotationNode = {
        sRel = ...InvisibleFemur_TF.MRIAnatomicalReferenceFrame.sRel;
        ARel = .AOffset'*...InvisibleFemur_TF.MRIAnatomicalReferenceFrame.ARel;
        //          AnyDrawRefFrame drw ={};
      };
      AnyRefNode Lateral_TF_FFC = { 
        AnyVec3 sRelMRI = (Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_FFC)+(...UnitVectors.e1*...UnitVectors.L1);
        //transforms back into global
        DEFINE_LOCAL_COORDINATE(sRelMRI)
        //transforms from global to Femur local
        AnyDrawNode drw ={ScaleXYZ=0.001*{1,1,1};};   
      };
#endif
      
#if PF_MOVING_AXIS_KNEE == 1  

     AnyRefNode Lateral_PF_EFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC)
      };
        
      AnyRefNode Medial_PF_EFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC)
      };
      AnyRefNode Medial_PF_FFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_FFC)
        AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};}; 
      };
      AnyRefNode InvisiblePatellaRotationNode = {
        sRel = (-.rOffset*.AOffset) + ...InvisiblePatella.MRIAnatomicalReferenceFrame.sRel;
        ARel = .AOffset'*...InvisiblePatella.MRIAnatomicalReferenceFrame.ARel;
      };
     AnyRefNode Lateral_PF_FFC = {
        AnyVec3 sRelMRI = (Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_FFC)+(...UnitVectors.e2*...UnitVectors.L2);
        //transforms back into global
        DEFINE_LOCAL_COORDINATE(sRelMRI)
        //transforms from global to  Femur local
        AnyDrawNode drw ={ScaleXYZ=0.001*{1,1,1};RGB={0,0,1};};
      };       
#endif
     
    };   // close MRIAnatomicalReferenceFrame
  };//Close Thigh Segment
   
  Main.Studies.HumanModel.BodyModel.Right.Leg.Seg = {
   #if TF_MOVING_AXIS_KNEE == 1 
    AnySeg InvisibleFemur_TF = {
      AnyFunTransform3D &CustomMarkerScaling = Main.Studies.HumanModel.SubjectSpecificScaling.Right.Thigh.RegistrationTransform; 
      Mass = 0;
      Jii = {0,0,0}; 
      r0 = .Thigh.r0+MRIAnatomicalReferenceFrame.rOffset*.Thigh.Axes0';
      Axes0 = .Thigh.Axes0*MRIAnatomicalReferenceFrame.AOffset;
//      AnyDrawRefFrame drw ={ScaleXYZ=0.001*{1,1,1};RGB={1,0,0};};         
      AnyRefNode MRIAnatomicalReferenceFrame = {
//        AnyDrawRefFrame drw ={ScaleXYZ=0.002*{1,1,1};};
        AnyMat33 AOffset = RotMat(.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC),.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC),.CustomMarkerScaling(Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.Thigh.HipJointCenter.sRel_us))*RotMat(pi/2,y);
        AnyVec3 rOffset = (.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC)+.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC))/2;             
        AnyRefNode Lateral_TF_EFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC)
          AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};          
        };
        AnyRefNode TEMP_Lateral_TF_FFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_FFC)
        };
        AnyRefNode Medial_TF_EFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC)
          AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};           
        };
        AnyRefNode Medial_TF_FFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_FFC)
        };    
        AnyRefNode Lateral_TF_FFC = { 
          AnyVec3 sRelMRI = (Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_FFC)+(...UnitVectors.e1*...UnitVectors.L1);
          //transforms back into global
          DEFINE_LOCAL_COORDINATE(sRelMRI)
          //transforms from global to Femur local
        };
      };// close MRIAnatomicalReferenceFrame
    }; // Close InvisibleFemur_TF Segment
    #endif
    
    #if PF_MOVING_AXIS_KNEE == 1  
    AnySeg InvisibleFemur_PF = {
//      AnyFunTransform3D &CustomMarkerScaling = Main.Studies.HumanModel.SubjectSpecificScaling.Right.Patella.RegistrationTransform; 
      AnyFunTransform3D &CustomMarkerScaling = Main.Studies.HumanModel.SubjectSpecificScaling.Right.Thigh.RegistrationTransform; 
      //AnyDrawRefFrame drw ={RGB={1,0,0};};         
      Mass = 0;
      Jii = {0,0,0}; 
      r0 = .Thigh.r0+MRIAnatomicalReferenceFrame.rOffset*.Thigh.Axes0';
      Axes0 = .Thigh.Axes0*MRIAnatomicalReferenceFrame.AOffset;
      AnyRefNode MRIAnatomicalReferenceFrame = {
//        AnyDrawRefFrame drw ={ScaleXYZ=0.002*{1,1,1};};
        AnyMat33 AOffset = RotMat(.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC),.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC),.CustomMarkerScaling(Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.Patella.SupNodeBL.sRel_us))*RotMat(pi/2,y);
        AnyVec3 rOffset = (.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC)+.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC))/2;             
        AnyRefNode Lateral_PF_EFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC)
          AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};               
        };
        AnyRefNode TEMP_Lateral_PF_FFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_FFC)
        };
        AnyRefNode Medial_PF_EFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC)
          AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};               
        };
        AnyRefNode Medial_PF_FFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_FFC)
        };
        AnyRefNode Lateral_PF_FFC = {
          AnyVec3 sRelMRI = (Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_FFC) + (...UnitVectors.e2*...UnitVectors.L2);
          //transforms back into global
          DEFINE_LOCAL_COORDINATE(sRelMRI)
          //transforms from global to Invisible Femur local
        };
      }; // close MRIAnatomicalReferenceFrame
    }; // Close InvisibleFemur_PF Segment
    #endif
  };// Close Segment Folder

#if PF_MOVING_AXIS_KNEE == 1    
  Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.Patella = {
    AnyRefNode MRIAnatomicalReferenceFrame = {
//      AnyDrawRefFrame drw ={};
      AnyMat33 AOffset = RotMat(.CustomMarkerScaling(.LatNodeBL.sRel_us),.CustomMarkerScaling(.PatellaOrigin.sRel_us),.CustomMarkerScaling(.SupNodeBL.sRel_us))*RotMat(-pi/2,y);
      AnyVec3 rOffset = .CustomMarkerScaling(.PatellaOrigin.sRel_us); 
      ARel = AOffset;
      sRel = rOffset;            
      AnyRefNode Lateral_PF_EFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC)
      };
      AnyRefNode TEMP_Lateral_PF_FFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Lateral_PF_FFC)
      };
      AnyRefNode Medial_PF_EFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC)
      };
      AnyRefNode Medial_PF_FFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Medial_PF_FFC)
        AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={1,1,1};};               
      };
      AnyRefNode InvisiblePatellaRotationNode = {
        sRel = ...InvisiblePatella.MRIAnatomicalReferenceFrame.sRel;
        ARel = .AOffset'*...InvisiblePatella.MRIAnatomicalReferenceFrame.ARel;
      };
      AnyRefNode Lateral_PF_FFC = {
        AnyVec3 sRelMRI = (Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Medial_PF_FFC) + (...UnitVectors.e4*...UnitVectors.L4);
        //transforms back into global
        DEFINE_LOCAL_COORDINATE(sRelMRI)
        //transforms from global to Patella local
        AnyDrawNode drw ={ScaleXYZ=0.001*{1,1,1};};
      };
    };// close MRIAnatomicalReferenceFrame
  };// close Patella Segment
  
  Main.Studies.HumanModel.BodyModel.Right.Leg.Seg = {    
    AnySeg InvisiblePatella = {
      AnyFunTransform3D &CustomMarkerScaling = Main.Studies.HumanModel.SubjectSpecificScaling.Right.Patella.RegistrationTransform; 
 //     AnyDrawRefFrame drw ={RGB={1,0,0};};     
      Mass = 0;
      Jii = {0,0,0}; 
      r0 = .Patella.r0+MRIAnatomicalReferenceFrame.rOffset*.Patella.Axes0';
      Axes0 = .Patella.Axes0*MRIAnatomicalReferenceFrame.AOffset;
      AnyRefNode MRIAnatomicalReferenceFrame = {
//        AnyDrawRefFrame drw ={ScaleXYZ=0.002*{1,1,1};};
        AnyMat33 AOffset = RotMat(.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC),.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC),.CustomMarkerScaling(Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.Patella.SupNodeBL.sRel_us))*RotMat(pi/2,y);
        AnyVec3 rOffset = (.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC)+.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC))/2;        
        AnyRefNode Lateral_PF_EFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_PF_EFC)
          AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={1,1,1};};               
        };
        AnyRefNode TEMP_Lateral_PF_FFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Lateral_PF_FFC)
        };
        AnyRefNode Medial_PF_EFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_PF_EFC)
          AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={1,1,1};};               
        };
        AnyRefNode Medial_PF_FFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Medial_PF_FFC)
        };
        AnyRefNode Lateral_PF_FFC = {
          AnyVec3 sRelMRI = (Main.MRI_Data.Right.R_FemurLandmarks.PatellaRegistration.Medial_PF_FFC) + (...UnitVectors.e4*...UnitVectors.L4);
          //transforms back into global
          DEFINE_LOCAL_COORDINATE(sRelMRI)
          //transforms from global to Patella local
        };
      }; // close MRIAnatomicalReferenceFrame
    }; // close InvisiblePatella Segment
  }; // close Segment Folder
 #endif  

#if TF_MOVING_AXIS_KNEE == 1 
 Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.Shank = {
    AnyRefNode MRIAnatomicalReferenceFrame = {
      AnyMat33 AOffset = RotMat(.CustomMarkerScaling(.LateralTibiaEdge.sRel_us),.CustomMarkerScaling(.MedialTibiaIntercondylar.sRel_us),.CustomMarkerScaling(.TalocruralJoint_Origin.sRel_us))*RotMat(-pi/2,y)*RotMat(pi,z);
      AnyVec3 rOffset = .CustomMarkerScaling(.MedialTibiaIntercondylar.sRel_us);
      AnyDrawRefFrame drw = {};
      ARel = AOffset;
      sRel = rOffset; 
      AnyRefNode Lateral_TF_EFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC)
      };
      AnyRefNode TEMP_Lateral_TF_FFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Lateral_TF_FFC)
      };
      AnyRefNode Medial_TF_EFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC)
      };
      AnyRefNode Medial_TF_FFC = {
        DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Medial_TF_FFC)
        AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={1,0,0};};              
      };
      AnyRefNode InvisibleFemurRotationNode = {
        sRel = ...InvisibleFemur_TF.MRIAnatomicalReferenceFrame.sRel;
        ARel = .AOffset'*...InvisibleFemur_TF.MRIAnatomicalReferenceFrame.ARel;
      };   
      AnyRefNode Lateral_TF_FFC = {
        AnyVec3 sRelMRI = (Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Medial_TF_FFC) + (...UnitVectors.e3*...UnitVectors.L3); 
        //transforms back into global
        DEFINE_LOCAL_COORDINATE(sRelMRI)
        //transforms from global to tibia local
        AnyDrawNode drw ={ScaleXYZ=0.001*{1,1,1};RGB={1,0,0};};   
      };
    }; // close mrianatomicalreferenceframe
  }; // close shank segment
  
  Main.Studies.HumanModel.BodyModel.Right.Leg.Seg = {    
    AnySeg InvisibleTibia = {
      AnyFunTransform3D &CustomMarkerScaling = Main.Studies.HumanModel.SubjectSpecificScaling.Right.Shank.RegistrationTransform;  
      Mass = 0;
      Jii = {0, 0, 0};
      r0 = .Shank.r0+MRIAnatomicalReferenceFrame.rOffset*.Shank.Axes0';
      Axes0 = .Shank.Axes0*MRIAnatomicalReferenceFrame.AOffset;
      AnyRefNode MRIAnatomicalReferenceFrame = {
        AnyMat33 AOffset = RotMat(.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC),.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC),.CustomMarkerScaling(Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.Thigh.HipJointCenter.sRel_us))*RotMat(pi/2,y);
        AnyVec3 rOffset = (.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC)+.CustomMarkerScaling(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC))/2;         
//        AnyDrawRefFrame drw ={};

        AnyRefNode Lateral_TF_EFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Lateral_TF_EFC)
          AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};              
        };
        AnyRefNode TEMP_Lateral_TF_FFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Lateral_TF_FFC)
        };
        AnyRefNode Medial_TF_EFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.FemurRegistration.Medial_TF_EFC)
          AnyDrawNode drw ={ScaleXYZ=0.002*{1,1,1};RGB={0,0,1};};              
        };
        AnyRefNode Medial_TF_FFC = {
          DEFINE_LOCAL_COORDINATE(Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Medial_TF_FFC)
        };       
        AnyRefNode Lateral_TF_FFC = {
          AnyVec3 sRelMRI = (Main.MRI_Data.Right.R_FemurLandmarks.TibiaRegistration.Medial_TF_FFC) + (...UnitVectors.e3*...UnitVectors.L3);
          //transforms back into global
          DEFINE_LOCAL_COORDINATE(sRelMRI)
          //transforms from global to invisible tibia local
        };
      }; // close mrianatomicalreferenceframe
    }; // Close InvisibleTibia Segment
  }; // Close segment folder
 #endif
 
  Main.Studies.HumanModel.BodyModel.Right.Leg.Jnt = {
    #if TF_MOVING_AXIS_KNEE == 1  
    AnyRevoluteJoint Inv_TF = {
      Axis = z;
      AnyRefFrame &InvFemur = Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.InvisibleFemur_TF;
      AnyRefFrame &InvTibia= Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.InvisibleTibia;
      //      AnyDrawStdJoint drw = {};
    };
    //----------------------------------------------------------------           
    // Drivers for the movement of the femoral axis
    //----------------------------------------------------------------       
    AnyKinEq InvisibleFemurMedialEFCDriver = {
      AnyKinMeasureLinComb LinComb = {
        Coef = {{1.0,0.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_TF_FFC.sRel[0]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_TF_EFC.sRel[0])},{0.0,1.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_TF_FFC.sRel[1]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_TF_EFC.sRel[1])},{0.0,0.0,1.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_TF_FFC.sRel[2]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_TF_EFC.sRel[2])}};
        Const ={0.0,0.0,0.0};
        AnyKinLinear FemurTrans = {
          Ref = 0;
          AnyRefFrame &ref1 = ....Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_TF_EFC;
          AnyRefFrame &ref2 = ....Seg.InvisibleFemur_TF.MRIAnatomicalReferenceFrame.Medial_TF_EFC;
        };
        AnyKinMeasure &KneeFlexion = ..Inv_TF;
        OutDim = 3;  
      };
    };
    
    AnyKinEq InvisibleFemurLateralEFCDriver = {
      AnyKinMeasureLinComb LinComb = {
        Coef = {{1.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_TF_FFC.sRel[0]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_TF_EFC.sRel[0])},{0.0,1.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_TF_FFC.sRel[1]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_TF_EFC.sRel[1])}};
        Const ={0.0,0.0};
        AnyKinMeasureOrg org = {
          AnyKinLinear FemurTrans = {
            Ref = 0; 
            AnyRefFrame &ref1 = .....Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_TF_EFC;
            AnyRefFrame &ref2 = .....Seg.InvisibleFemur_TF.MRIAnatomicalReferenceFrame.Lateral_TF_EFC;
          };
          MeasureOrganizer = {0,1}; 
        };
        AnyKinMeasure &KneeFlexion = ..Inv_TF;
        OutDim = 2;  
      };
    };
    
    AnyKinEq InvisibleFemurZRot = { 
      AnyKinMeasureOrg org = {
        AnyKinRotational rot = {
          Type = RotAxesAngles;
          Axis1 = z;
          Axis2 = x;
          Axis3 = y;
          AnyRefFrame &ref1 = ....Seg.Thigh.MRIAnatomicalReferenceFrame.InvisibleFemurRotationNode;
          AnyRefFrame &ref2 = ....Seg.InvisibleFemur_TF;          
        };
        MeasureOrganizer = {0};// 
      };
    };
    //----------------------------------------------------------------       
    // Drivers for the movement of the tibial axis
    //----------------------------------------------------------------       

    AnyKinEq InvisibleTibiaMedialEFCDriver = {
      AnyKinMeasureLinComb LinComb = {
        Coef = {{1.0,0.0,0.0,1.0/(pi/2.0)*(...Seg.Shank.MRIAnatomicalReferenceFrame.Medial_TF_FFC.sRel[0]-...Seg.Shank.MRIAnatomicalReferenceFrame.Medial_TF_EFC.sRel[0])},{0.0,1.0,0.0,1.0/(pi/2.0)*(...Seg.Shank.MRIAnatomicalReferenceFrame.Medial_TF_FFC.sRel[1]-...Seg.Shank.MRIAnatomicalReferenceFrame.Medial_TF_EFC.sRel[1])},{0.0,0.0,1.0,1.0/(pi/2.0)*(...Seg.Shank.MRIAnatomicalReferenceFrame.Medial_TF_FFC.sRel[2]-...Seg.Shank.MRIAnatomicalReferenceFrame.Medial_TF_EFC.sRel[2])}};
        Const ={0.0,0.0,0.0};
        AnyKinLinear TibiaTrans = {
          Ref = 0;
          AnyRefFrame &ref1 = ....Seg.Shank.MRIAnatomicalReferenceFrame.Medial_TF_EFC;
          AnyRefFrame &ref2 = ....Seg.InvisibleTibia.MRIAnatomicalReferenceFrame.Medial_TF_EFC;
        };
        
        AnyKinMeasure &KneeFlexion = ..Inv_TF;
        OutDim = 3;  
      };
    };
    
    AnyKinEq InvisibleTibiaLateralEFCDriver = {
      AnyKinMeasureLinComb LinComb = {
        Coef = {{1.0,0.0,1.0/(pi/2.0)*(...Seg.Shank.MRIAnatomicalReferenceFrame.Lateral_TF_FFC.sRel[0]-...Seg.Shank.MRIAnatomicalReferenceFrame.Lateral_TF_EFC.sRel[0])},{0.0,1.0,1.0/(pi/2.0)*(...Seg.Shank.MRIAnatomicalReferenceFrame.Lateral_TF_FFC.sRel[1]-...Seg.Shank.MRIAnatomicalReferenceFrame.Lateral_TF_EFC.sRel[1])}};
        Const ={0.0,0.0};
        AnyKinMeasureOrg org = {
          AnyKinLinear TibiaTrans = {
            Ref = 0; 
            AnyRefFrame &ref1 = .....Seg.Shank.MRIAnatomicalReferenceFrame.Lateral_TF_EFC;
            AnyRefFrame &ref2 = .....Seg.InvisibleTibia.MRIAnatomicalReferenceFrame.Lateral_TF_EFC;
          };
          MeasureOrganizer = {0,1};
        };
        

        AnyKinMeasure &KneeFlexion = ..Inv_TF;

        OutDim = 2;  
      };
    };
    
    AnyKinEq InvisibleTibiaZRot = {
      AnyKinMeasureOrg org = {
        AnyKinRotational rot = {
          Type = RotAxesAngles;
          Axis1 = z;
          Axis2 = x;
          Axis3 = y;
          AnyRefFrame &ref1 = ....Seg.Shank.MRIAnatomicalReferenceFrame.InvisibleFemurRotationNode;
          AnyRefFrame &ref2 = ....Seg.InvisibleTibia;          
        };
        MeasureOrganizer = {0};
      };
    };
    #endif
    
    #if PF_MOVING_AXIS_KNEE == 1
    AnyRevoluteJoint Inv_PF = { 
      Axis = z;
      AnyRefFrame &InvPatella = Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.InvisiblePatella;
      AnyRefFrame &InvFemur = Main.Studies.HumanModel.BodyModel.Right.Leg.Seg.InvisibleFemur_PF;
     // AnyDrawStdJoint drw = {};
    };
    
    
    //----------------------
    //----------------------------------------------------------------           
    // Drivers for the movement of the femoral_PF axis
    //----------------------------------------------------------------       
    AnyKinEq InvisibleFemurMedialEFCDriver_PF = {
      AnyKinMeasureLinComb LinComb = {
        Coef = {{1.0,0.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_PF_FFC.sRel[0]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_PF_EFC.sRel[0])},{0.0,1.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_PF_FFC.sRel[1]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_PF_EFC.sRel[1])},{0.0,0.0,1.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_PF_FFC.sRel[2]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_PF_EFC.sRel[2])}};
        Const ={0.0,0.0,0.0};
        AnyKinLinear FemurTrans = {
          Ref = 0;
          AnyRefFrame &ref1 = ....Seg.Thigh.MRIAnatomicalReferenceFrame.Medial_PF_EFC;
          AnyRefFrame &ref2 = ....Seg.InvisibleFemur_PF.MRIAnatomicalReferenceFrame.Medial_PF_EFC;
        };
 #if TF_MOVING_AXIS_KNEE == 1         
        AnyKinMeasure &KneeFlexion = ..Inv_TF;
#else
       AnyKinMeasureOrg KneeFlexion = {
         AnyKinRotational rot = {
           Type = RotAxesAngles;
           Axis1 = z;
           Axis2 = y;
           Axis3 = x;
           
           AnyRefFrame &ref1 = .....Seg.Thigh.KneeJoint;
           AnyRefFrame &ref2 = .....Seg.Shank.KneeJoint;
         };
         MeasureOrganizer = {0};
       };

#endif       OutDim = 3;  
      };
    };
    
    AnyKinEq InvisibleFemurLateralEFCDriver_PF = {
      AnyKinMeasureLinComb LinComb = {
        Coef = {{1.0,0.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_PF_FFC.sRel[0]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_PF_EFC.sRel[0])},{0.0,1.0,1.0/(pi/2.0)*(...Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_PF_FFC.sRel[1]-...Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_PF_EFC.sRel[1])}};
        Const ={0.0,0.0};
        AnyKinMeasureOrg org = {
          AnyKinLinear FemurTrans = {
            Ref = 0; 
            AnyRefFrame &ref1 = .....Seg.Thigh.MRIAnatomicalReferenceFrame.Lateral_PF_EFC;
            AnyRefFrame &ref2 = .....Seg.InvisibleFemur_PF.MRIAnatomicalReferenceFrame.Lateral_PF_EFC;
          };
          MeasureOrganizer = {0,1}; 
        };
#if TF_MOVING_AXIS_KNEE == 1                 
        AnyKinMeasure &KneeFlexion = ..Inv_TF;
#else
        AnyKinMeasure &KneeFlexion = ..InvisibleFemurMedialEFCDriver_PF.LinComb.KneeFlexion;
#endif        OutDim = 2;  
      };
    };
    
    AnyKinEq InvisibleFemurZRot_PF = { 
      AnyKinMeasureOrg org = {
        AnyKinRotational rot = {
          Type = RotAxesAngles;
          Axis1 = z;
          Axis2 = x;
          Axis3 = y;
          AnyRefFrame &ref1 = ....Seg.Thigh.MRIAnatomicalReferenceFrame.InvisiblePatellaRotationNode;
          AnyRefFrame &ref2 = ....Seg.InvisibleFemur_PF;          
        };
        MeasureOrganizer = {0};
      };
    };
    //----------------------------------------------------------------       
    // Drivers for the movement of the invisible patella axis
    //----------------------------------------------------------------       

    AnyKinEq InvisiblePatellaMedialEFCDriver = {
      AnyKinMeasureLinComb LinComb = {
        Coef = {{1.0,0.0,0.0,1.0/(pi/2.0)*(...Seg.Patella.MRIAnatomicalReferenceFrame.Medial_PF_FFC.sRel[0]-...Seg.Patella.MRIAnatomicalReferenceFrame.Medial_PF_EFC.sRel[0])},{0.0,1.0,0.0,1.0/(pi/2.0)*(...Seg.Patella.MRIAnatomicalReferenceFrame.Medial_PF_FFC.sRel[1]-...Seg.Patella.MRIAnatomicalReferenceFrame.Medial_PF_EFC.sRel[1])},{0.0,0.0,1.0,1.0/(pi/2.0)*(...Seg.Patella.MRIAnatomicalReferenceFrame.Medial_PF_FFC.sRel[2]-...Seg.Patella.MRIAnatomicalReferenceFrame.Medial_PF_EFC.sRel[2])}};
        Const ={0.0,0.0,0.0};
        AnyKinLinear PatellaTrans = {
          Ref = 0;
          AnyRefFrame &ref1 = ....Seg.Patella.MRIAnatomicalReferenceFrame.Medial_PF_EFC;
          AnyRefFrame &ref2 = ....Seg.InvisiblePatella.MRIAnatomicalReferenceFrame.Medial_PF_EFC;
        };
 #if TF_MOVING_AXIS_KNEE == 1                 
        AnyKinMeasure &KneeFlexion = ..Inv_TF;
#else
        AnyKinMeasure &KneeFlexion = ..InvisibleFemurMedialEFCDriver_PF.LinComb.KneeFlexion;
#endif       OutDim = 3;  
      };
    };
    
    AnyKinEq InvisiblePatellaLateralEFCDriver = {
      AnyKinMeasureLinComb LinComb = {
        Coef = {{1.0,0.0,1.0/(pi/2.0)*(...Seg.Patella.MRIAnatomicalReferenceFrame.Lateral_PF_FFC.sRel[0]-...Seg.Patella.MRIAnatomicalReferenceFrame.Lateral_PF_EFC.sRel[0])},{0.0,1.0,1.0/(pi/2.0)*(...Seg.Patella.MRIAnatomicalReferenceFrame.Lateral_PF_FFC.sRel[1]-...Seg.Patella.MRIAnatomicalReferenceFrame.Lateral_PF_EFC.sRel[1])}};
        Const ={0.0,0.0};
        AnyKinMeasureOrg org = {
          AnyKinLinear PatellaTrans = {
            Ref = 0; 
            AnyRefFrame &ref1 = .....Seg.Patella.MRIAnatomicalReferenceFrame.Lateral_PF_EFC;
            AnyRefFrame &ref2 = .....Seg.InvisiblePatella.MRIAnatomicalReferenceFrame.Lateral_PF_EFC;
          };
          MeasureOrganizer = {0,1};
        };
#if TF_MOVING_AXIS_KNEE == 1                 
        AnyKinMeasure &KneeFlexion = ..Inv_TF;
#else
        AnyKinMeasure &KneeFlexion = ..InvisibleFemurMedialEFCDriver_PF.LinComb.KneeFlexion;
#endif        OutDim = 2;  
      };
    };
    
    AnyKinEq InvisiblePatellaZRot = {
      AnyKinMeasureOrg org = {
        AnyKinRotational rot = {
          Type = RotAxesAngles;
          Axis1 = z;
          Axis2 = x;
          Axis3 = y;
          AnyRefFrame &ref1 = ....Seg.Patella.MRIAnatomicalReferenceFrame.InvisiblePatellaRotationNode;
          AnyRefFrame &ref2 = ....Seg.InvisiblePatella;          
        };
        MeasureOrganizer = {0};
      };
    };
    #endif   
  };
};



