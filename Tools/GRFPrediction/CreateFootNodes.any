#ifdef  __CREATE_CC_NODE__
#undef __CREATE_CC_NODE__
#endif

#define __CREATE_CC_NODE__(REF,IDX,NAME) AnyRefNode &Node##IDX = foot_ref.REF.Node##IDX##NAME; \
                                        foot_ref.REF = {\
                                          AnyRefNode Node##IDX##NAME = {sRel = ...Targets[IDX]*...NewCoordSys_ARel' +...NewCoordSys_sRel; ARel = ...NewCoordSys_ARel;  \
                                            AnyDrawNode Drw = { Visible= ....NodesVisible; RGB = ....NodesRGB; ScaleXYZ= ....NodesScale; Opacity = ....NodesOpacity; }; };\
                                        };\
                                        foot_ref.ConditionalContact_Nodes##NAME = {AnyRefNode &Node##IDX = .REF.Node##IDX##NAME;};




#class_template CreateFootContactNodes25 (AnyFolder &foot_ref, 
                                        NAME = "",
                                        CONTACT_POINT_OFFSET_DIST = 0)
{
    #var AnySwitchVar NodesVisible = On;
    #var AnyInt NodesRGB = {1, 0, 1};
    #var AnyVec3 NodesScale =  0.005*{1, 1, 1};
    #var AnyVar NodesOpacity = 1;
  
    AnyVec3 NewCoordSys_sRel = foot_ref.Calcaneus.HeelContactNodeLow.sRel;
    AnyMat33 NewCoordSys_ARel = RotMat(foot_ref.Calcaneus.HeelContactNodeLow.sRel,
                                       foot_ref.ProximalPhalange1.ToeMedialContactNode.sRel,
                                       foot_ref.ProximalPhalange5.ToeLateralContactNode.sRel)
                                * RotMat(-pi/2*foot_ref.Sign, x);
    AnyMat33 ProjectionMat = {{1, 0, 0}, {0, 0, 0}, {0, 0, 1}}; // Projection to XZ plane!
    AnyVar Offset_Dist = CONTACT_POINT_OFFSET_DIST;
    AnyVec3 Offset_Vec = {0, -1, 0};
  
    AnyFloat Sources = 
    {
      foot_ref.Calcaneus.HeelContactNodeLow.sRel, 
      foot_ref.ProximalPhalange1.ToeMedialContactNode.sRel, 
      foot_ref.ProximalPhalange5.ToeLateralContactNode.sRel, 
      foot_ref.DistalPhalange1.BigToeNode.sRel,
      foot_ref.Talus.MedialMalleolus.sRel, 
      foot_ref.Talus.LateralMalleolus.sRel,
      foot_ref.Talus.SubTalarJoint.sRel, 
      foot_ref.Metatarsal1.MetatarsalJoint1Node.sRel, 
      foot_ref.Metatarsal2.MetatarsalJoint2Node.sRel, 
      foot_ref.Metatarsal3.MetatarsalJoint3Node.sRel, 
      foot_ref.Metatarsal4.MetatarsalJoint4Node.sRel, 
      foot_ref.Metatarsal5.MetatarsalJoint5Node.sRel, 
      foot_ref.Scale((5*foot_ref.ProximalPhalange1.Data.ToeMedialContactNode+5*foot_ref.DistalPhalange1.Data.BigToeNode)/10), 
      foot_ref.Scale((5*foot_ref.ProximalPhalange5.Data.ToeLateralContactNode+5*foot_ref.DistalPhalange1.Data.BigToeNode)/10),
      foot_ref.Scale((5*foot_ref.Calcaneus.Data.HeelContactNodeLow+5*foot_ref.ProximalPhalange1.Data.ToeMedialContactNode)/10), 
      foot_ref.Scale((2.5*foot_ref.Calcaneus.Data.HeelContactNodeLow+7.5*foot_ref.ProximalPhalange1.Data.ToeMedialContactNode)/10), 
      foot_ref.Scale((5*foot_ref.Calcaneus.Data.HeelContactNodeLow+5*foot_ref.ProximalPhalange5.Data.ToeLateralContactNode)/10), 
      foot_ref.Scale((2.5*foot_ref.Calcaneus.Data.HeelContactNodeLow+7.5*foot_ref.ProximalPhalange5.Data.ToeLateralContactNode)/10), 
      foot_ref.Scale((7.5*foot_ref.Calcaneus.Data.HeelContactNodeLow+2.5*foot_ref.ProximalPhalange5.Data.ToeLateralContactNode)/10), 
      foot_ref.Scale((8.5*foot_ref.Calcaneus.Data.HeelContactNodeLow+1.5*foot_ref.ProximalPhalange5.Data.ToeLateralContactNode)/10), 
      foot_ref.Scale((-1.5*foot_ref.Calcaneus.Data.HeelContactNodeLow+11.5*foot_ref.ProximalPhalange5.Data.ToeLateralContactNode)/10), 
      foot_ref.Scale((4*foot_ref.Calcaneus.Data.HeelContactNodeLow+6*foot_ref.DistalPhalange1.Data.BigToeNode)/10),
      foot_ref.Calcaneus.FlexorHallucisLongusViaNode7.sRel, 
      foot_ref.Calcaneus.FlexorDigitorumLongusViaNode7.sRel, 
      foot_ref.DistalPhalange2.ExtensorDigitorumLongus1Node.sRel    
    };
    AnyInt Sources_Sizes = SizesOf(Sources);
    AnyFloat Unit_Array = iarr(1, Sources_Sizes[0])*0 + 1 ;

    AnyFloat Targets = 
    ( Sources - (NewCoordSys_sRel'*{Unit_Array})')* NewCoordSys_ARel * ProjectionMat 
    + (Offset_Dist*Offset_Vec'*{Unit_Array})';
  
    foot_ref = {
      AnyFolder ConditionalContact_Nodes##NAME = {};
    };

    __CREATE_CC_NODE__(Calcaneus         ,0,NAME)
    __CREATE_CC_NODE__(ProximalPhalange1 ,1,NAME)
    __CREATE_CC_NODE__(ProximalPhalange5 ,2,NAME)
    __CREATE_CC_NODE__(DistalPhalange1   ,3,NAME)
    __CREATE_CC_NODE__(Calcaneus         ,4,NAME)
    __CREATE_CC_NODE__(Calcaneus         ,5,NAME)
    __CREATE_CC_NODE__(Calcaneus         ,6,NAME)
    __CREATE_CC_NODE__(Metatarsal1       ,7,NAME)
    __CREATE_CC_NODE__(Metatarsal2       ,8,NAME)
    __CREATE_CC_NODE__(Metatarsal3       ,9,NAME)
    __CREATE_CC_NODE__(Metatarsal4       ,10,NAME)
    __CREATE_CC_NODE__(Metatarsal5       ,11,NAME)
    __CREATE_CC_NODE__(DistalPhalange1   ,12,NAME)
    __CREATE_CC_NODE__(MiddlePhalange3   ,13,NAME)
    __CREATE_CC_NODE__(Metatarsal1       ,14,NAME)
    __CREATE_CC_NODE__(Metatarsal1       ,15,NAME)
    __CREATE_CC_NODE__(Metatarsal5       ,16,NAME)
    __CREATE_CC_NODE__(Metatarsal5       ,17,NAME)
    __CREATE_CC_NODE__(Calcaneus         ,18,NAME)
    __CREATE_CC_NODE__(Calcaneus         ,19,NAME)
    __CREATE_CC_NODE__(DistalPhalange5   ,20,NAME)
    __CREATE_CC_NODE__(Metatarsal3       ,21,NAME)
    __CREATE_CC_NODE__(Calcaneus         ,22,NAME)
    __CREATE_CC_NODE__(Calcaneus         ,23,NAME)
    __CREATE_CC_NODE__(DistalPhalange1   ,24,NAME)
    
};