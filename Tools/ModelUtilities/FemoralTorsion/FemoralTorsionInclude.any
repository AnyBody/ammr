
#define CUSTOM_SCALING_Right_Thigh
#define CUSTOM_SCALING_Left_Thigh

// This forces the script to the default scaling instead of 
// manually constructing a length mass fat ScaleMat matrix
// This should ensure that the script will work no matter what
// linear scaling law is used. 
#define USE_DEFAULT_SCALING 1

Main = 
{
  #define RIGHT_SEGMENT  Main.HumanModel.BodyModel.Right.Leg.Seg.Thigh
  
  
  Main.HumanModel.Scaling.GeometricalScaling.Right.Thigh = {
    
    #if USE_DEFAULT_SCALING
    AnyFunction& ScaleDefault = Main.HumanModel.ScalingDefault.GeometricalScaling.Right.Thigh.ScaleFunction;
    #else
    AnyFolder& DefaultScaling = Main.HumanModel.ScalingDefault.GeometricalScaling.Right.Thigh;
    AnyVar LengthStandard= Main.HumanModel.ScalingDefault.StandardParameters.Right.Thigh.Length;
    AnyVar LengthScale  = DefaultScaling.LengthScale;
    AnyVar ms = DefaultScaling.ms;
    AnyVar ls = DefaultScaling.ls;
    #endif
    
    AnyVar BoxSizeHip=0.05;
    AnyVar BoxSizeKnee=0.05;
    AnyVar Sign = 1;
    
    AnyFolder& ScalingFrame = RIGHT_SEGMENT.AnatomicalFrame;
    
    // Unscaled hip and knee joints define the coordinate system of the unscaled hip joint. 
    AnyVec3 HipJointStandard = (RIGHT_SEGMENT.HipJoint.sRelUnscaled-ScalingFrame.sRelUnscaled)*ScalingFrame.ARelUnscaled ;
    AnyVec3 KneeJointStandard = (RIGHT_SEGMENT.KneeJoint.sRelUnscaled-ScalingFrame.sRelUnscaled)*ScalingFrame.ARelUnscaled ;
    
    
    AnyFolder SourcePoints = 
    {
      AnyVec3 HipCenter = .HipJointStandard;
      AnyVec3 KneePoint = .KneeJointStandard;
      AnyVec3 CPoint1 = HipCenter + .BoxSizeHip*{1, 1, .Sign*1};
      AnyVec3 CPoint2 = HipCenter + .BoxSizeHip*{1, 1, .Sign*-1};
      AnyVec3 CPoint3 = HipCenter + .BoxSizeHip*{-1, 1, .Sign*-1};
      AnyVec3 CPoint4 = HipCenter + .BoxSizeHip*{-1, 1, .Sign*1};
      AnyVec3 CPoint5 = HipCenter + .BoxSizeHip*{1, -1, .Sign*1};
      AnyVec3 CPoint6 = HipCenter + .BoxSizeHip*{1, -1, .Sign*-1};
      AnyVec3 CPoint7 = HipCenter + .BoxSizeHip*{-1, -1, .Sign*-1};
      AnyVec3 CPoint8 = HipCenter + .BoxSizeHip*{-1, -1, .Sign*1};
      
      AnyVec3 CPoint9 = KneePoint + .BoxSizeKnee*{1, -1, .Sign*1};
      AnyVec3 CPoint10 = KneePoint + .BoxSizeKnee*{1, -1, .Sign*-1};
      AnyVec3 CPoint11 = KneePoint + .BoxSizeKnee*{-1, -1, .Sign*-1};
      AnyVec3 CPoint12 = KneePoint + .BoxSizeKnee*{-1, -1, .Sign*1};
      AnyVec3 CPoint13 = KneePoint + .BoxSizeKnee*{1, 1, .Sign*1};
      AnyVec3 CPoint14 = KneePoint + .BoxSizeKnee*{1, 1, .Sign*-1};
      AnyVec3 CPoint15 = KneePoint + .BoxSizeKnee*{-1, 1, .Sign*-1};
      AnyVec3 CPoint16 = KneePoint + .BoxSizeKnee*{-1, 1, .Sign*1};
      
//      AnyVec3 CPoint17 = .HipJointStandard + {0, -1/2*.LengthStandard, 0} + .BoxSizeHip*{1, 0, .Sign*1};
//      AnyVec3 CPoint18 = .HipJointStandard + {0, -1/2*.LengthStandard, 0} + .BoxSizeHip*{1, 0, .Sign*-1};
//      AnyVec3 CPoint19 = .HipJointStandard + {0, -1/2*.LengthStandard, 0} + .BoxSizeHip*{-1, 0, .Sign*-1};
//      AnyVec3 CPoint20 = .HipJointStandard + {0, -1/2*.LengthStandard, 0} + .BoxSizeHip*{-1, 0, .Sign*.1};
      
    };
    
    
//RIGHT LEG    
    AnyFolder TargetPoints = 
    { 
      
      AnyMat33 FemurTorsion = RotMat((-(Main.HumanModel.Anthropometrics.FemoralTorsionRight-5)*pi/180),y);
      
      
      #if USE_DEFAULT_SCALING
      AnyVec3 HipCenter = .ScaleDefault(.HipJointStandard);
      AnyVec3 KneePoint = .ScaleDefault(.KneeJointStandard);    
      
      AnyVec3 CPoint1 = HipCenter +.ScaleDefault(.BoxSizeHip*{1, 1, .Sign*1})*FemurTorsion';
      AnyVec3 CPoint2 = HipCenter +.ScaleDefault(.BoxSizeHip*{1, 1, .Sign*-1})*FemurTorsion';
      AnyVec3 CPoint3 = HipCenter +.ScaleDefault(.BoxSizeHip*{-1, 1, .Sign*-1})*FemurTorsion';
      AnyVec3 CPoint4 = HipCenter +.ScaleDefault(.BoxSizeHip*{-1, 1, .Sign*1})*FemurTorsion';
      AnyVec3 CPoint5 = HipCenter +.ScaleDefault(.BoxSizeHip*{1, -1, .Sign*1})*FemurTorsion';
      AnyVec3 CPoint6 = HipCenter +.ScaleDefault(.BoxSizeHip*{1, -1, .Sign*-1})*FemurTorsion';
      AnyVec3 CPoint7 = HipCenter +.ScaleDefault(.BoxSizeHip*{-1, -1, .Sign*-1})*FemurTorsion';
      AnyVec3 CPoint8 = HipCenter +.ScaleDefault(.BoxSizeHip*{-1, -1, .Sign*1})*FemurTorsion';
      
      AnyVec3 CPoint9 = KneePoint+.ScaleDefault(.BoxSizeKnee*{1, -1, .Sign*1});
      AnyVec3 CPoint10 = KneePoint+ .ScaleDefault(.BoxSizeKnee*{1, -1, .Sign*-1});
      AnyVec3 CPoint11 = KneePoint+.ScaleDefault(.BoxSizeKnee*{-1, -1, .Sign*-1});
      AnyVec3 CPoint12 = KneePoint+.ScaleDefault(.BoxSizeKnee*{-1, -1, .Sign*1});
      AnyVec3 CPoint13 = KneePoint+.ScaleDefault(.BoxSizeKnee*{1, 1, .Sign*1});
      AnyVec3 CPoint14 = KneePoint+.ScaleDefault(.BoxSizeKnee*{1, 1, .Sign*-1});
      AnyVec3 CPoint15 = KneePoint+.ScaleDefault(.BoxSizeKnee*{-1, 1, .Sign*-1});
      AnyVec3 CPoint16 = KneePoint+.ScaleDefault(.BoxSizeKnee*{-1, 1, .Sign*1});      
      
      
      #else
      AnyMat33 ScaleMat =  {{(.ms/.ls)^0.5,0,0},{0, .ls, 0},{0, 0, (.ms/.ls)^0.5 }};              

      AnyVec3 HipCenter = (ScaleMat*.HipJointStandard')';
      AnyVec3 KneePoint = (ScaleMat* .KneeJointStandard')';     
      
      AnyVec3 CPoint1 = HipCenter +(ScaleMat*(.BoxSizeHip*{1, 1, .Sign*1})')'*FemurTorsion';
      AnyVec3 CPoint2 = HipCenter +(ScaleMat*(.BoxSizeHip*{1, 1, .Sign*-1})')'*FemurTorsion';
      AnyVec3 CPoint3 = HipCenter +(ScaleMat*(.BoxSizeHip*{-1, 1, .Sign*-1})')'*FemurTorsion';
      AnyVec3 CPoint4 = HipCenter +(ScaleMat*(.BoxSizeHip*{-1, 1, .Sign*1})')'*FemurTorsion';
      AnyVec3 CPoint5 = HipCenter +(ScaleMat*(.BoxSizeHip*{1, -1, .Sign*1})')'*FemurTorsion';
      AnyVec3 CPoint6 = HipCenter +(ScaleMat*(.BoxSizeHip*{1, -1, .Sign*-1})')'*FemurTorsion';
      AnyVec3 CPoint7 = HipCenter +(ScaleMat*(.BoxSizeHip*{-1, -1, .Sign*-1})')'*FemurTorsion';
      AnyVec3 CPoint8 = HipCenter +(ScaleMat*(.BoxSizeHip*{-1, -1, .Sign*1})')'*FemurTorsion';
      
      AnyVec3 CPoint9 = KneePoint+(ScaleMat*(.BoxSizeKnee*{1, -1, .Sign*1})')';
      AnyVec3 CPoint10 = KneePoint+ (ScaleMat*(.BoxSizeKnee*{1, -1, .Sign*-1})')';
      AnyVec3 CPoint11 = KneePoint+(ScaleMat*(.BoxSizeKnee*{-1, -1, .Sign*-1})')';
      AnyVec3 CPoint12 = KneePoint+(ScaleMat*(.BoxSizeKnee*{-1, -1, .Sign*1})')';
      AnyVec3 CPoint13 = KneePoint+(ScaleMat*(.BoxSizeKnee*{1, 1, .Sign*1})')';
      AnyVec3 CPoint14 = KneePoint+(ScaleMat*(.BoxSizeKnee*{1, 1, .Sign*-1})')';
      AnyVec3 CPoint15 = KneePoint+(ScaleMat*(.BoxSizeKnee*{-1, 1, .Sign*-1})')';
      AnyVec3 CPoint16 = KneePoint+(ScaleMat*(.BoxSizeKnee*{-1, 1, .Sign*1})')';
      
      
      #endif
//      AnyVec3 CPoint17 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{1, 0, .Sign*1}*ScaleMat'*FemurTorsion';
//      AnyVec3 CPoint18 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{1, 0, .Sign*-1}*ScaleMat'*FemurTorsion';
//      AnyVec3 CPoint19 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{-1, 0, .Sign*-1}*ScaleMat*'*FemurTorsion';
//      AnyVec3 CPoint20 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{-1, 0, .Sign*1}*ScaleMat*'*FemurTorsion';
    };
    
    
    

        AnyFunTransform3DRBF ScaleFunction= 
        {
          //RBFDef.Param = 0.3;
          PolynomDegree = 1;
          RBFDef.Type = RBF_Triharmonic;          
          Points0 ={    
            .SourcePoints.HipCenter, // Hip joint center
            .SourcePoints.CPoint1,
            .SourcePoints.CPoint2,
            .SourcePoints.CPoint3,
            .SourcePoints.CPoint4,
            .SourcePoints.CPoint5,
            .SourcePoints.CPoint6,
            .SourcePoints.CPoint7,
            .SourcePoints.CPoint8,
            .SourcePoints.CPoint9,
            .SourcePoints.CPoint10,
            .SourcePoints.CPoint11,
            .SourcePoints.CPoint12,
            .SourcePoints.CPoint13,
            .SourcePoints.CPoint14,
            .SourcePoints.CPoint15,
            .SourcePoints.CPoint16,
//            .SourcePoints.CPoint17,
//            .SourcePoints.CPoint18,
//            .SourcePoints.CPoint19,
//            .SourcePoints.CPoint20,
            .SourcePoints.KneePoint
          };
          Points1 = { 
            .TargetPoints.HipCenter, // Hip joint center
            .TargetPoints.CPoint1,
            .TargetPoints.CPoint2,
            .TargetPoints.CPoint3,
            .TargetPoints.CPoint4,
            .TargetPoints.CPoint5,
            .TargetPoints.CPoint6,
            .TargetPoints.CPoint7,
            .TargetPoints.CPoint8,
            .TargetPoints.CPoint9,
            .TargetPoints.CPoint10,
            .TargetPoints.CPoint11,
            .TargetPoints.CPoint12,
            .TargetPoints.CPoint13,
            .TargetPoints.CPoint14,
            .TargetPoints.CPoint15,
            .TargetPoints.CPoint16,
//            .TargetPoints.CPoint17,
//            .TargetPoints.CPoint18,
//            .TargetPoints.CPoint19,
//            .TargetPoints.CPoint20,
            .TargetPoints.KneePoint
           };              
        };
        
    
  RIGHT_SEGMENT = {
    AnyRefNode MorphNodesVisualize = {
      AnyMatrix Points0 = .GeomScale.Points0;
      AnyMatrix Points0InSeg =.Scale.T0_Inv(Points0);
      AnyMatrix Points0InSegScaled =.Scale(Points0InSeg);
      
      AnyDrawPointCloud SourcePoints ={
        PointStyle.Style = PointStyleSphere;
        Points3D = On;
        ShowNames = Off;
        RGB= {0.01796875, 0.76953125, 0.06640625};
        Points=.Points0InSeg;
        PointStyle.Size=0.015;
        Opacity = 0.2;
        Visible = Off;

        PointNames={
          "SourcePoints.HipPoint", 
          "SourcePoints.CPoint1",
          "SourcePoints.CPoint2",
          "SourcePoints.CPoint3",
          "SourcePoints.CPoint4",
          "SourcePoints.CPoint5",
          "SourcePoints.CPoint6",
          "SourcePoints.CPoint7",
          "SourcePoints.CPoint8",
          "SourcePoints.CPoint9",
          "SourcePoints.CPoint10",
          "SourcePoints.CPoint11",
          "SourcePoints.CPoint12",
          "SourcePoints.CPoint13",
          "SourcePoints.CPoint14",
          "SourcePoints.CPoint15",
          "SourcePoints.CPoint16",
          "SourcePoints.CPoint17",
          "SourcePoints.CPoint18",
          "SourcePoints.CPoint19",
          "SourcePoints.CPoint20",
          "SourcePoints.KneePoint"          
        };
      };
      
      AnyDrawPointCloud TargetPoints ={
        PointStyle.Style = PointStyleSphere;
        Points3D = On;
        ShowNames = Off;
        RGB= {0.01796875, 0.76953125, 0.06640625};
        PointStyle.Size=0.015;
        Visible = Off;

        Points=.Points0InSegScaled ;
        PointNames={
          "TargetPoints.HipPoint", 
          "TargetPoints.CPoint1",
          "TargetPoints.CPoint2",
          "TargetPoints.CPoint3",
          "TargetPoints.CPoint4",
          "TargetPoints.CPoint5",
          "TargetPoints.CPoint6",
          "TargetPoints.CPoint7",
          "TargetPoints.CPoint8",
          "TargetPoints.CPoint9",
          "TargetPoints.CPoint10",
          "TargetPoints.CPoint11",
          "TargetPoints.CPoint12",
          "TargetPoints.CPoint13",
          "TargetPoints.CPoint14",
          "TargetPoints.CPoint15",
          "TargetPoints.CPoint16",
          "TargetPoints.CPoint17",
          "TargetPoints.CPoint18",
          "TargetPoints.CPoint19",
          "TargetPoints.CPoint20",
          "TargetPoints.KneePoint"
        };
      };
      
      
    };
          
  };
    
    
  };
  
  
  
#define LEFT_SEGMENT  Main.HumanModel.BodyModel.Left.Leg.Seg.Thigh
  
  
  Main.HumanModel.Scaling.GeometricalScaling.Left.Thigh = {
    
    
    #if USE_DEFAULT_SCALING
    AnyFunction& ScaleDefault = Main.HumanModel.ScalingDefault.GeometricalScaling.Left.Thigh.ScaleFunction;
    #else
    AnyFolder& DefaultScaling = Main.HumanModel.ScalingDefault.GeometricalScaling.Left.Thigh;
    AnyVar LengthStandard= Main.HumanModel.ScalingDefault.StandardParameters.Left.Thigh.Length;
    AnyVar LengthScale  = DefaultScaling.LengthScale;
    AnyVar ms = DefaultScaling.ms;
    AnyVar ls = DefaultScaling.ls;
    #endif
    
    AnyVar BoxSizeHip=0.05;
    AnyVar BoxSizeKnee=0.05;
    AnyVar Sign = 1;
    
    AnyFolder& ScalingFrame = LEFT_SEGMENT.AnatomicalFrame;
    
    // Unscaled hip and knee joints define the coordinate system of the unscaled hip joint. 
    AnyVec3 HipJointStandard = (LEFT_SEGMENT.HipJoint.sRelUnscaled-ScalingFrame.sRelUnscaled)*ScalingFrame.ARelUnscaled ;
    AnyVec3 KneeJointStandard = (LEFT_SEGMENT.KneeJoint.sRelUnscaled-ScalingFrame.sRelUnscaled)*ScalingFrame.ARelUnscaled ;
    
    
    AnyFolder SourcePoints = 
    {
      AnyVec3 HipCenter = .HipJointStandard;
      AnyVec3 KneePoint = .KneeJointStandard;
      AnyVec3 CPoint1 = HipCenter + .BoxSizeHip*{1, 1, .Sign*1};
      AnyVec3 CPoint2 = HipCenter + .BoxSizeHip*{1, 1, .Sign*-1};
      AnyVec3 CPoint3 = HipCenter + .BoxSizeHip*{-1, 1, .Sign*-1};
      AnyVec3 CPoint4 = HipCenter + .BoxSizeHip*{-1, 1, .Sign*1};
      AnyVec3 CPoint5 = HipCenter + .BoxSizeHip*{1, -1, .Sign*1};
      AnyVec3 CPoint6 = HipCenter + .BoxSizeHip*{1, -1, .Sign*-1};
      AnyVec3 CPoint7 = HipCenter + .BoxSizeHip*{-1, -1, .Sign*-1};
      AnyVec3 CPoint8 = HipCenter + .BoxSizeHip*{-1, -1, .Sign*1};
      
      AnyVec3 CPoint9 = KneePoint + .BoxSizeKnee*{1, -1, .Sign*1};
      AnyVec3 CPoint10 = KneePoint + .BoxSizeKnee*{1, -1, .Sign*-1};
      AnyVec3 CPoint11 = KneePoint + .BoxSizeKnee*{-1, -1, .Sign*-1};
      AnyVec3 CPoint12 = KneePoint + .BoxSizeKnee*{-1, -1, .Sign*1};
      AnyVec3 CPoint13 = KneePoint + .BoxSizeKnee*{1, 1, .Sign*1};
      AnyVec3 CPoint14 = KneePoint + .BoxSizeKnee*{1, 1, .Sign*-1};
      AnyVec3 CPoint15 = KneePoint + .BoxSizeKnee*{-1, 1, .Sign*-1};
      AnyVec3 CPoint16 = KneePoint + .BoxSizeKnee*{-1, 1, .Sign*1};
      
//      AnyVec3 CPoint17 = .HipJointStandard + {0, -1/2*.LengthStandard, 0} + .BoxSizeHip*{1, 0, .Sign*1};
//      AnyVec3 CPoint18 = .HipJointStandard + {0, -1/2*.LengthStandard, 0} + .BoxSizeHip*{1, 0, .Sign*-1};
//      AnyVec3 CPoint19 = .HipJointStandard + {0, -1/2*.LengthStandard, 0} + .BoxSizeHip*{-1, 0, .Sign*-1};
//      AnyVec3 CPoint20 = .HipJointStandard + {0, -1/2*.LengthStandard, 0} + .BoxSizeHip*{-1, 0, .Sign*.1};
      
    };
    
    
//LEFT LEG    
    AnyFolder TargetPoints = 
    { 
      
      AnyMat33 FemurTorsion = RotMat(((Main.HumanModel.Anthropometrics.FemoralTorsionLeft-5)*pi/180),y);
      
      #if USE_DEFAULT_SCALING
      
      AnyVec3 HipCenter = .ScaleDefault(.HipJointStandard);
      AnyVec3 KneePoint = .ScaleDefault(.KneeJointStandard);
      
      AnyVec3 CPoint1 = HipCenter +.ScaleDefault(.BoxSizeHip*{1, 1, .Sign*1})*FemurTorsion';
      AnyVec3 CPoint2 = HipCenter +.ScaleDefault(.BoxSizeHip*{1, 1, .Sign*-1})*FemurTorsion';
      AnyVec3 CPoint3 = HipCenter +.ScaleDefault(.BoxSizeHip*{-1, 1, .Sign*-1})*FemurTorsion';
      AnyVec3 CPoint4 = HipCenter +.ScaleDefault(.BoxSizeHip*{-1, 1, .Sign*1})*FemurTorsion';
      AnyVec3 CPoint5 = HipCenter +.ScaleDefault(.BoxSizeHip*{1, -1, .Sign*1})*FemurTorsion';
      AnyVec3 CPoint6 = HipCenter +.ScaleDefault(.BoxSizeHip*{1, -1, .Sign*-1})*FemurTorsion';
      AnyVec3 CPoint7 = HipCenter +.ScaleDefault(.BoxSizeHip*{-1, -1, .Sign*-1})*FemurTorsion';
      AnyVec3 CPoint8 = HipCenter +.ScaleDefault(.BoxSizeHip*{-1, -1, .Sign*1})*FemurTorsion';
      
      AnyVec3 CPoint9 = KneePoint+.ScaleDefault(.BoxSizeKnee*{1, -1, .Sign*1});
      AnyVec3 CPoint10 = KneePoint+ .ScaleDefault(.BoxSizeKnee*{1, -1, .Sign*-1});
      AnyVec3 CPoint11 = KneePoint+.ScaleDefault(.BoxSizeKnee*{-1, -1, .Sign*-1});
      AnyVec3 CPoint12 = KneePoint+.ScaleDefault(.BoxSizeKnee*{-1, -1, .Sign*1});
      AnyVec3 CPoint13 = KneePoint+.ScaleDefault(.BoxSizeKnee*{1, 1, .Sign*1});
      AnyVec3 CPoint14 = KneePoint+.ScaleDefault(.BoxSizeKnee*{1, 1, .Sign*-1});
      AnyVec3 CPoint15 = KneePoint+.ScaleDefault(.BoxSizeKnee*{-1, 1, .Sign*-1});
      AnyVec3 CPoint16 = KneePoint+.ScaleDefault(.BoxSizeKnee*{-1, 1, .Sign*1});
      
//      AnyVec3 CPoint17 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{1, 0, .Sign*1}*ScaleMat'*FemurTorsion';
//      AnyVec3 CPoint18 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{1, 0, .Sign*-1}*ScaleMat'*FemurTorsion';
//      AnyVec3 CPoint19 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{-1, 0, .Sign*-1}*ScaleMat*'*FemurTorsion';
//      AnyVec3 CPoint20 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{-1, 0, .Sign*1}*ScaleMat*'*FemurTorsion';

#else
      AnyMat33 ScaleMat =  {{(.ms/.ls)^0.5,0,0},{0, .ls, 0},{0, 0, (.ms/.ls)^0.5 }};              
      
      AnyVec3 HipCenter = (ScaleMat*.HipJointStandard')';
      AnyVec3 KneePoint = (ScaleMat* .KneeJointStandard')';
      
      AnyVec3 CPoint1 = HipCenter +(ScaleMat*(.BoxSizeHip*{1, 1, .Sign*1})')'*FemurTorsion';
      AnyVec3 CPoint2 = HipCenter +(ScaleMat*(.BoxSizeHip*{1, 1, .Sign*-1})')'*FemurTorsion';
      AnyVec3 CPoint3 = HipCenter +(ScaleMat*(.BoxSizeHip*{-1, 1, .Sign*-1})')'*FemurTorsion';
      AnyVec3 CPoint4 = HipCenter +(ScaleMat*(.BoxSizeHip*{-1, 1, .Sign*1})')'*FemurTorsion';
      AnyVec3 CPoint5 = HipCenter +(ScaleMat*(.BoxSizeHip*{1, -1, .Sign*1})')'*FemurTorsion';
      AnyVec3 CPoint6 = HipCenter +(ScaleMat*(.BoxSizeHip*{1, -1, .Sign*-1})')'*FemurTorsion';
      AnyVec3 CPoint7 = HipCenter +(ScaleMat*(.BoxSizeHip*{-1, -1, .Sign*-1})')'*FemurTorsion';
      AnyVec3 CPoint8 = HipCenter +(ScaleMat*(.BoxSizeHip*{-1, -1, .Sign*1})')'*FemurTorsion';
      
      AnyVec3 CPoint9 = KneePoint+(ScaleMat*(.BoxSizeKnee*{1, -1, .Sign*1})')';
      AnyVec3 CPoint10 = KneePoint+ (ScaleMat*(.BoxSizeKnee*{1, -1, .Sign*-1})')';
      AnyVec3 CPoint11 = KneePoint+(ScaleMat*(.BoxSizeKnee*{-1, -1, .Sign*-1})')';
      AnyVec3 CPoint12 = KneePoint+(ScaleMat*(.BoxSizeKnee*{-1, -1, .Sign*1})')';
      AnyVec3 CPoint13 = KneePoint+(ScaleMat*(.BoxSizeKnee*{1, 1, .Sign*1})')';
      AnyVec3 CPoint14 = KneePoint+(ScaleMat*(.BoxSizeKnee*{1, 1, .Sign*-1})')';
      AnyVec3 CPoint15 = KneePoint+(ScaleMat*(.BoxSizeKnee*{-1, 1, .Sign*-1})')';
      AnyVec3 CPoint16 = KneePoint+(ScaleMat*(.BoxSizeKnee*{-1, 1, .Sign*1})')';
      
//      AnyVec3 CPoint17 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{1, 0, .Sign*1}*ScaleMat'*FemurTorsion';
//      AnyVec3 CPoint18 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{1, 0, .Sign*-1}*ScaleMat'*FemurTorsion';
//      AnyVec3 CPoint19 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{-1, 0, .Sign*-1}*ScaleMat*'*FemurTorsion';
//      AnyVec3 CPoint20 = HipCenter + {0, -1/2*.LengthStandard, 0}*ScaleMat' + .BoxSizeHip*{-1, 0, .Sign*1}*ScaleMat*'*FemurTorsion';

#endif
    };
    
    
    

        AnyFunTransform3DRBF ScaleFunction= 
        {
          //RBFDef.Param = 0.3;
          PolynomDegree = 1;
          RBFDef.Type = RBF_Triharmonic;          
          Points0 ={    
            .SourcePoints.HipCenter, // Hip joint center
            .SourcePoints.CPoint1,
            .SourcePoints.CPoint2,
            .SourcePoints.CPoint3,
            .SourcePoints.CPoint4,
            .SourcePoints.CPoint5,
            .SourcePoints.CPoint6,
            .SourcePoints.CPoint7,
            .SourcePoints.CPoint8,
            .SourcePoints.CPoint9,
            .SourcePoints.CPoint10,
            .SourcePoints.CPoint11,
            .SourcePoints.CPoint12,
            .SourcePoints.CPoint13,
            .SourcePoints.CPoint14,
            .SourcePoints.CPoint15,
            .SourcePoints.CPoint16,
//            .SourcePoints.CPoint17,
//            .SourcePoints.CPoint18,
//            .SourcePoints.CPoint19,
//            .SourcePoints.CPoint20,
            .SourcePoints.KneePoint
          };
          Points1 = { 
            .TargetPoints.HipCenter, // Hip joint center
            .TargetPoints.CPoint1,
            .TargetPoints.CPoint2,
            .TargetPoints.CPoint3,
            .TargetPoints.CPoint4,
            .TargetPoints.CPoint5,
            .TargetPoints.CPoint6,
            .TargetPoints.CPoint7,
            .TargetPoints.CPoint8,
            .TargetPoints.CPoint9,
            .TargetPoints.CPoint10,
            .TargetPoints.CPoint11,
            .TargetPoints.CPoint12,
            .TargetPoints.CPoint13,
            .TargetPoints.CPoint14,
            .TargetPoints.CPoint15,
            .TargetPoints.CPoint16,
//            .TargetPoints.CPoint17,
//            .TargetPoints.CPoint18,
//            .TargetPoints.CPoint19,
//            .TargetPoints.CPoint20,
            .TargetPoints.KneePoint
           };              
        };
        
    
  LEFT_SEGMENT = {
    AnyRefNode MorphNodesVisualize = {
      AnyMatrix Points0 = .GeomScale.Points0;
      AnyMatrix Points0InSeg =.Scale.T0_Inv(Points0);
      AnyMatrix Points0InSegScaled =.Scale(Points0InSeg);
      
      AnyDrawPointCloud SourcePoints ={
        PointStyle.Style = PointStyleSphere;
        Points3D = On;
        ShowNames = Off;
        RGB= {0.01796875, 0.76953125, 0.06640625};
        Points=.Points0InSeg;
        PointStyle.Size=0.015;
        Opacity = 0.2;
        Visible = Off;

        PointNames={
          "SourcePoints.HipPoint", 
          "SourcePoints.CPoint1",
          "SourcePoints.CPoint2",
          "SourcePoints.CPoint3",
          "SourcePoints.CPoint4",
          "SourcePoints.CPoint5",
          "SourcePoints.CPoint6",
          "SourcePoints.CPoint7",
          "SourcePoints.CPoint8",
          "SourcePoints.CPoint9",
          "SourcePoints.CPoint10",
          "SourcePoints.CPoint11",
          "SourcePoints.CPoint12",
          "SourcePoints.CPoint13",
          "SourcePoints.CPoint14",
          "SourcePoints.CPoint15",
          "SourcePoints.CPoint16",
          "SourcePoints.CPoint17",
          "SourcePoints.CPoint18",
          "SourcePoints.CPoint19",
          "SourcePoints.CPoint20",
          "SourcePoints.KneePoint"          
        };
      };
      
      AnyDrawPointCloud TargetPoints ={
        PointStyle.Style = PointStyleSphere;
        Points3D = On;
        ShowNames = Off;
        RGB= {0.01796875, 0.76953125, 0.06640625};
        PointStyle.Size=0.015;
        Visible = Off;

        Points=.Points0InSegScaled ;
        PointNames={
          "TargetPoints.HipPoint", 
          "TargetPoints.CPoint1",
          "TargetPoints.CPoint2",
          "TargetPoints.CPoint3",
          "TargetPoints.CPoint4",
          "TargetPoints.CPoint5",
          "TargetPoints.CPoint6",
          "TargetPoints.CPoint7",
          "TargetPoints.CPoint8",
          "TargetPoints.CPoint9",
          "TargetPoints.CPoint10",
          "TargetPoints.CPoint11",
          "TargetPoints.CPoint12",
          "TargetPoints.CPoint13",
          "TargetPoints.CPoint14",
          "TargetPoints.CPoint15",
          "TargetPoints.CPoint16",
          "TargetPoints.CPoint17",
          "TargetPoints.CPoint18",
          "TargetPoints.CPoint19",
          "TargetPoints.CPoint20",
          "TargetPoints.KneePoint"
        };
      };
      
      
    };
          
  };
    
    
  };

  
  
  
  
  
  
  
  
  
}; 