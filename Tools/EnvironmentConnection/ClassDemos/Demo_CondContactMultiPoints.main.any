#include "libdef.any"
#include "<ANYBODY_PATH_AMMR>/Tools/EnvironmentConnection/IncludeConnectors.any"

/*
This model demonstrates a simple application of the class template
ConditionalContactMultiPoints.

The model consists of two segments. The first segment is grounded
to the global ref using AnyStdJnt that simulates

with conditional contact elements
simulating contact between the two segments. 

The model consists of 
two rotating forces acting in different planes to visualize the force
generated by the contact elements.
The conditional contact elements are implemented by a class template
and can be parametrized for the number and distribution of contact 
points.
*/
Main = {
  Template_DrawSettings DrawSettings = {};
  AnyFolder Model = {
    // -----------------------------------------------------
    // Basic Reference Frames
    // -----------------------------------------------------
    AnyFixedRefFrame GlobalRef = {
      AnyRefNode N1 = {
        sRel = {0.2,0.1,0};
      };
      AnyRefNode N2 = {
        sRel = {0.0,0.2,0};
      };
      AnyDrawRefFrame DrwGlobalRef = {ScaleXYZ = 0.3*{1,1,1};};    
    };
    
    // -----------------------------------------------------
    // Segments
    // -----------------------------------------------------   

      
      AnySeg Seg1 = {
        r0 = {0.2,0,0.0};
        Mass = 2.0;
        Jii = {0.005,0.01,0.01};
        AnyRefNode LoadNode = {sRel = {0.5,0.0,0};}; 
        AnyRefNode OriginNode = {};
        AnyDrawSeg DrwSeg= { RGB = {1,0,0};Opacity = 0.2;};
      }; // seg1

      AnySeg Seg2 = {
        r0 = {0.2,0.1,0.0};
        Mass = 10.0;
        Jii = {0.005,0.01,0.01};
        AnyRefNode LoadNode = {sRel = {0.5,0.0,0};};        
        AnyRefNode OriginNode = {};
        AnyDrawSeg DrwSeg= { RGB = {0,1,0};Opacity = 0.2;};
      }; // seg2         

      
    // -----------------------------------------------------
    // Joints
    // -----------------------------------------------------
    AnyFolder Joints = {
      AnyStdJoint JntS1 = {
        AnyRefNode &Ground = Main.Model.GlobalRef.N1;
        AnySeg &Seg = Main.Model.Seg1;
//        Constraints.Reaction.Type = repmat(6,Off);
        // Reaction forces between S1 and ground are enabled by default
      };
      AnyStdJoint JntS2 = {
        AnyRefFrame &Ground = Main.Model.GlobalRef.N1;
        AnySeg &Seg = Main.Model.Seg2;
        // Switch off reaction forces between S2 and ground
        Constraints.Reaction.Type = repmat(6,Off);
      };
    }; // Joints
    
    // -----------------------------------------------------
    // Force and Contact Model
    // -----------------------------------------------------
    AnyFolder Kinetics = {   
      // Rotating force on Seg2 in YZ plane for first half interval
//      AnyForce3D ForceYZPlane = {
//        AnyRefFrame &Seg2 = Main.Model.Seg2.LoadNode;
//        AnyFloat tEnd = Main.Study.tEnd;
//        F = iffun(ltfun(t,0.5*tEnd),300*{0,sin(2*t*2*pi),cos(2*t*2*pi)},{0.0,0.0,0.0});
//        AnyDrawForce drw = {};
//      };
//      // Rotating force on Seg2 in XZ plane for second half interval
//      AnyForce3D ForceXZPlane = {
//        AnyRefFrame &Seg2 = Main.Model.Seg2.LoadNode;
//        AnyFloat tEnd = Main.Study.tEnd;
//        F = iffun(gtfun(t,0.5*tEnd),300*{sin(2*t*2*pi),0,cos(2*t*2*pi)},{0.0,0.0,0.0});
//        AnyDrawForce drw = {};
//      };
      // Force on Seg2 to check resultant moment
//      AnyForce3D MomentCheck = {
//        AnyRefFrame &Seg2 = Main.Model.Seg2.LoadNode;
//        AnyFloat tEnd = Main.Study.tEnd;
//        F = {0,-200,0};
//        AnyDrawForce drw = {};
//      };
      
      // Contact model between Seg2 and Seg1
      ConditionalContactMultiPoints ContactS2S1(
      BASE_FRAME = Main.Model.Seg2.OriginNode,
      BASE_NODES_FOLDER = Main.Model.Seg2.OriginNode.NodeGroup,
      BASE_SEG = Main.Model.Seg2,
      NORMAL_DIRECTION = "Y",
      TARGET_NODES_FOLDER = Main.Model.Seg1.OriginNode.NodeGroup,
      NUMBER_OF_NODES = 24,
      SHOW_TRIGGER_VOLUME = 1
      ) =
      {
        Settings = { 
          Strength = 3000; 
          FrictionCoefficient = 0.5; 
          ElementForceDrawScaleFactor = 1;
        };
        EllipticCylinderPointsGrid BaseNodes (
        CENTER_FRAME = Main.Model.Seg2.OriginNode,
        AXIS = "X",
        LENGTH = 0.2,
        MAJ_AX = 0.12,
        MIN_AX = 0.12,
        nROWS = 3,
        nCOLS = 8) = {};
        
        EllipticCylinderPointsGrid TargetNodes (
        CENTER_FRAME = Main.Model.Seg1.OriginNode,
        AXIS = "X",
        LENGTH = 0.2,
        MAJ_AX = 0.12,
        MIN_AX = 0.12,
        nROWS = 3,
        nCOLS = 8) = {};
      };     
    }; // Kinetics
    
  }; // Model
  
  AnyBodyStudy Study = {
    AnyFolder& Model = Main.Model;
    Gravity = {0,-9.81,0};    
    nStep = 100;
  };
  
};
