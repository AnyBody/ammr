//fatal_warnings = True
//ignore_errors = [
//    "Muscle without strength  :  The muscle is unrealistically long or short",
//    "Close to singular position",
//    "Muscle calibration :  Insufficient Lmt interval",
//    "The tendon/fiber length was calibrated but with issues",
//    "'Set Value' operation on this value-object has broken symbolic dependency",
//    "Calibration operation has broken one or more symbolic dependencies",
//]
//define = (
//   [
//    {'BM_TRUNK_CAVITY_MODEL': '_CAVITY_MODEL_BUCKLE_'},
//    {'BM_TRUNK_CAVITY_MODEL': '_CAVITY_MODEL_VOLUME_'},
//  ],
//  [
//    {'BM_TRUNK_THORACIC_MODEL': '_THORACIC_MODEL_RIGID_'},
//    {'BM_TRUNK_THORACIC_MODEL': '_THORACIC_MODEL_FLEXIBLE_'},
//  ],
//  [
//    {'BM_CALIBRATION_TYPE':'1'},
//    {'BM_CALIBRATION_TYPE':'2'},
//    {'BM_CALIBRATION_TYPE':'3'},
//  ]
//)
//ignore_errors = ['Currently, no room for tendon']
//fatal_warnings = [
//    "Penetration of surface",
//]


#include "libdef.any"

#ifndef TEST_NAME
  #define BM_TRUNK_CAVITY_MODEL 1
  #define BM_TRUNK_THORACIC_MODEL 1
  #define BM_CALIBRATION_TYPE 2
  #define TEST_NAME "test_calibration_trunk.any_1"
#endif

#define BM_TRUNK_MUSCLES _MUSCLES_3E_HILL_
#define BM_TRUNK_CERVICAL_MUSCLES _MUSCLES_3E_HILL_
#define BM_LEG_RIGHT OFF
#define BM_LEG_LEFT OFF
#define BM_ARM_RIGHT OFF
#define BM_ARM_LEFT OFF


Main = 
{
  #include "<ANYBODY_PATH_BODY>/HumanModel.any"  

  AnyOperation& RunTest = Main.HumanModel.Calibration.CalibrationSequence;

  // Test to check that all muscles in the model are part of the calibration studies.
  // the test is excluded for the calibration combinations that do not make sense / are unimplemented
  // The pelvic floor muscles are excluded as they are not 3E muscles!
  #if BM_CALIBRATION_TYPE != 3
    AnyObjectPtrArray muscles_from_cal_studies = unique(flattenptr(ObjSearchRecursive(&Main.HumanModel.Calibration, "MuscleArr")));
    AnyObjectPtrArray muscles_from_model = set_difference(
      ObjSearchRecursive(&Main.HumanModel.BodyModel.Trunk.Muscles, "*", "AnyMuscle", 3), 
      ObjSearch(&Main.HumanModel.BodyModel.Trunk.Muscles, "*.Pubococcygeus.*"),
      ObjSearch(&Main.HumanModel.BodyModel.Trunk.Muscles, "*.Puborectalis.*")
    );
  
    AnyInt test_all_mus_in_cal = expect(
      eqfun(
      NumElemOf(muscles_from_cal_studies),
      NumElemOf(muscles_from_model)
      ),
      "The number of muscles in the calibration studies do not match the number of muscles in the model!"
    );
  #endif
};


