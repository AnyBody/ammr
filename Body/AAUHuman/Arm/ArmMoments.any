//This file contains a moment measures for the following joints in the arm:

//Elbowpronation
//ElbowFlexion
//Glenohumeral

//The measures named:
//  ElbowPronationNetMoment
//  ElbowFlexionNetMoment
//  GHNetMoment
//will measure the moments and forces supplied by the muscles spanning these and on top of these
//moments and force the forces and moments from the constraints in the joints will be added.
//The resulting force and moment are equal to the to total moment and force which
//could replace both the muscles spanning the joint and the joints reactions.

//The measures named:
//  ElbowPronationNetMomentMuscles
//  ElbowFlexionNetMomentMuscles
//  GHNetMomentMuscles
//will measure ONLY the moments and forces supplied by the muscles spanning these joint and not the moments and forces which from the constraints in the joints.
//The resulting force and moment are equal to the to total moment and force which
//are supplied by the muscles.

//In both cases the resulting force and moment is given in the global coordinate system.


AnyForceMomentMeasure2 GHNetMoment = {
  AnyRefNode &ref=..Segments.Scapula.gh.RotNode;

  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.Humerus","AnySeg"),
  ObjSearch("..Segments.Ulna","AnySeg"),
  ObjSearch("..Segments.Radius","AnySeg"),
  ObjSearch("..Segments.WristJointSeg","AnySeg"),
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;


  AnyObjectPtr  pArrReactions = arrcat(ObjSearchRecursive("..Joints", "*", "AnyForceBase"));
  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = arrcat(pArrMuscles,pArrReactions);

  //Make transformation to the Scapula.gh.RotNode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar GHAbduction=Mlocal[0];
  AnyVar GHFlexion=Mlocal[2];
  AnyVar GHExternalRotation=Mlocal[1];
};


AnyForceMomentMeasure2 ElbowFlexionNetMoment = {
  AnyRefNode &ref=..Segments.Humerus.HumeroUlnar; //fe.RotNode;

  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.Ulna","AnySeg"),
  ObjSearch("..Segments.Radius","AnySeg"),
  ObjSearch("..Segments.WristJointSeg","AnySeg"),
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;

  AnyObjectPtr  pArrReactions = arrcat(ObjSearchRecursive("..Joints", "*", "AnyForceBase"));
  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = arrcat(pArrMuscles,pArrReactions);

  //Make transformation to the Humerus.fe.rotnode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar ElbowFlexion=Mlocal[0];

};

AnyForceMomentMeasure2 ElbowPronationNetMoment = {
  AnyRefNode &ref =..Segments.Ulna.ProximalRadioUlnar; //ps2.RotNode;

  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.Radius","AnySeg"),
  ObjSearch("..Segments.WristJointSeg","AnySeg"),
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;

  AnyObjectPtr  pArrReactions = arrcat(ObjSearchRecursive("..Joints", "*", "AnyForceBase"));
  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = arrcat(pArrMuscles,pArrReactions);

  //Make transformation to the radius.ps2.rotnode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar ElbowPronation=Mlocal[0];

};




AnyForceMomentMeasure2 WristFlexionNetMoment = {
  //AnyRefNode &ref =..Segments.Radius.wj.RotNode;
  AnyRefNode &ref =..Segments.Radius.RadioCarpal.RotNode;

  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.WristJointSeg","AnySeg"),
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;



  AnyObjectPtr  pArrReactions = arrcat(ObjSearchRecursive("..Joints", "*", "AnyForceBase"));
  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = arrcat(pArrMuscles,pArrReactions);


  //Make transformation to the Radius.wj.rotnode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar WristFlexion=Mlocal[0];


};


AnyForceMomentMeasure2 WristAbductionNetMoment = {

#ifndef WRIST_EXPERIMENTAL
  AnyRefNode &ref =..Segments.WristJointSeg.RadioCarpalDeviation;
#endif
  #ifdef WRIST_EXPERIMENTAL
    AnyRefNode &ref =..Segments.Radius.RadioCarpal;
#endif

  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;


  AnyObjectPtr  pArrReactions = arrcat(ObjSearchRecursive("..Joints", "*", "AnyForceBase"));
  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = arrcat(pArrMuscles,pArrReactions);

  //Make transformation to the WristJointSeg.RadialUlnarDeviation.rotnode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar WristAbduction=Mlocal[2];

};





//The same measures as above without the joint reactions
//******************************************************
AnyForceMomentMeasure2 GHNetMomentMuscles = {
  AnyRefNode &ref=..Segments.Scapula.gh.RotNode;

  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.Humerus","AnySeg"),
  ObjSearch("..Segments.Ulna","AnySeg"),
  ObjSearch("..Segments.Radius","AnySeg"),
  ObjSearch("..Segments.WristJointSeg","AnySeg"),
   ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;



  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = pArrMuscles;


  //Make transformation to the Scapula.gh.RotNode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar GHAbduction=Mlocal[0];
  AnyVar GHFlexion=Mlocal[2];
  AnyVar GHExternalRotation=Mlocal[1];


};


AnyForceMomentMeasure2 ElbowFlexionNetMomentMuscles = {
  AnyRefNode &ref=..Segments.Humerus.HumeroUlnar;

  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.Ulna","AnySeg"),
  ObjSearch("..Segments.Radius","AnySeg"),
  ObjSearch("..Segments.WristJointSeg","AnySeg"),
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;

  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = pArrMuscles;

  //Make transformation to the Humerus.fe.rotnode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar ElbowFlexion=Mlocal[0];

};

AnyForceMomentMeasure2 ElbowPronationNetMomentMuscles = {
 AnyRefNode &ref=..Segments.Humerus.HumeroUlnar;
  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.Radius","AnySeg"),
  ObjSearch("..Segments.WristJointSeg","AnySeg"),
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;


  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = pArrMuscles;


  //Make transformation to the ..Segments.Humerus.HumeroUlnar  coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar ElbowPronation=Mlocal[0];

};

AnyForceMomentMeasure2 WristFlexionNetMomentMuscles = {

  AnyRefNode &ref =..Segments.Radius.RadioCarpal.RotNode;

  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.WristJointSeg","AnySeg"),
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;

  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = pArrMuscles;



  //Make transformation to the Radius.wj.rotnode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
    AnyVar WristFlexion=Mlocal[0];


};


AnyForceMomentMeasure2 WristAbductionNetMomentMuscles = {

    #ifndef WRIST_EXPERIMENTAL
  AnyRefNode &ref =..Segments.WristJointSeg.RadioCarpalDeviation;
#endif
  #ifdef WRIST_EXPERIMENTAL
    AnyRefNode &ref =..Segments.Radius.RadioCarpal;
#endif



  AnyObjectPtr  pArrSegments = arrcat(
  ObjSearch("..Segments.Hand", "AnySeg"),
  ObjSearchRecursive("..Segments.Hand","*", "AnySeg")
  );
  IncludeSegments =pArrSegments;

  AnyObjectPtr  pArrMuscles = arrcat(
  ObjSearchRecursive("..Muscles", "*", "AnyMuscle"),
  ObjSearchRecursive("..Joints.GHReactions", "*", "AnyMuscle"),
  ObjSearchRecursive("..JointMuscles","*", "AnyMuscle")
  );
  IncludeForces = pArrMuscles;


  //Make transformation to the WristJointSeg.RadialUlnarDeviation.rotnode coordinate system
  AnyVec3 Mlocal=M*ref.Axes;
  AnyVar WristAbduction=Mlocal[2];


};

AnyForceMomentMeasure ElbowJointReactionMoments = {
  AnyForceBase &Force = ..Joints.HumeroUlnarJoint.Constraints.Reaction;
  AnyRefFrame &Humerusfe = ..Segments.Humerus.fe;
  AnyVec3 Mlocal = M*Humerusfe.Axes;
};

AnyForceMomentMeasure WristJointReactionMoments =
{
 #ifndef WRIST_EXPERIMENTAL
  AnyForceBase &Force = ..Joints.WristJointFlexion.Constraints.Reaction;
#endif
 #ifdef WRIST_EXPERIMENTAL
   AnyForceBase &Force = ..Joints.RadioCarpalJointFlexionDeviation.Constraints.Reaction;
#endif
  AnyRefFrame &Radiuswj = ..Segments.Radius.wj;
  AnyVec3 Mlocal = M*Radiuswj.Axes;
};
