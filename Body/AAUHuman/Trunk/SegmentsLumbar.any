/*
Definitions of Segments in the Lumbar Part of the Spine + the pelvis
Abbrevitations:
ALL = Anterior Longitudinal Ligament
PLL = Posterior Longitudinal Ligament
LS = Ligamentum Supraspinale
LI = Ligamentum Interspinalia

MF = Multifidi
ILpl = Iliocostalis Lumborum pars lumborum (part of Erector Spinae)
LTpl = Longissimus Thoracis pars lumborum (part of Erector Spinae)
ILpt = Iliocostalis Lumborum pars thoracis (part of Erector Spinae)
LTpt = Longissimus Thoracis pars thoracis (part of Erector Spinae)
PM = Psoas Major
QL = Quadratus Lumborum
RA = Rectus Abdominis
OE = Obliquus Externus
OI = Obliquus Internus

C = Costae
CI = Crista Iliaca
CP = Crista Pubica
SIPS = Spina iliaca posterior superior
SIPI = Spina iliaca Posterior inferior
T = Thoracal hvirvel
L = Lumbal hvirvel
S = Sacral segment
*/

#include "PelvisSeg.any"

AnySeg SacrumSeg = {

  AnyFolder &Data=..Data.unscaled.ModelParameters.Sacrum;

  //initial position found as a function of pelvis pos and orientation
  r0=.PelvisSeg.PelvisSacrumJntNode.sRel*.PelvisSeg.Axes0'+.PelvisSeg.r0-SacrumPelvisJntNode.sRel*Axes0';
  Axes0=.PelvisSeg.Axes0;

  // Inertia properties for the segment
  UseInertiaObjects = On;
  #if (BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_)
    AnyInertiaSolid BoneInertiaObject = {
      BodyMassCorrection massCorrection() = {
        DensityTheoretical = ....Data.unscaled.ModelParameters.BoneDensity;
        enableMassCorrection = Off;
      };
      AnySurfSTL surface = {
        FileName = ...PelvisSeg.DrwSacrum.FileName;
        AnyFunTransform3D &scale = ..Scale;
        viewSurface.RGB = {0,0,1};
        ScaleXYZ = ...PelvisSeg.DrwSacrum.ScaleXYZ;
      };
    };
  #else
    AnyInertiaMatrix InertiaObject = {
      Jii = {0.001,0.001,0.001};
      ///  The mass of sacrum is added to the pelvis segment
      BodyMassCorrectionCompatibility massCorrection() = {
        DensityTheoretical = 1e-5;
        enableMassCorrection = Off;
      };
    };
  #endif


  // Sacrum is part of the pelvis so they scales together
  AnyRefNode& ScalingNode = AnatomicalFrameTrunk;
  AnyRefNode AnatomicalFrameTrunk = {
    sRel = ..PelvisSeg.AnatomicalFrameTrunk.sRel;
    ARel = ..PelvisSeg.AnatomicalFrameTrunk.ARel;
  };
  AnyFunTransform3D& Scale = .PelvisSeg.Scale;

  // Joint nodes
  AnyRefNode SacrumL5JntNode = {
    sRel = .Scale(.Data.SacrumL5JntNode_pos);
    /// Rotated node with x axis parallel to the sacrum base surface
    AnyRefNode RotNode = {
        ARel = RotMat(0.5*(..SacrumBaseAnteriorNode.sRel + ..SacrumBasePosteriorNode.sRel),
                      ..SacrumBaseAnteriorNode.sRel,
                      0.5*(..SacrumBaseAnteriorNode.sRel + ..SacrumBasePosteriorNode.sRel) + (..SacrumBaseNodeL.sRel - ..SacrumBaseNodeR.sRel))*RotMat(pi/2,x);
    };
  };
  AnyRefNode SacrumPelvisJntNode = {sRel = .Scale(.Data.SacrumPelvisJntNode_pos);};
  AnyRefNode SacrumContactNode = {sRel= .Scale(.Data.SacrumContactNode_pos);};

  AnyRefNode SacrumBonyTip ={sRel= .Scale(.Data.SacrumBonyTip_pos);};
  AnyRefNode SacrumPosteriorSuperior ={sRel= .Scale(.Data.SacrumPosteriorSuperior_pos);};

  // Nodes at the anterior and posterior points on the sacrum base that articulates with L5
  AnyRefNode SacrumBaseAnteriorNode = {sRel = .Scale(.Data.SacrumBaseAnteriorNode_pos);};
  AnyRefNode SacrumBasePosteriorNode = {sRel = .Scale(.Data.SacrumBasePosteriorNode_pos);};

  // Nodes at the right and left points on the sacrum base that articulates with L5
  AnyRefNode SacrumBaseNodeR = {sRel = .Scale(.Data.Right.SacrumBaseNode_pos);};
  AnyRefNode SacrumBaseNodeL = {sRel = .Scale(.Data.Left.SacrumBaseNode_pos);};

  /// The Right node is used by different body part for adding mirrored nodes
  /// (muscle origins/insertions etc) to the sacrum segment
  AnyRefNode Right= {
    AnyInt Sign = 1;
    AnyFunTransform3D& Scale = .Scale;
    AnyRefNode SacrumContactNode = {sRel= .Scale(..Data.Right.SacrumContactNode_pos);};
  };

  /// The Left node is used by different body part for adding mirrored nodes
  /// (muscle origins/insertions etc) to the sacrum segment
  AnyRefNode Left=  {
    AnyInt Sign = -1;
    AnyFunTransform3D& Scale = .Scale;
    AnyRefNode SacrumContactNode = {sRel= .Scale(..Data.Left.SacrumContactNode_pos);};
  };
   #if BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_
   #include "SacrumMuscleAttactmentNodes.any"
   #endif

  // MultifidusLumborum Nodes
  AnyRefNode MultifidusLumborumL4S1_1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL4S1_1Node_pos);};
  AnyRefNode MultifidusLumborumL4S1_1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL4S1_1Node_pos);};
  AnyRefNode MultifidusLumborumL5S1_1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL5S1_1Node_pos);};
  AnyRefNode MultifidusLumborumL5S1_1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL5S1_1Node_pos);};

  AnyRefNode MultifidusLumborumL3S1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL3S1Node_pos);};
  AnyRefNode MultifidusLumborumL3S1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL3S1Node_pos);};

  AnyRefNode MultifidusLumborumL4S1_2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL4S1_2Node_pos);};
  AnyRefNode MultifidusLumborumL4S1_2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL4S1_2Node_pos);};

  AnyRefNode MultifidusLumborumL5S1_2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL5S1_2Node_pos);};
  AnyRefNode MultifidusLumborumL5S1_2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL5S1_2Node_pos);};

  AnyRefNode MultifidusLumborumL1S1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL1S1Node_pos);};
  AnyRefNode MultifidusLumborumL1S1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL1S1Node_pos);};

  AnyRefNode MultifidusLumborumL2S1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL2S1Node_pos);};
  AnyRefNode MultifidusLumborumL2S1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL2S1Node_pos);};

  AnyRefNode MultifidusLumborumL3S2NodeViaR = {sRel = .Scale(.Data.Right.MultifidusLumborumL3S2NodeVia_pos);};
  AnyRefNode MultifidusLumborumL3S2NodeViaL = {sRel = .Scale(.Data.Left.MultifidusLumborumL3S2NodeVia_pos);};

  AnyRefNode MultifidusLumborumL3S2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL3S2Node_pos);};
  AnyRefNode MultifidusLumborumL3S2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL3S2Node_pos);};

  AnyRefNode MultifidusLumborumL4S2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL4S2Node_pos);};
  AnyRefNode MultifidusLumborumL4S2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL4S2Node_pos);};

  AnyRefNode MultifidusLumborumL4S2ViaNodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL4S2ViaNode_pos);};
  AnyRefNode MultifidusLumborumL4S2ViaNodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL4S2ViaNode_pos);};

  AnyRefNode MultifidusLumborumL5S3ViaNodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL5S3ViaNode_pos);};
  AnyRefNode MultifidusLumborumL5S3ViaNodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL5S3ViaNode_pos);};

  AnyRefNode MultifidusLumborumL5S3NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL5S3Node_pos);};
  AnyRefNode MultifidusLumborumL5S3NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL5S3Node_pos);};

  AnyRefNode LongissimusThoracisL5IliumNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL5IliumNode_pos);};
  AnyRefNode LongissimusThoracisL5IliumNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL5IliumNode_pos);};
  
  AnyRefNode LongissimusThoracisT6S1NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT6S1Node_pos);};
  AnyRefNode LongissimusThoracisT6S1NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT6S1Node_pos);};

  AnyRefNode LongissimusThoracisT7S2NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT7S2Node_pos);};
  AnyRefNode LongissimusThoracisT7S2NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT7S2Node_pos);};

  AnyRefNode LongissimusThoracisT8S3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT8S3Node_pos);};
  AnyRefNode LongissimusThoracisT8S3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT8S3Node_pos);};

  AnyRefNode LongissimusThoracisT9S4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT9S4Node_pos);};
  AnyRefNode LongissimusThoracisT9S4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT9S4Node_pos);};

  AnyRefNode LongissimusThoracisT10S3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT10S3Node_pos);};
  AnyRefNode LongissimusThoracisT10S3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT10S3Node_pos);};

  AnyRefNode LongissimusThoracisT11S3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT11S3Node_pos);};
  AnyRefNode LongissimusThoracisT11S3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT11S3Node_pos);};

  AnyRefNode LongissimusThoracisT12S3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT12S3Node_pos);};
  AnyRefNode LongissimusThoracisT12S3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT12S3Node_pos);};
  
  AnyRefNode LongissimusThoracisR6S1NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR6S1Node_pos);};
  AnyRefNode LongissimusThoracisR6S1NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR6S1Node_pos);};

  AnyRefNode LongissimusThoracisR7S2NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR7S2Node_pos);};
  AnyRefNode LongissimusThoracisR7S2NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR7S2Node_pos);};

  AnyRefNode LongissimusThoracisR8S3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR8S3Node_pos);};
  AnyRefNode LongissimusThoracisR8S3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR8S3Node_pos);};

  AnyRefNode LongissimusThoracisR9S4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR9S4Node_pos);};
  AnyRefNode LongissimusThoracisR9S4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR9S4Node_pos);};

  AnyRefNode LongissimusThoracisR10S3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR10S3Node_pos);};
  AnyRefNode LongissimusThoracisR10S3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR10S3Node_pos);};

  AnyRefNode LongissimusThoracisR11S3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR11S3Node_pos);};
  AnyRefNode LongissimusThoracisR11S3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR11S3Node_pos);};

  AnyRefNode LongissimusThoracisR12S3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR12S3Node_pos);};
  AnyRefNode LongissimusThoracisR12S3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR12S3Node_pos);};

  AnyRefNode LongissimusThoracisT10S3ViaNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT10S3ViaNode_pos);};
  AnyRefNode LongissimusThoracisT10S3ViaNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT10S3ViaNode_pos);};

  AnyRefNode LongissimusThoracisT11S3ViaNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT11S3ViaNode_pos);};
  AnyRefNode LongissimusThoracisT11S3ViaNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT11S3ViaNode_pos);};

  AnyRefNode LongissimusThoracisR11S3ViaNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR11S3ViaNode_pos);};
  AnyRefNode LongissimusThoracisR11S3ViaNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR11S3ViaNode_pos);};

  AnyRefNode LongissimusThoracisT12S3ViaNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT12S3ViaNode_pos);};
  AnyRefNode LongissimusThoracisT12S3ViaNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT12S3ViaNode_pos);};

  AnyRefNode LongissimusThoracisR12S3ViaNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR12S3ViaNode_pos);};
  AnyRefNode LongissimusThoracisR12S3ViaNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR12S3ViaNode_pos);};
}; // SacrumSeg


// -------- Drawing object section (pelvis&sacrum)--------
#if (! BM_LEG_MODEL_IS_TLEM ) | (BM_PELVIS_DISPLAY == _PELVIS_DISPLAY_LEGANDTRUNKPELVIS_)
  SacrumSeg = {
    #if (BM_PELVIS_DISPLAY == _PELVIS_DISPLAY_LEGANDTRUNKPELVIS_)
    DrwSacrumForTrunk.Opacity = Main.DrawSettings.BonesOpacity.Sacrum*0.5;
    AnyDrawSurf DrwSacrumForTrunk =
    #else
    DrwSacrum.Opacity = Main.DrawSettings.BonesOpacity.Sacrum;
    AnyDrawSurf DrwSacrum =
    #endif
    {
      FileName = ...Data.unscaled.STL.FilenameSacrumSeg;
      RGB = ...ColorRef.Segments;
      AnyFunTransform3D &Scale =.Scale;
    };
  }; // SacrumSeg
#endif
// -------- End of drawing section (pelvis&sacrum)--------


AnySeg L5Seg = {

  AnyFolder &Data=..Data.unscaled.ModelParameters.L5;

  //initial position found as a function of pelvis pos and orientation
  r0=.SacrumSeg.SacrumL5JntNode.sRel*.SacrumSeg.Axes0'+.SacrumSeg.r0-L5SacrumJntNode.sRel*Axes0';

  // This file includes the trunk specifc scaling function
  // and anatomical reference system
  #include "TrunkAnatomicalFrame.any"

  TrunkScaleWithInterfaceMorphing Scale(
    GeomScale = ...Scaling.GeometricalScaling.L5Seg.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  TrunkScaleWithInterfaceMorphing ScaleAbdominal(
    GeomScale = ...Scaling.GeometricalScaling.Lumbar.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  // Inertia properties for the segment
  UseInertiaObjects = On;

  #if (BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_)
    AnyInertiaSolid BoneInertiaObject = {
      BodyMassCorrection massCorrection() = {
        DensityTheoretical = ....Data.unscaled.ModelParameters.BoneDensity;
        enableMassCorrection = Off;
      };
      AnySurfSTL surface = {
        FileName = ..BoneDraw.FileName;
        AnyFunTransform3D &scale = ..Scale;
        viewSurface.RGB = {0,0,1};
        ScaleXYZ = ..BoneDraw.ScaleXYZ;
      };
    };
  #else
    AnyInertiaMatrix InertiaObject = {
      BodyMassCorrectionCompatibility massCorrection() = {
        DensityTheoretical = ....Data.unscaled.StandardParameters.Lumbar.L5Mass;
      };
      Jii = {0.001,0.001,0.001};
      JaboutCoMOnOff = On;
      sCoM = .Scale(.Data.sCoM_pos);
    };
  #endif



  AnyRefNode L5SacrumJntNode = {sRel = .Scale(.Data.L5SacrumJntNode_pos);};
  AnyRefNode L4L5JntNode = {
    sRel = .Scale(.Data.L4L5JntNode_pos);
    // Rotated node with x axis parallel to the superior endplate surface
    AnyRefNode RotNode = {
        ARel = RotMat(
          0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel),
          ..SuperiorEndplateAnteriorNode.sRel,
          0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel) + (..SuperiorEndplateNodeL.sRel - ..SuperiorEndplateNodeR.sRel)
        )*RotMat(pi/2,x);
    };
  };

  // Nodes at the right and left points on the superior endplate
  AnyRefNode SuperiorEndplateNodeR = {sRel = .Scale(.Data.Right.SuperiorEndplateNode_pos);};
  AnyRefNode SuperiorEndplateNodeL = {sRel = .Scale(.Data.Left.SuperiorEndplateNode_pos);};

  // Nodes at the anterior and posterior points on the superior endplate
  AnyRefNode SuperiorEndplateAnteriorNode = {sRel = .Scale(.Data.SuperiorEndplateAnteriorNode_pos);};
  AnyRefNode SuperiorEndplatePosteriorNode = {sRel = .Scale(.Data.SuperiorEndplatePosteriorNode_pos);};

  //These nodes are used for adding extra used by other body parts to the right
  //and left side of the segment
  AnyRefNode Right = {AnyFunTransform3D&Scale=.Scale;};
  AnyRefNode Left = {AnyFunTransform3D&Scale=.Scale;};


  // Ligament Nodes
  AnyRefNode LINodeSuperior = {sRel = .Scale(.Data.LINodeSuperior_pos);};
  // End of ligament Nodes

  // MultifidusLumborum Nodes
  AnyRefNode MultifidusLumborumL3L5NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL3L5Node_pos);};
  AnyRefNode MultifidusLumborumL3L5NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL3L5Node_pos);};

  AnyRefNode MultifidusLumborumL5S1_1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL5S1_1Node_pos);};
  AnyRefNode MultifidusLumborumL5S1_1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL5S1_1Node_pos);};

  AnyRefNode MultifidusLumborumL2L5_1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL2L5_1Node_pos);};
  AnyRefNode MultifidusLumborumL2L5_1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL2L5_1Node_pos);};

  AnyRefNode MultifidusLumborumL5S1_2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL5S1_2Node_pos);};
  AnyRefNode MultifidusLumborumL5S1_2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL5S1_2Node_pos);};

  AnyRefNode MultifidusLumborumL1L5NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL1L5Node_pos);};
  AnyRefNode MultifidusLumborumL1L5NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL1L5Node_pos);};

  AnyRefNode MultifidusLumborumL2L5_2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL2L5_2Node_pos);};
  AnyRefNode MultifidusLumborumL2L5_2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL2L5_2Node_pos);};

  AnyRefNode MultifidusLumborumL5S3NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL5S3Node_pos);};
  AnyRefNode MultifidusLumborumL5S3NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL5S3Node_pos);};
  // End of MultifidusLumborum Nodes

  // Erector Spinae Nodes
  AnyRefNode LongissimusThoracisL5IliumNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL5IliumNode_pos);};
  AnyRefNode LongissimusThoracisL5IliumNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL5IliumNode_pos);};

  AnyRefNode LongissimusThoracisT5L5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT5L5Node_pos);};
  AnyRefNode LongissimusThoracisT5L5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT5L5Node_pos);};

  AnyRefNode LongissimusThoracisT6S1Via11NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT6S1Via11Node_pos);};
  AnyRefNode LongissimusThoracisT6S1Via11NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT6S1Via11Node_pos);};

  AnyRefNode LongissimusThoracisT7S2Via10NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT7S2Via10Node_pos);};
  AnyRefNode LongissimusThoracisT7S2Via10NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT7S2Via10Node_pos);};

  AnyRefNode LongissimusThoracisT8S3Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT8S3Via9Node_pos);};
  AnyRefNode LongissimusThoracisT8S3Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT8S3Via9Node_pos);};

  AnyRefNode LongissimusThoracisT9S4Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT9S4Via8Node_pos);};
  AnyRefNode LongissimusThoracisT9S4Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT9S4Via8Node_pos);};

  AnyRefNode LongissimusThoracisT10S3Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT10S3Via7Node_pos);};
  AnyRefNode LongissimusThoracisT10S3Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT10S3Via7Node_pos);};

  AnyRefNode LongissimusThoracisT11S3Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT11S3Via6Node_pos);};
  AnyRefNode LongissimusThoracisT11S3Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT11S3Via6Node_pos);};

  AnyRefNode LongissimusThoracisT12S3Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT12S3Via5Node_pos);};
  AnyRefNode LongissimusThoracisT12S3Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT12S3Via5Node_pos);};

  AnyRefNode LongissimusThoracisR5L5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR5L5Node_pos);};
  AnyRefNode LongissimusThoracisR5L5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR5L5Node_pos);};

  AnyRefNode LongissimusThoracisR6S1Via11NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR6S1Via11Node_pos);};
  AnyRefNode LongissimusThoracisR6S1Via11NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR6S1Via11Node_pos);};

  AnyRefNode LongissimusThoracisR7S2Via10NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR7S2Via10Node_pos);};
  AnyRefNode LongissimusThoracisR7S2Via10NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR7S2Via10Node_pos);};

  AnyRefNode LongissimusThoracisR8S3Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR8S3Via9Node_pos);};
  AnyRefNode LongissimusThoracisR8S3Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR8S3Via9Node_pos);};

  AnyRefNode LongissimusThoracisR9S4Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR9S4Via8Node_pos);};
  AnyRefNode LongissimusThoracisR9S4Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR9S4Via8Node_pos);};

  AnyRefNode LongissimusThoracisR10S3Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR10S3Via7Node_pos);};
  AnyRefNode LongissimusThoracisR10S3Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR10S3Via7Node_pos);};

  AnyRefNode LongissimusThoracisR11S3Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR11S3Via6Node_pos);};
  AnyRefNode LongissimusThoracisR11S3Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR11S3Via6Node_pos);};

  AnyRefNode LongissimusThoracisR12S3Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR12S3Via5Node_pos);};
  AnyRefNode LongissimusThoracisR12S3Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR12S3Via5Node_pos);};
  // End of Erector Spinae Nodes

  // Psoas Major Nodes
  AnyRefNode PsoasMajorL5_1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL5_1Node_pos);};
  AnyRefNode PsoasMajorL5_1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL5_1Node_pos);};

  AnyRefNode PsoasMajorL5_2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL5_2Node_pos);};
  AnyRefNode PsoasMajorL5_2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL5_2Node_pos);};

  AnyRefNode PsoasMajorT12Via4NodeR = {sRel = .Scale(.Data.Right.PsoasMajorT12Via4Node_pos);};
  AnyRefNode PsoasMajorT12Via4NodeL = {sRel = .Scale(.Data.Left.PsoasMajorT12Via4Node_pos);};

  AnyRefNode PsoasMajorL1_1Via3NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_1Via3Node_pos);};
  AnyRefNode PsoasMajorL1_1Via3NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_1Via3Node_pos);};

  AnyRefNode PsoasMajorL2_1Via2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL2_1Via2Node_pos);};
  AnyRefNode PsoasMajorL2_1Via2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL2_1Via2Node_pos);};

  AnyRefNode PsoasMajorL3_1Via1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL3_1Via1Node_pos);};
  AnyRefNode PsoasMajorL3_1Via1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL3_1Via1Node_pos);};

  AnyRefNode PsoasMajorL1_2Via4NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_2Via4Node_pos);};
  AnyRefNode PsoasMajorL1_2Via4NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_2Via4Node_pos);};

  AnyRefNode PsoasMajorL2_2Via3NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL2_2Via3Node_pos);};
  AnyRefNode PsoasMajorL2_2Via3NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL2_2Via3Node_pos);};

  AnyRefNode PsoasMajorL3_2Via2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL3_2Via2Node_pos);};
  AnyRefNode PsoasMajorL3_2Via2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL3_2Via2Node_pos);};

  AnyRefNode PsoasMajorL4_2Via1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL4_2Via1Node_pos);};
  AnyRefNode PsoasMajorL4_2Via1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL4_2Via1Node_pos);};
  // End of Psoas Major Nodes

  // Obliquus Externus Nodes
  AnyRefNode OEC10_RSNodeR = {sRel = .Scale(.Data.Right.OEC10_RSNode_pos);};
  AnyRefNode OEC10_RSNodeL = {sRel = .Scale(.Data.Left.OEC10_RSNode_pos);};
  // End of Obliquus Externus Nodes

  AnyDrawSurf BoneDraw = {
    FileName = ...Data.unscaled.STL.FilenameL5Seg;
    RGB = ...ColorRef.Segments;
    Opacity = Main.DrawSettings.BonesOpacity.L5;
    AnyFunTransform3D &Scale =.Scale;
  };

  #if BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_
    AnyRefNode TransversusInsNode_R={sRel=.Scale(.Data.Right.Transversus_Ins_pos);};
    AnyRefNode TransversusInsNode_L={sRel=.Scale(.Data.Left.Transversus_Ins_pos);};
    AnyRefNode TransversusMid={sRel=0.5*(.TransversusInsNode_R.sRel+.TransversusInsNode_L.sRel) ;};
  #else
    AnyRefNode TransversusOrgNode = {sRel = .MidPoint.sRel;};
    AnyRefNode TransversusInsNode = {sRel = .TransversusOrgNode.sRel;};
  #endif

  AnyRefNode MidPoint = {sRel = (.L4L5JntNode.sRel+.L5SacrumJntNode.sRel)*0.5;};
  AnyRefNode &SupportNode = MidPoint;

  AnyRefNode BuckleContactNode = {sRel= .ScaleAbdominal(.Data.BuckleContactNode_pos);};

  AnyRefNode L5RContactNode = {sRel= .Scale(.Data.Right.ContactNode_pos);};
  AnyRefNode L5LContactNode = {sRel= .Scale(.Data.Left.ContactNode_pos);};

}; // End of L5Seg

AnySeg L4Seg = {

  AnyFolder &Data=..Data.unscaled.ModelParameters.L4;

//initial position found as a function of pelvis pos and orientation
  r0=.L5Seg.L4L5JntNode.sRel*.L5Seg.Axes0'+.L5Seg.r0-L4L5JntNode.sRel*Axes0';

  // This file includes the trunk specifc scaling function
  // and anatomical reference system
  #include "TrunkAnatomicalFrame.any"

  TrunkScaleWithInterfaceMorphing Scale(
    GeomScale = ...Scaling.GeometricalScaling.L4Seg.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  TrunkScaleWithInterfaceMorphing ScaleAbdominal(
    GeomScale = ...Scaling.GeometricalScaling.Lumbar.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  // Inertia properties for the segment
  UseInertiaObjects = On;

  #if (BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_)
    AnyInertiaSolid BoneInertiaObject = {
      BodyMassCorrection massCorrection() = {
        DensityTheoretical = ....Data.unscaled.ModelParameters.BoneDensity;
        enableMassCorrection = Off;
      };
      AnySurfSTL surface = {
        FileName = ..BoneDraw.FileName;
        AnyFunTransform3D &scale = ..Scale;
        viewSurface.RGB = {0,0,1};
        ScaleXYZ = ..BoneDraw.ScaleXYZ;
      };
    };
  #else
    AnyInertiaMatrix InertiaObject = {
      BodyMassCorrectionCompatibility massCorrection() = {
        DensityTheoretical = ....Data.unscaled.StandardParameters.Lumbar.L4Mass;
      };
      Jii = {0.001,0.001,0.001};
      JaboutCoMOnOff = On;
      sCoM = .Scale(.Data.sCoM_pos);
    };
  #endif




  AnyRefNode L4L5JntNode = {sRel = .Scale(.Data.L4L5JntNode_pos);};
  AnyRefNode L3L4JntNode = {
    sRel = .Scale(.Data.L3L4JntNode_pos);
    /// Rotated node with x axis parallel to the superior endplate surface
    AnyRefNode RotNode = {
      ARel = RotMat(
        0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel),
        ..SuperiorEndplateAnteriorNode.sRel,
        0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel) + (..SuperiorEndplateNodeL.sRel - ..SuperiorEndplateNodeR.sRel)
      )*RotMat(pi/2,x);
    };
  };

  // Nodes at the anterior and posterior points on the superior endplate
  AnyRefNode SuperiorEndplateAnteriorNode = {sRel = .Scale(.Data.SuperiorEndplateAnteriorNode_pos);};
  AnyRefNode SuperiorEndplatePosteriorNode = {sRel = .Scale(.Data.SuperiorEndplatePosteriorNode_pos);};

  // Nodes at the right and left points on the superior endplate
  AnyRefNode SuperiorEndplateNodeR = {sRel = .Scale(.Data.Right.SuperiorEndplateNode_pos);};
  AnyRefNode SuperiorEndplateNodeL = {sRel = .Scale(.Data.Left.SuperiorEndplateNode_pos);};

  //These nodes are used for adding extra used by other body parts to the right
  //and left side of the segment
  AnyRefNode Right = {AnyFunTransform3D&Scale=.Scale;};
  AnyRefNode Left = {AnyFunTransform3D&Scale=.Scale;};

  // Ligament Nodes
  AnyRefNode LSNode = {sRel = .Scale(.Data.LSNode_pos);};

  AnyRefNode LINodeInferior = {sRel = .Scale(.Data.LINodeInferior_pos);};
  AnyRefNode LINodeSuperior = {sRel = .Scale(.Data.LINodeSuperior_pos);};
  // End of ligament Nodes

  // MultifidusLumborum Nodes
  AnyRefNode MultifidusLumborumL2L4NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL2L4Node_pos);};
  AnyRefNode MultifidusLumborumL2L4NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL2L4Node_pos);};

  AnyRefNode MultifidusLumborumL4S1_1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL4S1_1Node_pos);};
  AnyRefNode MultifidusLumborumL4S1_1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL4S1_1Node_pos);};

  AnyRefNode MultifidusLumborumL1L4NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL1L4Node_pos);};
  AnyRefNode MultifidusLumborumL1L4NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL1L4Node_pos);};

  AnyRefNode MultifidusLumborumL4S1_2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL4S1_2Node_pos);};
  AnyRefNode MultifidusLumborumL4S1_2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL4S1_2Node_pos);};

  AnyRefNode MultifidusLumborumL4S2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL4S2Node_pos);};
  AnyRefNode MultifidusLumborumL4S2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL4S2Node_pos);};
  // End of MultifidusLumborum Nodes

  // Erector Spinae Nodes
  AnyRefNode IliocostalisLumborumL4NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL4Node_pos);};
  AnyRefNode IliocostalisLumborumL4NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL4Node_pos);};

  AnyRefNode LongissimusThoracisL4ICNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL4ICNode_pos);};
  AnyRefNode LongissimusThoracisL4ICNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL4ICNode_pos);};

  AnyRefNode LongissimusThoracisT4L4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT4L4Node_pos);};
  AnyRefNode LongissimusThoracisT4L4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT4L4Node_pos);};

  AnyRefNode LongissimusThoracisR4L4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR4L4Node_pos);};
  AnyRefNode LongissimusThoracisR4L4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR4L4Node_pos);};

  AnyRefNode IliocostalisLumborumL1ViaNodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL1ViaNode_pos);};
  AnyRefNode IliocostalisLumborumL1ViaNodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL1ViaNode_pos);};

  AnyRefNode IliocostalisLumborumL2ViaNodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL2ViaNode_pos);};
  AnyRefNode IliocostalisLumborumL2ViaNodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL2ViaNode_pos);};

  AnyRefNode LongissimusThoracisT5L5Via11NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT5L5Via11Node_pos);};
  AnyRefNode LongissimusThoracisT5L5Via11NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT5L5Via11Node_pos);};

  AnyRefNode LongissimusThoracisT6S1Via10NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT6S1Via10Node_pos);};
  AnyRefNode LongissimusThoracisT6S1Via10NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT6S1Via10Node_pos);};

  AnyRefNode LongissimusThoracisT7S2Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT7S2Via9Node_pos);};
  AnyRefNode LongissimusThoracisT7S2Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT7S2Via9Node_pos);};

  AnyRefNode LongissimusThoracisT8S3Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT8S3Via8Node_pos);};
  AnyRefNode LongissimusThoracisT8S3Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT8S3Via8Node_pos);};

  AnyRefNode LongissimusThoracisT9S4Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT9S4Via7Node_pos);};
  AnyRefNode LongissimusThoracisT9S4Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT9S4Via7Node_pos);};

  AnyRefNode LongissimusThoracisT10S3Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT10S3Via6Node_pos);};
  AnyRefNode LongissimusThoracisT10S3Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT10S3Via6Node_pos);};

  AnyRefNode LongissimusThoracisT11S3Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT11S3Via5Node_pos);};
  AnyRefNode LongissimusThoracisT11S3Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT11S3Via5Node_pos);};

  AnyRefNode LongissimusThoracisT12S3Via4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT12S3Via4Node_pos);};
  AnyRefNode LongissimusThoracisT12S3Via4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT12S3Via4Node_pos);};
 
  AnyRefNode LongissimusThoracisR5L5Via11NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR5L5Via11Node_pos);};
  AnyRefNode LongissimusThoracisR5L5Via11NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR5L5Via11Node_pos);};

  AnyRefNode LongissimusThoracisR6S1Via10NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR6S1Via10Node_pos);};
  AnyRefNode LongissimusThoracisR6S1Via10NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR6S1Via10Node_pos);};

  AnyRefNode LongissimusThoracisR7S2Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR7S2Via9Node_pos);};
  AnyRefNode LongissimusThoracisR7S2Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR7S2Via9Node_pos);};

  AnyRefNode LongissimusThoracisR8S3Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR8S3Via8Node_pos);};
  AnyRefNode LongissimusThoracisR8S3Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR8S3Via8Node_pos);};

  AnyRefNode LongissimusThoracisR9S4Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR9S4Via7Node_pos);};
  AnyRefNode LongissimusThoracisR9S4Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR9S4Via7Node_pos);};

  AnyRefNode LongissimusThoracisR10S3Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR10S3Via6Node_pos);};
  AnyRefNode LongissimusThoracisR10S3Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR10S3Via6Node_pos);};

  AnyRefNode LongissimusThoracisR11S3Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR11S3Via5Node_pos);};
  AnyRefNode LongissimusThoracisR11S3Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR11S3Via5Node_pos);};

  AnyRefNode LongissimusThoracisR12S3Via4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR12S3Via4Node_pos);};
  AnyRefNode LongissimusThoracisR12S3Via4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR12S3Via4Node_pos);};
  // End of Erector Spinae Nodes

  // Psoas Major Nodes
  AnyRefNode PsoasMajorL4_1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL4_1Node_pos);};
  AnyRefNode PsoasMajorL4_1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL4_1Node_pos);};

  AnyRefNode PsoasMajorL4_2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL4_2Node_pos);};
  AnyRefNode PsoasMajorL4_2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL4_2Node_pos);};

  AnyRefNode PsoasMajorT12Via3NodeR = {sRel = .Scale(.Data.Right.PsoasMajorT12Via3Node_pos);};
  AnyRefNode PsoasMajorT12Via3NodeL = {sRel = .Scale(.Data.Left.PsoasMajorT12Via3Node_pos);};

  AnyRefNode PsoasMajorL1_1Via2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_1Via2Node_pos);};
  AnyRefNode PsoasMajorL1_1Via2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_1Via2Node_pos);};

  AnyRefNode PsoasMajorL2_1Via1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL2_1Via1Node_pos);};
  AnyRefNode PsoasMajorL2_1Via1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL2_1Via1Node_pos);};

  AnyRefNode PsoasMajorL1_2Via3NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_2Via3Node_pos);};
  AnyRefNode PsoasMajorL1_2Via3NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_2Via3Node_pos);};

  AnyRefNode PsoasMajorL2_2Via2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL2_2Via2Node_pos);};
  AnyRefNode PsoasMajorL2_2Via2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL2_2Via2Node_pos);};

  AnyRefNode PsoasMajorL3_2Via1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL3_2Via1Node_pos);};
  AnyRefNode PsoasMajorL3_2Via1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL3_2Via1Node_pos);};
  // End of Psoas Major Nodes

  // Quadratus Lumborum Nodes
  AnyRefNode QLL4_CINodeR = {sRel = .Scale(.Data.Right.QLL4_CINode_pos);};
  AnyRefNode QLL4_CINodeL = {sRel = .Scale(.Data.Left.QLL4_CINode_pos);};
  // End of Quadratus Lumborum Nodes

  // Obliquus Externus Nodes
  AnyRefNode OEC9_RSNodeR = {sRel = .Scale(.Data.Right.OEC9_RSNode_pos);};
  AnyRefNode OEC9_RSNodeL = {sRel = .Scale(.Data.Left.OEC9_RSNode_pos);};
  // End of Obliquus Externus Nodes

  // Obliquus Internus Nodes
  AnyRefNode OICI_RS3NodeR = {sRel = .Scale(.Data.Right.OICI_RS3Node_pos);};
  AnyRefNode OICI_RS3NodeL = {sRel = .Scale(.Data.Left.OICI_RS3Node_pos);};
  // End of Obliquus Internus Nodes

  AnyDrawSurf BoneDraw = {
    FileName = ...Data.unscaled.STL.FilenameL4Seg;
    RGB = ...ColorRef.Segments;
    Opacity = Main.DrawSettings.BonesOpacity.L4;
    AnyFunTransform3D &Scale =.Scale;
  };

  #if BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_
    AnyRefNode TransversusInsNode_R={sRel=.Scale(.Data.Right.Transversus_Ins_pos);};
    AnyRefNode TransversusInsNode_L={sRel=.Scale(.Data.Left.Transversus_Ins_pos);};
    AnyRefNode TransversusMid={sRel=0.5*(.TransversusInsNode_R.sRel+.TransversusInsNode_L.sRel) ;};
  #else
    AnyRefNode TransversusOrgNode = {sRel = .MidPoint.sRel;};
    AnyRefNode TransversusInsNode = {sRel = .TransversusOrgNode.sRel;};
  #endif

  AnyRefNode MidPoint = {sRel = (.L3L4JntNode.sRel+.L4L5JntNode.sRel)*0.5;};
  AnyRefNode SupportNode = {sRel = .Scale(.Data.SupportNode_pos);};
  AnyRefNode BuckleContactNode = {sRel= .ScaleAbdominal(.Data.BuckleContactNode_pos);};

  AnyRefNode L4RContactNode = {sRel= .Scale(.Data.Right.ContactNode_pos);};
  AnyRefNode L4LContactNode = {sRel= .Scale(.Data.Left.ContactNode_pos);};

}; // End of L4Seg

AnySeg L3Seg = {
  AnyFolder &Data = ..Data.unscaled.ModelParameters.L3;
  //initial position found as a function of pelvis pos and orientation
  r0=.L4Seg.L3L4JntNode.sRel*.L4Seg.Axes0'+.L4Seg.r0-L3L4JntNode.sRel*Axes0';

  // This file includes the trunk specifc scaling function
  // and anatomical reference system
  #include "TrunkAnatomicalFrame.any"

  TrunkScaleWithInterfaceMorphing Scale(
    GeomScale = ...Scaling.GeometricalScaling.L3Seg.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  TrunkScaleWithInterfaceMorphing ScaleAbdominal(
    GeomScale = ...Scaling.GeometricalScaling.Lumbar.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  // Inertia properties for the segment
  UseInertiaObjects = On;

  #if (BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_)
    AnyInertiaSolid BoneInertiaObject = {
      BodyMassCorrection massCorrection() = {
        DensityTheoretical = ....Data.unscaled.ModelParameters.BoneDensity;
        enableMassCorrection = Off;
      };
      AnySurfSTL surface = {
        FileName = ..BoneDraw.FileName;
        AnyFunTransform3D &scale = ..Scale;
        viewSurface.RGB = {0,0,1};
        ScaleXYZ = ..BoneDraw.ScaleXYZ;
      };
    };
  #else
    AnyInertiaMatrix InertiaObject = {
      BodyMassCorrectionCompatibility massCorrection() = {
        DensityTheoretical = ....Data.unscaled.StandardParameters.Lumbar.L3Mass;
      };
      Jii = {0.001,0.001,0.001};
      JaboutCoMOnOff = On;
      sCoM = .Scale(.Data.sCoM_pos);
    };
  #endif




  AnyRefNode L3L4JntNode = {sRel = .Scale(.Data.L3L4JntNode_pos);};
  AnyRefNode L2L3JntNode = {
    sRel = .Scale(.Data.L2L3JntNode_pos);
    // Rotated node with x axis parallel to the superior endplate surface
    AnyRefNode RotNode = {
      ARel = RotMat(
        0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel),
        ..SuperiorEndplateAnteriorNode.sRel,
        0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel) + (..SuperiorEndplateNodeL.sRel - ..SuperiorEndplateNodeR.sRel)
      )*RotMat(pi/2,x);
    };
  };

  // Nodes at the anterior and posterior points on the superior endplate
  AnyRefNode SuperiorEndplateAnteriorNode = {sRel = .Scale(.Data.SuperiorEndplateAnteriorNode_pos);};
  AnyRefNode SuperiorEndplatePosteriorNode = {sRel = .Scale(.Data.SuperiorEndplatePosteriorNode_pos);};

  // Nodes at the right and left points on the superior endplate
  AnyRefNode SuperiorEndplateNodeR = {sRel = .Scale(.Data.Right.SuperiorEndplateNode_pos);};
  AnyRefNode SuperiorEndplateNodeL = {sRel = .Scale(.Data.Left.SuperiorEndplateNode_pos);};

  //These nodes are used for adding extra used by other body parts to the right
  //and left side of the segment
  AnyRefNode Right= {AnyFunTransform3D&Scale=.Scale;
    AnyRefNode ICSpringSupNode        = { sRel =  .Scale(..Data.Right.ICSpringSupNode_pos); };
  };
  AnyRefNode Left = {AnyFunTransform3D&Scale=.Scale;
    AnyRefNode ICSpringSupNode        = { sRel =  .Scale(..Data.Left.ICSpringSupNode_pos); };
  };


  // Ligament Nodes
  AnyRefNode LSNode = {sRel = .Scale(.Data.LSNode_pos);};

  AnyRefNode LINodeInferior = {sRel = .Scale(.Data.LINodeInferior_pos);};
  AnyRefNode LINodeSuperior = {sRel = .Scale(.Data.LINodeSuperior_pos);};
  // End of ligament Nodes

  // MultifidusLumborum Nodes
  AnyRefNode MultifidusLumborumL1L3NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL1L3Node_pos);};
  AnyRefNode MultifidusLumborumL1L3NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL1L3Node_pos);};

  AnyRefNode MultifidusLumborumL3L5NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL3L5Node_pos);};
  AnyRefNode MultifidusLumborumL3L5NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL3L5Node_pos);};

  AnyRefNode MultifidusLumborumL3S1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL3S1Node_pos);};
  AnyRefNode MultifidusLumborumL3S1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL3S1Node_pos);};

  AnyRefNode MultifidusLumborumL3S2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL3S2Node_pos);};
  AnyRefNode MultifidusLumborumL3S2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL3S2Node_pos);};
  // End of MultifidusLumborum Nodes

  // Erector Spinae Nodes
  AnyRefNode IliocostalisLumborumL3NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL3Node_pos);};
  AnyRefNode IliocostalisLumborumL3NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL3Node_pos);};

  AnyRefNode LongissimusThoracisL3ICNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL3ICNode_pos);};
  AnyRefNode LongissimusThoracisL3ICNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL3ICNode_pos);};

  AnyRefNode LongissimusThoracisT3L3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT3L3Node_pos);};
  AnyRefNode LongissimusThoracisT3L3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT3L3Node_pos);};

  AnyRefNode LongissimusThoracisR3L3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR3L3Node_pos);};
  AnyRefNode LongissimusThoracisR3L3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR3L3Node_pos);};

  AnyRefNode IliocostalisLumborumL1ViaNodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL1ViaNode_pos);};
  AnyRefNode IliocostalisLumborumL1ViaNodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL1ViaNode_pos);};

  AnyRefNode IliocostalisLumborumL2ViaNodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL2ViaNode_pos);};
  AnyRefNode IliocostalisLumborumL2ViaNodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL2ViaNode_pos);};

  AnyRefNode LongissimusThoracisL1ICViaNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL1ICViaNode_pos);};
  AnyRefNode LongissimusThoracisL1ICViaNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL1ICViaNode_pos);};

  AnyRefNode LongissimusThoracisL2ICViaNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL2ICViaNode_pos);};
  AnyRefNode LongissimusThoracisL2ICViaNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL2ICViaNode_pos);};

  AnyRefNode IliocostalisLumborumR5Via9NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR5Via9Node_pos);};
  AnyRefNode IliocostalisLumborumR5Via9NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR5Via9Node_pos);};

  AnyRefNode IliocostalisLumborumR6Via8NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR6Via8Node_pos);};
  AnyRefNode IliocostalisLumborumR6Via8NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR6Via8Node_pos);};

  AnyRefNode IliocostalisLumborumR7Via7NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR7Via7Node_pos);};
  AnyRefNode IliocostalisLumborumR7Via7NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR7Via7Node_pos);};

  AnyRefNode IliocostalisLumborumR8Via6NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR8Via6Node_pos);};
  AnyRefNode IliocostalisLumborumR8Via6NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR8Via6Node_pos);};

  AnyRefNode IliocostalisLumborumR9Via5NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR9Via5Node_pos);};
  AnyRefNode IliocostalisLumborumR9Via5NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR9Via5Node_pos);};

  AnyRefNode IliocostalisLumborumR10Via4NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR10Via4Node_pos);};
  AnyRefNode IliocostalisLumborumR10Via4NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR10Via4Node_pos);};

  AnyRefNode IliocostalisLumborumR11Via3NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR11Via3Node_pos);};
  AnyRefNode IliocostalisLumborumR11Via3NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR11Via3Node_pos);};

  AnyRefNode IliocostalisLumborumR12Via3NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR12Via3Node_pos);};
  AnyRefNode IliocostalisLumborumR12Via3NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR12Via3Node_pos);};

  AnyRefNode LongissimusThoracisT4L4Via11NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT4L4Via11Node_pos);};
  AnyRefNode LongissimusThoracisT4L4Via11NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT4L4Via11Node_pos);};

  AnyRefNode LongissimusThoracisT5L5Via10NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT5L5Via10Node_pos);};
  AnyRefNode LongissimusThoracisT5L5Via10NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT5L5Via10Node_pos);};

  AnyRefNode LongissimusThoracisT6S1Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT6S1Via9Node_pos);};
  AnyRefNode LongissimusThoracisT6S1Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT6S1Via9Node_pos);};

  AnyRefNode LongissimusThoracisT7S2Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT7S2Via8Node_pos);};
  AnyRefNode LongissimusThoracisT7S2Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT7S2Via8Node_pos);};

  AnyRefNode LongissimusThoracisT8S3Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT8S3Via7Node_pos);};
  AnyRefNode LongissimusThoracisT8S3Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT8S3Via7Node_pos);};

  AnyRefNode LongissimusThoracisT9S4Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT9S4Via6Node_pos);};
  AnyRefNode LongissimusThoracisT9S4Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT9S4Via6Node_pos);};

  AnyRefNode LongissimusThoracisT10S3Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT10S3Via5Node_pos);};
  AnyRefNode LongissimusThoracisT10S3Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT10S3Via5Node_pos);};

  AnyRefNode LongissimusThoracisT11S3Via4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT11S3Via4Node_pos);};
  AnyRefNode LongissimusThoracisT11S3Via4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT11S3Via4Node_pos);};

  AnyRefNode LongissimusThoracisT12S3Via3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT12S3Via3Node_pos);};
  AnyRefNode LongissimusThoracisT12S3Via3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT12S3Via3Node_pos);};
  
  AnyRefNode LongissimusThoracisR4L4Via11NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR4L4Via11Node_pos);};
  AnyRefNode LongissimusThoracisR4L4Via11NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR4L4Via11Node_pos);};

  AnyRefNode LongissimusThoracisR5L5Via10NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR5L5Via10Node_pos);};
  AnyRefNode LongissimusThoracisR5L5Via10NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR5L5Via10Node_pos);};

  AnyRefNode LongissimusThoracisR6S1Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR6S1Via9Node_pos);};
  AnyRefNode LongissimusThoracisR6S1Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR6S1Via9Node_pos);};

  AnyRefNode LongissimusThoracisR7S2Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR7S2Via8Node_pos);};
  AnyRefNode LongissimusThoracisR7S2Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR7S2Via8Node_pos);};

  AnyRefNode LongissimusThoracisR8S3Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR8S3Via7Node_pos);};
  AnyRefNode LongissimusThoracisR8S3Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR8S3Via7Node_pos);};

  AnyRefNode LongissimusThoracisR9S4Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR9S4Via6Node_pos);};
  AnyRefNode LongissimusThoracisR9S4Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR9S4Via6Node_pos);};

  AnyRefNode LongissimusThoracisR10S3Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR10S3Via5Node_pos);};
  AnyRefNode LongissimusThoracisR10S3Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR10S3Via5Node_pos);};

  AnyRefNode LongissimusThoracisR11S3Via4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR11S3Via4Node_pos);};
  AnyRefNode LongissimusThoracisR11S3Via4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR11S3Via4Node_pos);};

  AnyRefNode LongissimusThoracisR12S3Via3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR12S3Via3Node_pos);};
  AnyRefNode LongissimusThoracisR12S3Via3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR12S3Via3Node_pos);};

  // End of Erector Spinae Nodes

  // Psoas Major Nodes
  AnyRefNode PsoasMajorL3_1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL3_1Node_pos);};
  AnyRefNode PsoasMajorL3_1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL3_1Node_pos);};

  AnyRefNode PsoasMajorL3_2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL3_2Node_pos);};
  AnyRefNode PsoasMajorL3_2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL3_2Node_pos);};

  AnyRefNode PsoasMajorT12Via2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorT12Via2Node_pos);};
  AnyRefNode PsoasMajorT12Via2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorT12Via2Node_pos);};

  AnyRefNode PsoasMajorL1_1Via1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_1Via1Node_pos);};
  AnyRefNode PsoasMajorL1_1Via1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_1Via1Node_pos);};

  AnyRefNode PsoasMajorL1_2Via2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_2Via2Node_pos);};
  AnyRefNode PsoasMajorL1_2Via2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_2Via2Node_pos);};

  AnyRefNode PsoasMajorL2_2Via1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL2_2Via1Node_pos);};
  AnyRefNode PsoasMajorL2_2Via1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL2_2Via1Node_pos);};
  // End of Psoas Major Nodes

  // Quadratus Lumborum Nodes
  AnyRefNode QLL3_CINodeR = {sRel = .Scale(.Data.Right.QLL3_CINode_pos);};
  AnyRefNode QLL3_CINodeL = {sRel = .Scale(.Data.Left.QLL3_CINode_pos);};
  // End of Quadratus Lumborum Nodes

  // Obliquus Externus Nodes
  AnyRefNode OEC8_RSNodeR = {sRel = .Scale(.Data.Right.OEC8_RSNode_pos);};
  AnyRefNode OEC8_RSNodeL = {sRel = .Scale(.Data.Left.OEC8_RSNode_pos);};
  // End of Obliquus Externus Nodes

  // Obliquus Internus Nodes
  AnyRefNode OICI_RS2NodeR = {sRel = .Scale(.Data.Right.OICI_RS2Node_pos);};
  AnyRefNode OICI_RS2NodeL = {sRel = .Scale(.Data.Left.OICI_RS2Node_pos);};
  // End of Obliquus Internus Nodes

  //AnyDrawSeg DrwSeg = {};

  AnyDrawSurf BoneDraw = {
    FileName = ...Data.unscaled.STL.FilenameL3Seg;
    RGB = ...ColorRef.Segments;
    Opacity = Main.DrawSettings.BonesOpacity.L3;
    AnyFunTransform3D &Scale =.Scale;
  };

  #if BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_
    AnyRefNode TransversusInsNode_R={sRel=.Scale(.Data.Right.Transversus_Ins_pos);};
    AnyRefNode TransversusInsNode_L={sRel=.Scale(.Data.Left.Transversus_Ins_pos);};
    AnyRefNode TransversusMid={sRel=0.5*(.TransversusInsNode_R.sRel+.TransversusInsNode_L.sRel) ;};
  #else
    AnyRefNode TransversusOrgNode = {sRel = .MidPoint.sRel;};
    AnyRefNode TransversusInsNode = {sRel = .TransversusOrgNode.sRel;};
  #endif

  AnyRefNode MidPoint = {sRel = (.L2L3JntNode.sRel+.L3L4JntNode.sRel)*0.5; };

  AnyRefNode SupportNode = {sRel = .Scale(.Data.SupportNode_pos);};
  AnyRefNode BuckleContactNode = {sRel = .ScaleAbdominal(.Data.BuckleContactNode_pos);};

  AnyRefNode L3RContactNode = {sRel= .Scale(.Data.Right.ContactNode_pos);};
  AnyRefNode L3LContactNode = {sRel= .Scale(.Data.Left.ContactNode_pos);};
}; // End of L3Seg

AnySeg L2Seg = {
  AnyFolder &Data=..Data.unscaled.ModelParameters.L2;

  //initial position found as a function of pelvis pos and orientation
  r0=.L3Seg.L2L3JntNode.sRel*.L3Seg.Axes0'+.L3Seg.r0-L2L3JntNode.sRel*Axes0';

  // This file includes the trunk specifc scaling function
  // and anatomical reference system
  #include "TrunkAnatomicalFrame.any"

  TrunkScaleWithInterfaceMorphing Scale(
    GeomScale = ...Scaling.GeometricalScaling.L2Seg.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  TrunkScaleWithInterfaceMorphing ScaleAbdominal(
    GeomScale = ...Scaling.GeometricalScaling.Lumbar.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  // Inertia properties for the segment
  UseInertiaObjects = On;

  #if (BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_)
    AnyInertiaSolid BoneInertiaObject = {
      BodyMassCorrection massCorrection() = {
        DensityTheoretical = ....Data.unscaled.ModelParameters.BoneDensity;
        enableMassCorrection = Off;
      };
      AnySurfSTL surface = {
        FileName = ..BoneDraw.FileName;
        AnyFunTransform3D &scale = ..Scale;
        viewSurface.RGB = {0,0,1};
        ScaleXYZ = ..BoneDraw.ScaleXYZ;
      };
    };
  #else
    AnyInertiaMatrix InertiaObject = {
      BodyMassCorrectionCompatibility massCorrection() = {
        DensityTheoretical = ....Data.unscaled.StandardParameters.Lumbar.L2Mass;
      };
      Jii = {0.001,0.001,0.001};
      JaboutCoMOnOff = On;
      sCoM = .Scale(.Data.sCoM_pos);
    };
  #endif




  AnyRefNode L2L3JntNode = {sRel = .Scale(.Data.L2L3JntNode_pos);};
  AnyRefNode L1L2JntNode = {
    sRel = .Scale(.Data.L1L2JntNode_pos);
    // Rotated node with x axis parallel to the superior endplate surface
    AnyRefNode RotNode = {
      ARel = RotMat(
        0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel),
        ..SuperiorEndplateAnteriorNode.sRel,
        0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel) + (..SuperiorEndplateNodeL.sRel - ..SuperiorEndplateNodeR.sRel)
      )*RotMat(pi/2,x);
    };
  };

  // Nodes at the anterior and posterior points on the superior endplate
  AnyRefNode SuperiorEndplateAnteriorNode = {sRel = .Scale(.Data.SuperiorEndplateAnteriorNode_pos);};
  AnyRefNode SuperiorEndplatePosteriorNode = {sRel = .Scale(.Data.SuperiorEndplatePosteriorNode_pos);};

  // Nodes at the right and left points on the superior endplate
  AnyRefNode SuperiorEndplateNodeR = {sRel = .Scale(.Data.Right.SuperiorEndplateNode_pos);};
  AnyRefNode SuperiorEndplateNodeL = {sRel = .Scale(.Data.Left.SuperiorEndplateNode_pos);};

  //These nodes are used for adding extra used by other body parts to the right
  //and left side of the segment
  AnyRefNode Right = {AnyFunTransform3D&Scale=.Scale;
    AnyRefNode ICSpringSupNode        = { sRel =  .Scale(..Data.Right.ICSpringSupNode_pos); };
  };
  AnyRefNode Left = {AnyFunTransform3D&Scale=.Scale;
    AnyRefNode ICSpringSupNode        = { sRel =  .Scale(..Data.Left.ICSpringSupNode_pos); };
  };


  // Ligament Nodes
  AnyRefNode LSNode = {sRel = .Scale(.Data.LSNode_pos);};
  AnyRefNode LSNode2 = {sRel = .Scale(.Data.LSNode2_pos);};

  AnyRefNode LINodeInferior = {sRel = .Scale(.Data.LINodeInferior_pos);};
  AnyRefNode LINodeSuperior = {sRel = .Scale(.Data.LINodeSuperior_pos);};
  // End of ligament Nodes

  // MultifidusLumborum Nodes
  AnyRefNode MultifidusLumborumL2L4NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL2L4Node_pos);};
  AnyRefNode MultifidusLumborumL2L4NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL2L4Node_pos);};

  AnyRefNode MultifidusLumborumL2L5_1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL2L5_1Node_pos);};
  AnyRefNode MultifidusLumborumL2L5_1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL2L5_1Node_pos);};

  AnyRefNode MultifidusLumborumL2L5_2NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL2L5_2Node_pos);};
  AnyRefNode MultifidusLumborumL2L5_2NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL2L5_2Node_pos);};

  AnyRefNode MultifidusLumborumL2S1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL2S1Node_pos);};
  AnyRefNode MultifidusLumborumL2S1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL2S1Node_pos);};

  AnyRefNode MultifidusLumborumtL2ICNodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumtL2ICNode_pos);};
  AnyRefNode MultifidusLumborumtL2ICNodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumtL2ICNode_pos);};
  // End of MultifidusLumborum Nodes

  // Erector Spinae Nodes
  AnyRefNode IliocostalisLumborumL2NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL2Node_pos);};
  AnyRefNode IliocostalisLumborumL2NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL2Node_pos);};

  AnyRefNode LongissimusThoracisL2ICNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL2ICNode_pos);};
  AnyRefNode LongissimusThoracisL2ICNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL2ICNode_pos);};

  AnyRefNode LongissimusThoracisT2L2NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT2L2Node_pos);};
  AnyRefNode LongissimusThoracisT2L2NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT2L2Node_pos);};

  AnyRefNode LTptC2L2NodeR = {sRel = .Scale(.Data.Right.LTptC2L2Node_pos);};
  AnyRefNode LTptC2L2NodeL = {sRel = .Scale(.Data.Left.LTptC2L2Node_pos);};

  AnyRefNode IliocostalisLumborumL1ViaNodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL1ViaNode_pos);};
  AnyRefNode IliocostalisLumborumL1ViaNodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL1ViaNode_pos);};

  AnyRefNode LongissimusThoracisL1ICViaNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL1ICViaNode_pos);};
  AnyRefNode LongissimusThoracisL1ICViaNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL1ICViaNode_pos);};

  AnyRefNode IliocostalisLumborumR5Via8NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR5Via8Node_pos);};
  AnyRefNode IliocostalisLumborumR5Via8NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR5Via8Node_pos);};

  AnyRefNode IliocostalisLumborumR6Via7NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR6Via7Node_pos);};
  AnyRefNode IliocostalisLumborumR6Via7NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR6Via7Node_pos);};

  AnyRefNode IliocostalisLumborumR7Via6NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR7Via6Node_pos);};
  AnyRefNode IliocostalisLumborumR7Via6NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR7Via6Node_pos);};

  AnyRefNode IliocostalisLumborumR8Via5NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR8Via5Node_pos);};
  AnyRefNode IliocostalisLumborumR8Via5NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR8Via5Node_pos);};

  AnyRefNode IliocostalisLumborumR9Via4NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR9Via4Node_pos);};
  AnyRefNode IliocostalisLumborumR9Via4NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR9Via4Node_pos);};

  AnyRefNode IliocostalisLumborumR10Via3NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR10Via3Node_pos);};
  AnyRefNode IliocostalisLumborumR10Via3NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR10Via3Node_pos);};

  AnyRefNode IliocostalisLumborumR11Via2NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR11Via2Node_pos);};
  AnyRefNode IliocostalisLumborumR11Via2NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR11Via2Node_pos);};

  AnyRefNode IliocostalisLumborumR12Via2NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR12Via2Node_pos);};
  AnyRefNode IliocostalisLumborumR12Via2NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR12Via2Node_pos);};

  AnyRefNode LongissimusThoracisT3L3Via11NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT3L3Via11Node_pos);};
  AnyRefNode LongissimusThoracisT3L3Via11NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT3L3Via11Node_pos);};

  AnyRefNode LongissimusThoracisT4L4Via10NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT4L4Via10Node_pos);};
  AnyRefNode LongissimusThoracisT4L4Via10NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT4L4Via10Node_pos);};

  AnyRefNode LongissimusThoracisT5L5Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT5L5Via9Node_pos);};
  AnyRefNode LongissimusThoracisT5L5Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT5L5Via9Node_pos);};

  AnyRefNode LongissimusThoracisT6S1Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT6S1Via8Node_pos);};
  AnyRefNode LongissimusThoracisT6S1Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT6S1Via8Node_pos);};

  AnyRefNode LongissimusThoracisT7S2Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT7S2Via7Node_pos);};
  AnyRefNode LongissimusThoracisT7S2Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT7S2Via7Node_pos);};
  
  AnyRefNode LongissimusThoracisT8S3Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT8S3Via6Node_pos);};
  AnyRefNode LongissimusThoracisT8S3Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT8S3Via6Node_pos);};
  
  AnyRefNode LongissimusThoracisT9S4Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT9S4Via5Node_pos);};
  AnyRefNode LongissimusThoracisT9S4Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT9S4Via5Node_pos);};
  
  AnyRefNode LongissimusThoracisT10S3Via4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT10S3Via4Node_pos);};
  AnyRefNode LongissimusThoracisT10S3Via4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT10S3Via4Node_pos);};
  
  AnyRefNode LongissimusThoracisT11S3Via3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT11S3Via3Node_pos);};
  AnyRefNode LongissimusThoracisT11S3Via3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT11S3Via3Node_pos);};
  
  AnyRefNode LongissimusThoracisT12S3Via2NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT12S3Via2Node_pos);};
  AnyRefNode LongissimusThoracisT12S3Via2NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT12S3Via2Node_pos);};
  
  AnyRefNode LongissimusThoracisR3L3Via11NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR3L3Via11Node_pos);};
  AnyRefNode LongissimusThoracisR3L3Via11NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR3L3Via11Node_pos);};
  
  AnyRefNode LongissimusThoracisR4L4Via10NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR4L4Via10Node_pos);};
  AnyRefNode LongissimusThoracisR4L4Via10NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR4L4Via10Node_pos);};
  
  AnyRefNode LongissimusThoracisR5L5Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR5L5Via9Node_pos);};
  AnyRefNode LongissimusThoracisR5L5Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR5L5Via9Node_pos);};
  
  AnyRefNode LongissimusThoracisR6S1Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR6S1Via8Node_pos);};
  AnyRefNode LongissimusThoracisR6S1Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR6S1Via8Node_pos);};
  
  AnyRefNode LongissimusThoracisR7S2Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR7S2Via7Node_pos);};
  AnyRefNode LongissimusThoracisR7S2Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR7S2Via7Node_pos);};
  
  AnyRefNode LongissimusThoracisR8S3Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR8S3Via6Node_pos);};
  AnyRefNode LongissimusThoracisR8S3Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR8S3Via6Node_pos);};
  
  AnyRefNode LongissimusThoracisR9S4Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR9S4Via5Node_pos);};
  AnyRefNode LongissimusThoracisR9S4Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR9S4Via5Node_pos);};
  
  AnyRefNode LongissimusThoracisR10S3Via4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR10S3Via4Node_pos);};
  AnyRefNode LongissimusThoracisR10S3Via4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR10S3Via4Node_pos);};
  
  AnyRefNode LongissimusThoracisR11S3Via3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR11S3Via3Node_pos);};
  AnyRefNode LongissimusThoracisR11S3Via3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR11S3Via3Node_pos);};
  
  AnyRefNode LongissimusThoracisR12S3Via2NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR12S3Via2Node_pos);};
  AnyRefNode LongissimusThoracisR12S3Via2NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR12S3Via2Node_pos);};
   // End of Erector Spinae Nodes

    // Psoas Major Nodes
    AnyRefNode PsoasMajorL2_1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL2_1Node_pos);};
    AnyRefNode PsoasMajorL2_1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL2_1Node_pos);};

    AnyRefNode PsoasMajorL2_2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL2_2Node_pos);};
    AnyRefNode PsoasMajorL2_2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL2_2Node_pos);};

    AnyRefNode PsoasMajorT12Via1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorT12Via1Node_pos);};
    AnyRefNode PsoasMajorT12Via1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorT12Via1Node_pos);};

    AnyRefNode PsoasMajorL1_2Via1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_2Via1Node_pos);};
    AnyRefNode PsoasMajorL1_2Via1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_2Via1Node_pos);};
    // End of Psoas Major Nodes

    // Quadratus Lumborum Nodes
    AnyRefNode QLL2_CINodeR = {sRel = .Scale(.Data.Right.QLL2_CINode_pos);};
    AnyRefNode QLL2_CINodeL = {sRel = .Scale(.Data.Left.QLL2_CINode_pos);};
    // End of Quadratus Lumborum Nodes

    // Obliquus Externus Nodes
    AnyRefNode OEC7_RSNodeR = {sRel = .Scale(.Data.Right.OEC7_RSNode_pos);};
    AnyRefNode OEC7_RSNodeL = {sRel = .Scale(.Data.Left.OEC7_RSNode_pos);};
    // End of Obliquus Externus Nodes

    // Obliquus Internus Nodes
    AnyRefNode OICI_RS1NodeR = {sRel = .Scale(.Data.Right.OICI_RS1Node_pos);};
    AnyRefNode OICI_RS1NodeL = {sRel = .Scale(.Data.Left.OICI_RS1Node_pos);};
    // End of Obliquus Internus Nodes

    // Diaphragm Muscles Nodes
    AnyRefNode DiaphragmL2_1NodeR = {sRel = .Scale(.Data.Right.DiaphragmNode1_pos); };
    AnyRefNode DiaphragmL2_2NodeR = {sRel = .Scale(.Data.Right.DiaphragmNode2_pos); };
    AnyRefNode DiaphragmL2_1NodeL = {sRel = .Scale(.Data.Left.DiaphragmNode1_pos); };
    AnyRefNode DiaphragmL2_2NodeL = {sRel = .Scale(.Data.Left.DiaphragmNode2_pos); };
    //End of Diaphragm Muscles Nodes

  AnyDrawSurf BoneDraw = {
    FileName = ...Data.unscaled.STL.FilenameL2Seg;
    RGB = ...ColorRef.Segments;
    Opacity = Main.DrawSettings.BonesOpacity.L2;
    AnyFunTransform3D &Scale =.Scale;
  };
  #if BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_
    AnyRefNode TransversusInsNode_R={sRel=.Scale(.Data.Right.Transversus_Ins_pos);};
    AnyRefNode TransversusInsNode_L={sRel=.Scale(.Data.Left.Transversus_Ins_pos);};
    AnyRefNode TransversusMid={sRel=0.5*(.TransversusInsNode_R.sRel+.TransversusInsNode_L.sRel) ;};
  #else
    AnyRefNode TransversusOrgNode = {sRel = .MidPoint.sRel;};
    AnyRefNode TransversusInsNode = {sRel = .TransversusOrgNode.sRel;};
  #endif

  AnyRefNode MidPoint = {sRel = (.L1L2JntNode.sRel+.L2L3JntNode.sRel)*0.5;};
  AnyRefNode SupportNode = {sRel = .Scale(.Data.SupportNode_pos);};
  AnyRefNode BuckleContactNode = {sRel = .ScaleAbdominal(.Data.BuckleContactNode_pos);};

  AnyRefNode L2RContactNode = {sRel= .Scale(.Data.Right.ContactNode_pos);};
  AnyRefNode L2LContactNode = {sRel= .Scale(.Data.Left.ContactNode_pos);};
}; // End of L2Seg

AnySeg L1Seg = {

  // Reference to generic data
  AnyFolder &Data = ..Data.unscaled.ModelParameters.L1;

  //initial position found as a function of pelvis pos and orientation
  r0=.L2Seg.L1L2JntNode.sRel*.L2Seg.Axes0'+.L2Seg.r0-L1L2JntNode.sRel*Axes0';

  // This file includes the trunk specifc scaling function
  // and anatomical reference system
  #include "TrunkAnatomicalFrame.any"

  TrunkScaleWithInterfaceMorphing Scale(
    GeomScale = ...Scaling.GeometricalScaling.L1Seg.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  TrunkScaleWithInterfaceMorphing ScaleAbdominal(
    GeomScale = ...Scaling.GeometricalScaling.Lumbar.ScaleFunction,
    PelvisSeg = ..PelvisSeg,
  ) = {};

  // Inertia properties for the segment
  UseInertiaObjects = On;

  #if (BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_)
    AnyInertiaSolid BoneInertiaObject = {
      BodyMassCorrection massCorrection() = {
        DensityTheoretical = ....Data.unscaled.ModelParameters.BoneDensity;
        enableMassCorrection = Off;
      };
      AnySurfSTL surface = {
        FileName = ..BoneDraw.FileName;
        AnyFunTransform3D &scale = ..Scale;
        viewSurface.RGB = {0,0,1};
        ScaleXYZ = ..BoneDraw.ScaleXYZ;
      };
    };
  #else
    AnyInertiaMatrix InertiaObject = {
      BodyMassCorrectionCompatibility massCorrection() = {
        DensityTheoretical = ....Data.unscaled.StandardParameters.Lumbar.L1Mass;
      };
      Jii = {0.001,0.001,0.001};
      JaboutCoMOnOff = On;
      sCoM = .Scale(.Data.sCoM_pos);
    };
  #endif




  AnyRefNode L1L2JntNode = {sRel = .Scale(.Data.L1L2JntNode_pos);};
  AnyRefNode T12L1JntNode = {
    sRel = .Scale(.Data.T12L1JntNode_pos);
    // Rotated node with x axis parallel to the superior endplate surface
    AnyRefNode RotNode = {
      ARel = RotMat(
        0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel),
        ..SuperiorEndplateAnteriorNode.sRel,
        0.5*(..SuperiorEndplateAnteriorNode.sRel + ..SuperiorEndplatePosteriorNode.sRel) + (..SuperiorEndplateNodeL.sRel - ..SuperiorEndplateNodeR.sRel)
      )*RotMat(pi/2,x);
    };
  };

  // Nodes at the anterior and posterior points on the superior endplate
  AnyRefNode SuperiorEndplateAnteriorNode = {sRel = .Scale(.Data.SuperiorEndplateAnteriorNode_pos);};
  AnyRefNode SuperiorEndplatePosteriorNode = {sRel = .Scale(.Data.SuperiorEndplatePosteriorNode_pos);};

  // Nodes at the right and left points on the superior endplate
  AnyRefNode SuperiorEndplateNodeR = {sRel = .Scale(.Data.Right.SuperiorEndplateNode_pos);};
  AnyRefNode SuperiorEndplateNodeL = {sRel = .Scale(.Data.Left.SuperiorEndplateNode_pos);};

  //These nodes are used for adding extra used by other body parts to the right
  //and left side of the segment
  AnyRefNode Right= {AnyFunTransform3D&Scale=.Scale;
    AnyRefNode ICSpringSupNode        = { sRel =  .Scale(..Data.Right.ICSpringSupNode_pos); };
  };
  AnyRefNode Left = {AnyFunTransform3D&Scale=.Scale;
    AnyRefNode ICSpringSupNode        = { sRel =  .Scale(..Data.Left.ICSpringSupNode_pos); };
  };


  // Ligament Nodes
  AnyRefNode LSNode = {sRel = .Scale(.Data.LSNode_pos);};

  AnyRefNode LINodeInferior = {sRel = .Scale(.Data.LINodeInferior_pos);};
  AnyRefNode LINodeSuperior = {sRel = .Scale(.Data.LINodeSuperior_pos);};
  // End of ligament Nodes

  // MultifidusLumborum Nodes
  AnyRefNode MultifidusLumborumL1L3NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL1L3Node_pos);};
  AnyRefNode MultifidusLumborumL1L3NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL1L3Node_pos);};

  AnyRefNode MultifidusLumborumL1L4NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL1L4Node_pos);};
  AnyRefNode MultifidusLumborumL1L4NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL1L4Node_pos);};

  AnyRefNode MultifidusLumborumL1L5NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL1L5Node_pos);};
  AnyRefNode MultifidusLumborumL1L5NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL1L5Node_pos);};

  AnyRefNode MultifidusLumborumL1S1NodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumL1S1Node_pos);};
  AnyRefNode MultifidusLumborumL1S1NodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumL1S1Node_pos);};

  AnyRefNode MultifidusLumborumtL1ICNodeR = {sRel = .Scale(.Data.Right.MultifidusLumborumtL1ICNode_pos);};
  AnyRefNode MultifidusLumborumtL1ICNodeL = {sRel = .Scale(.Data.Left.MultifidusLumborumtL1ICNode_pos);};
  // End of MultifidusLumborum Nodes

  // Erector Spinae Nodes
  AnyRefNode IliocostalisLumborumL1NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumL1Node_pos);};
  AnyRefNode IliocostalisLumborumL1NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumL1Node_pos);};

  AnyRefNode LongissimusThoracisL1ICNodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisL1ICNode_pos);};
  AnyRefNode LongissimusThoracisL1ICNodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisL1ICNode_pos);};

  AnyRefNode LongissimusThoracisT1L1NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT1L1Node_pos);};
  AnyRefNode LongissimusThoracisT1L1NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT1L1Node_pos);};

  AnyRefNode LTptC1L1NodeR = {sRel = .Scale(.Data.Right.LTptC1L1Node_pos);};
  AnyRefNode LTptC1L1NodeL = {sRel = .Scale(.Data.Left.LTptC1L1Node_pos);};

  AnyRefNode IliocostalisLumborumR5Via7NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR5Via7Node_pos);};
  AnyRefNode IliocostalisLumborumR5Via7NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR5Via7Node_pos);};

  AnyRefNode IliocostalisLumborumR6Via6NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR6Via6Node_pos);};
  AnyRefNode IliocostalisLumborumR6Via6NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR6Via6Node_pos);};

  AnyRefNode IliocostalisLumborumR7Via5NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR7Via5Node_pos);};
  AnyRefNode IliocostalisLumborumR7Via5NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR7Via5Node_pos);};

  AnyRefNode IliocostalisLumborumR8Via4NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR8Via4Node_pos);};
  AnyRefNode IliocostalisLumborumR8Via4NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR8Via4Node_pos);};

  AnyRefNode IliocostalisLumborumR9Via3NodeR = {sRel = .Scale(.Data.Right.IliocostalisLumborumR9Via3Node_pos);};
  AnyRefNode IliocostalisLumborumR9Via3NodeL = {sRel = .Scale(.Data.Left.IliocostalisLumborumR9Via3Node_pos);};

  AnyRefNode IliocostalisLumborumR10Via2NodeR = {sRel= .Scale(.Data.Right.IliocostalisLumborumR10Via2Node_pos);};
  AnyRefNode IliocostalisLumborumR10Via2NodeL = {sRel= .Scale(.Data.Left.IliocostalisLumborumR10Via2Node_pos);};

  AnyRefNode IliocostalisLumborumR11Via1NodeR = {sRel= .Scale(.Data.Right.IliocostalisLumborumR11Via1Node_pos);};
  AnyRefNode IliocostalisLumborumR11Via1NodeL = {sRel= .Scale(.Data.Left.IliocostalisLumborumR11Via1Node_pos);};

  AnyRefNode IliocostalisLumborumR12Via1NodeR = {sRel= .Scale(.Data.Right.IliocostalisLumborumR12Via1Node_pos);};
  AnyRefNode IliocostalisLumborumR12Via1NodeL = {sRel= .Scale(.Data.Left.IliocostalisLumborumR12Via1Node_pos);};

  AnyRefNode LongissimusThoracisT2L2Via11NodeR = {sRel= .Scale(.Data.Right.LongissimusThoracisT2L2Via11Node_pos);};
  AnyRefNode LongissimusThoracisT2L2Via11NodeL = {sRel= .Scale(.Data.Left.LongissimusThoracisT2L2Via11Node_pos);};

  AnyRefNode LongissimusThoracisT3L3Via10NodeR = {sRel= .Scale(.Data.Right.LongissimusThoracisT3L3Via10Node_pos);};
  AnyRefNode LongissimusThoracisT3L3Via10NodeL = {sRel= .Scale(.Data.Left.LongissimusThoracisT3L3Via10Node_pos);};

    AnyRefNode LongissimusThoracisT4L4Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT4L4Via9Node_pos);};
    AnyRefNode LongissimusThoracisT4L4Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT4L4Via9Node_pos);};

    AnyRefNode LongissimusThoracisT5L5Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT5L5Via8Node_pos);};
    AnyRefNode LongissimusThoracisT5L5Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT5L5Via8Node_pos);};

    AnyRefNode LongissimusThoracisT6S1Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT6S1Via7Node_pos);};
    AnyRefNode LongissimusThoracisT6S1Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT6S1Via7Node_pos);};

    AnyRefNode LongissimusThoracisT7S2Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT7S2Via6Node_pos);};
    AnyRefNode LongissimusThoracisT7S2Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT7S2Via6Node_pos);};

    AnyRefNode LongissimusThoracisT8S3Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT8S3Via5Node_pos);};
    AnyRefNode LongissimusThoracisT8S3Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT8S3Via5Node_pos);};

    AnyRefNode LongissimusThoracisT9S4Via4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT9S4Via4Node_pos);};
    AnyRefNode LongissimusThoracisT9S4Via4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT9S4Via4Node_pos);};

    AnyRefNode LongissimusThoracisT10S3Via3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT10S3Via3Node_pos);};
    AnyRefNode LongissimusThoracisT10S3Via3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT10S3Via3Node_pos);};

    AnyRefNode LongissimusThoracisT11S3Via2NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT11S3Via2Node_pos);};
    AnyRefNode LongissimusThoracisT11S3Via2NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT11S3Via2Node_pos);};

    AnyRefNode LongissimusThoracisT12S3Via1NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisT12S3Via1Node_pos);};
    AnyRefNode LongissimusThoracisT12S3Via1NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisT12S3Via1Node_pos);};

    AnyRefNode LongissimusThoracisR3L3Via10NodeR = {sRel= .Scale(.Data.Right.LongissimusThoracisR3L3Via10Node_pos);};
    AnyRefNode LongissimusThoracisR3L3Via10NodeL = {sRel= .Scale(.Data.Left.LongissimusThoracisR3L3Via10Node_pos);};

    AnyRefNode LongissimusThoracisR4L4Via9NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR4L4Via9Node_pos);};
    AnyRefNode LongissimusThoracisR4L4Via9NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR4L4Via9Node_pos);};

    AnyRefNode LongissimusThoracisR5L5Via8NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR5L5Via8Node_pos);};
    AnyRefNode LongissimusThoracisR5L5Via8NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR5L5Via8Node_pos);};

    AnyRefNode LongissimusThoracisR6S1Via7NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR6S1Via7Node_pos);};
    AnyRefNode LongissimusThoracisR6S1Via7NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR6S1Via7Node_pos);};

    AnyRefNode LongissimusThoracisR7S2Via6NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR7S2Via6Node_pos);};
    AnyRefNode LongissimusThoracisR7S2Via6NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR7S2Via6Node_pos);};

    AnyRefNode LongissimusThoracisR8S3Via5NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR8S3Via5Node_pos);};
    AnyRefNode LongissimusThoracisR8S3Via5NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR8S3Via5Node_pos);};

    AnyRefNode LongissimusThoracisR9S4Via4NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR9S4Via4Node_pos);};
    AnyRefNode LongissimusThoracisR9S4Via4NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR9S4Via4Node_pos);};

    AnyRefNode LongissimusThoracisR10S3Via3NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR10S3Via3Node_pos);};
    AnyRefNode LongissimusThoracisR10S3Via3NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR10S3Via3Node_pos);};

    AnyRefNode LongissimusThoracisR11S3Via2NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR11S3Via2Node_pos);};
    AnyRefNode LongissimusThoracisR11S3Via2NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR11S3Via2Node_pos);};

    AnyRefNode LongissimusThoracisR12S3Via1NodeR = {sRel = .Scale(.Data.Right.LongissimusThoracisR12S3Via1Node_pos);};
    AnyRefNode LongissimusThoracisR12S3Via1NodeL = {sRel = .Scale(.Data.Left.LongissimusThoracisR12S3Via1Node_pos);};
    // End of Erector Spinae Nodes

    // Psoas Major Nodes
    AnyRefNode PsoasMajorL1_1NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_1Node_pos);};
    AnyRefNode PsoasMajorL1_1NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_1Node_pos);};

    AnyRefNode PsoasMajorL1_2NodeR = {sRel = .Scale(.Data.Right.PsoasMajorL1_2Node_pos);};
    AnyRefNode PsoasMajorL1_2NodeL = {sRel = .Scale(.Data.Left.PsoasMajorL1_2Node_pos);};
    // End of Psoas Major Nodes

    // Quadratus Lumborum Nodes
    AnyRefNode QLL1_CINodeR = {sRel = .Scale(.Data.Right.QLL1_CINode_pos);};
    AnyRefNode QLL1_CINodeL = {sRel = .Scale(.Data.Left.QLL1_CINode_pos);};
    // End of Quadratus Lumborum Nodes

    // Diaphragm Muscles Nodes
    AnyRefNode DiaphragmL1_3NodeR = {sRel = .Scale(.Data.Right.DiaphragmL1_3Node_pos); };
    AnyRefNode DiaphragmL1_3NodeL = {sRel = .Scale(.Data.Left.DiaphragmL1_3Node_pos); };
    AnyRefNode DiaphragmL1_1NodeR = {sRel = .Scale(.Data.Right.DiaphragmNode1_pos); };
    AnyRefNode DiaphragmL1_2NodeR = {sRel = .Scale(.Data.Right.DiaphragmNode2_pos); };
    AnyRefNode DiaphragmL1_1NodeL = {sRel = .Scale(.Data.Left.DiaphragmNode1_pos); };
    AnyRefNode DiaphragmL1_2NodeL = {sRel = .Scale(.Data.Left.DiaphragmNode2_pos); };
    //End of Diaphragm Muscles Nodes

    AnyDrawSurf BoneDraw = {
      FileName = ...Data.unscaled.STL.FilenameL1Seg;
      RGB = ...ColorRef.Segments;
      Opacity = Main.DrawSettings.BonesOpacity.L1;
      AnyFunTransform3D &Scale =.Scale;
    };

    AnyRefNode MidPoint={sRel=(.L1L2JntNode.sRel+.T12L1JntNode.sRel)*0.5;};
    AnyRefNode SupportNode={sRel = .Scale(.Data.SupportNode_pos);};
    AnyRefNode BuckleContactNode={sRel = .ScaleAbdominal(.Data.BuckleContactNode_pos);};

    #if BM_TRUNK_CAVITY_MODEL == _CAVITY_MODEL_VOLUME_
      AnyRefNode TransversusInsNode_R={sRel=.Scale(.Data.Right.Transversus_Ins_pos);};
      AnyRefNode TransversusInsNode_L={sRel=.Scale(.Data.Left.Transversus_Ins_pos);};
      AnyRefNode TransversusMid={sRel=0.5*(.TransversusInsNode_R.sRel+.TransversusInsNode_L.sRel) ;};
    #else
      AnyRefNode TransversusOrgNode = {sRel = .MidPoint.sRel;};
      AnyRefNode TransversusInsNode = {sRel = .TransversusOrgNode.sRel;};
    #endif

  AnyRefNode L1RContactNode = {sRel= .Scale(.Data.Right.ContactNode_pos);};
  AnyRefNode L1LContactNode = {sRel= .Scale(.Data.Left.ContactNode_pos);};
}; // End of L1Seg
