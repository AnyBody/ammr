/// Morhping GM foot to TLEM foot
AnyFolder InterfaceMorphingDef = {
  /// Mirroring about XY plane
  AnyMatrix MirroringMat ={ {1,0,0},{0,1,0},{0,0,...Sign} };
  /// Manually picked points on unscaled foot
  AnyMatrix IM_PickedPoints_GMFoot_Unscaled = {
    {-0.01923199, 0.08287545, -0.005511518}, 
    {-0.01524367, -0.03055783, 0.04927201}, 
    {-0.007463424, -0.06155794, 0.01020253}, 
    {-0.01293344, -0.05830658, -0.01899186}, 
    {-0.007135777, 0.08833511, 0.02071268}, 
    {0.02138242, 0.1071969, -0.008062809}, 
    {0.02375501, 0.02864095, -0.0233577}, 
    {0.03208032, 0.06022059, -0.02273428}, 
    {0.05175828, 0.02216302, -0.00340573}, 
    {-0.005682771, 0.02788353, 0.03648632}, 
    {0.003680642, -0.06619624, 0.02785669}, 
    {-7.461739e-05, -0.1235624, 0.002615576}, 
    {-0.005960456, -0.1209222, 0.02216102}, 
    {-0.01315969, -0.07711031, 0.05734278}, 
    {0.004153599, -0.1015452, -0.007942333}, 
    {0.01403757, -0.06886744, -0.01411949}, 
    {-0.005503197, -0.1074323, -0.01630258}, 
    {-0.008881217, -0.05529472, -0.004441717}, 
    {0.004741706, -0.009375548, -0.005258739}, 
    {0.03247751, -0.02414269, -0.003396478}, 
    {0.01269824, -0.03913711, 0.02443971}, 
    {0.002571291, -0.01204249, 0.04770501}, 
    {-0.01079895, -0.04915066, 0.03774491}, 
    {0.002197147, -0.09023196, 0.03133562}, 
    {-0.005145356, -0.08897588, 0.03108988}, 
    {-0.008576392, -0.07615147, -0.01565496}, 
    {-0.002743212, -0.03913682, 0.05575598}, 
    {-0.00363709, 0.1079017, 0.01250168}, 
    {-0.004782376, -0.06353659, 0.06130007}, 
    {0.05833522, 0.05142862, 0.01873271}, 
    {0.06334619, 0.04638586, -0.01124019}, 
    {0.0377164, 0.09367504, -0.002689051}, 
    {0.06192841, 0.07178827, 0.01457353}, 
    {0.06320866, 0.06859439, 0.0001844316}, 
    {0.06480799, 0.06492618, -0.01386954}, 
    {0.06025303, 0.04879684, 0.0005955244}, 
    {0.05371409, 0.08157143, 0.01213401}, 
    {0.05326961, 0.08067272, -0.01753239}, 
    {0.05149299, 0.04835435, -0.02313999}, 
    {-0.006488462, 0.1116618, -0.003069758}, 
    {-0.00193564, 0.09943582, -0.01832405}, 
    {9.214011e-05, -0.07867796, 0.04742583}, 
    {0.05168565, 0.06911197, 0.01846063}, 
    {0.03612813, 0.07337002, 0.02077946}, 
    {0.04430569, 0.07942674, 0.0129482}, 
    {0.0449784, 0.05929221, 0.02036536},
    {0.0429171, 0.0815658, 0.032548}, // LatMal - estimated from skin
    {0.0604137, 0.063059, -0.040193}, // MedMal - estimated from skin
    0.5*({0.0429171, 0.0815658, 0.032548}+{0.0604137, 0.063059, -0.040193}), // Malleoli midpoint
  }*MirroringMat;
  /// Manually picked points on unscaled foot
  AnyMatrix IM_PickedPoints_TLEMFoot_Unscaled = {
    {-0.02130102, -0.03769134, -0.008233341}, 
    {0.1050721, -0.04453817, 0.03245867}, 
    {0.1222212, -0.03878504, -0.0002568579}, 
    {0.1292807, -0.04402486, -0.02382537}, 
    {-0.01380033, -0.02898138, 0.02019412}, 
    {-0.03260353, -0.001598987, -0.008218175}, 
    {0.03070482, -0.008148696, -0.03136819}, 
    {0.008430794, 0.003214434, -0.02903448}, 
    {0.04368711, 0.0177882, -0.0161216}, 
    {0.03992446, -0.02796289, 0.0270921}, 
    {0.1277736, -0.02817444, 0.01225129}, 
    {0.1871869, -0.04951122, -0.003472061}, 
    {0.1796889, -0.04722395, 0.01572011}, 
    {0.1506876, -0.04438514, 0.04146769}, 
    {0.1665657, -0.0326672, -0.01219934}, 
    {0.1310539, -0.02285874, -0.0193953}, 
    {0.1701887, -0.04386451, -0.02228445}, 
    {0.1240674, -0.04484852, -0.01282732}, 
    {0.07022157, -0.02648028, -0.01536114}, 
    {0.08792123, 0.0001222242, -0.01682986}, 
    {0.1002694, -0.01511084, 0.0100659}, 
    {0.08213602, -0.02599641, 0.03109123}, 
    {0.1153041, -0.0429172, 0.01840446}, 
    {0.1537493, -0.03646047, 0.01777933}, 
    {0.1507629, -0.04135209, 0.01803696}, 
    {0.1375508, -0.04119601, -0.02094636}, 
    {0.110342, -0.03273024, 0.03341644}, 
    {-0.03705186, -0.02087882, 0.01151878}, 
    {0.1351238, -0.03922414, 0.0368174}, 
    {0.0189651, 0.03239353, 0.00190588}, 
    {0.02431101, 0.02677075, -0.02540726}, 
    {-0.02008316, 0.01066485, -0.008396729}, 
    {0.003409927, 0.03481996, -0.002322742}, 
    {0.00457003, 0.03069681, -0.01461629}, 
    {0.006025272, 0.02822185, -0.02684916}, 
    {0.0223146, 0.02797556, -0.01288454}, 
    {-0.00735814, 0.02463575, -0.006546793}, 
    {-0.006714058, 0.01774023, -0.02714103}, 
    {0.02152949, 0.0186151, -0.02848754}, 
    {-0.03749964, -0.02298441, -0.002730661}, 
    {-0.03026296, -0.02417265, -0.01820481}, 
    {0.1467537, -0.03891031, 0.02916718}, 
    {0.005164963, 0.02556624, 0.001489888}, 
    {0.002747728, 0.01259543, 0.01199898}, 
    {-0.003627574, 0.01783294, -0.0003955011}, 
    {0.01447576, 0.02034176, 0.006597586},
    {-0.007908084, 0.02393846, 0.02036821}, // LatMal - picked from TLEM model parameters
    {0.008623813, 0.0271727, -0.04230592}, // MedMal - picked from TLEM model parameters 
    0.5*({-0.007908084, 0.02393846, 0.02036821}+{0.008623813, 0.0271727, -0.04230592}), // Malleoli midpoint
  }*MirroringMat;
  
  AnyInt Reduced_Set = {0,1,2,3,5,6,8,9,11,12,13,46,47};
  
  /// Affine transformation of GM foot to TLEM foot
  AnyFunTransform3DLin2 IM_Foot_GM_To_TLEM_Affine = {
    Points0 = take(.IM_PickedPoints_GMFoot_Unscaled,.Reduced_Set,0);
    Points1 = take(.IM_PickedPoints_TLEMFoot_Unscaled,.Reduced_Set,0);
    Mode = VTK_LANDMARK_AFFINE;
  };
  /// RBF Transform of GM foot to Tlem foot using affine
  /// transformation as pretransform
  AnyFunTransform3DRBF IM_FootAffine_GM_To_TLEM_RBF = {
    Points0 = .IM_PickedPoints_GMFoot_Unscaled;
    Points1 = .IM_PickedPoints_TLEMFoot_Unscaled;
    PreTransforms = {&.IM_Foot_GM_To_TLEM_Affine};
    PolynomDegree = 1;
    RBFDef.Type = RBF_Triharmonic;
    BoundingBoxOnOff = On;
    BoundingBox.ScaleXYZ = {1,1,1}*2;
    BoundingBox.DivisionFactorXYZ = {1, 1, 1}*5;
    BoundingBox.Type = BB_Cartesian;
  };
  /// Interface morphing of GM foot to TLEM foot 
  AnyFunTransform3DLin IM_Foot_GM_To_TLEM = {
    PreTransforms = {&.IM_FootAffine_GM_To_TLEM_RBF};
    ScaleMat = {{1,0,0},{0,1,0},{0,0,1}};
    Offset = {0,0,0};
  };  
  /// Rigid transformation of GM foot to TLEM foot for SCALING NONE
  AnyFunTransform3DLin2 IM_Foot_GM_To_TLEM_Rigidbody = {
    Points0 = take(.IM_PickedPoints_GMFoot_Unscaled,.Reduced_Set,0);
    Points1 = take(.IM_PickedPoints_TLEMFoot_Unscaled,.Reduced_Set,0);
    Mode = VTK_LANDMARK_RIGIDBODY;
  };
  
  /// Affine transformation of TLEM foot to GM foot
  AnyFunTransform3DLin2 IM_Foot_TLEM_To_GM_Affine = {
    Points0 = take(.IM_PickedPoints_TLEMFoot_Unscaled,.Reduced_Set,0);
    Points1 = take(.IM_PickedPoints_GMFoot_Unscaled,.Reduced_Set,0);
    Mode = VTK_LANDMARK_AFFINE;
  };
  /// RBF Transform of TLEM foot to GM foot using affine
  /// transformation as pretransform
  AnyFunTransform3DRBF IM_FootAffine_TLEM_To_GM_RBF = {
    Points0 = .IM_PickedPoints_TLEMFoot_Unscaled;
    Points1 = .IM_PickedPoints_GMFoot_Unscaled;
    PreTransforms = {&.IM_Foot_TLEM_To_GM_Affine};
    PolynomDegree = 1;
    RBFDef.Type = RBF_Triharmonic;
    BoundingBoxOnOff = On;
    BoundingBox.ScaleXYZ = {1,1,1}*2;
    BoundingBox.DivisionFactorXYZ = {1, 1, 1}*5;
    BoundingBox.Type = BB_Cartesian;
  };
  /// Interface morphing of TLEM foot to GM foot 
  AnyFunTransform3DLin IM_Foot_TLEM_To_GM = {
    PreTransforms = {&.IM_FootAffine_TLEM_To_GM_RBF};
    ScaleMat = {{1,0,0},{0,1,0},{0,0,1}};
    Offset = {0,0,0};
  }; 

};// Interface Morphing

AnyFunTransform3D Scale = {
  AnyFunTransform3D& GeomScale = ...GeoScaling.Foot.ScaleFunction;
  AnyFolder ScaleAfterInterfaceMorphingDef = {
    #define MACRO_CONSTRUCT_ANATOMICAL_FRAME_s(p, SIGN) 0.5*(p[0]+p[1])
    #define MACRO_CONSTRUCT_ANATOMICAL_FRAME_A(p, SIGN) RotMat(0.5*(p[0]+p[1]),0.5*(p[0]+p[1]) + cross(p[4]-p[3],p[5]-p[3])*SIGN, p[2]) * RotMat(-0.5*pi,z) * RotMat(1*pi,y)

    AnyFloat pUnscaled = ..InterfaceMorphingDef.IM_Foot_GM_To_TLEM(..pUnscaled);
    AnyFunTransform3D& GeomScale = .GeomScale;
    AnyVar Sign = ..Sign;
    Scale = {AnyFunTransform3D& GeomScale = .GeomScale;};
    
    #include "..\Scaling\SegScaleFunWrtAnatomicalFrame.any"
    #undef MACRO_CONSTRUCT_ANATOMICAL_FRAME_s
    #undef MACRO_CONSTRUCT_ANATOMICAL_FRAME_A
    
  };
  
  AnyFunTransform3DLin &T0 = ScaleAfterInterfaceMorphingDef.Scale.T0;
  
  PreTransforms = {
    #if BM_SCALING == _SCALING_NONE_
    // Use only rigidbody transformation of GM foot to TLEM foot: this will load 
    // the GM foot stl in original size and shape but the segmental frame will be 
    // transformed to the TLEM segmental frame
    &.InterfaceMorphingDef.IM_Foot_GM_To_TLEM_Rigidbody,
    #else
    // Use interface morphing of GM foot to TLEM foot. This applies the affine 
    // and RBF transformation to morph the GM foot to the TLEM foot.
    &.InterfaceMorphingDef.IM_Foot_GM_To_TLEM,
    #endif
    &ScaleAfterInterfaceMorphingDef.Scale
  };                 
};
AnyFunTransform3D& GeomScale = ..GeoScaling.Foot.ScaleFunction;

Talus = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
Calcaneus = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
Cuboid = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
Navicular = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
MedialCuneiform = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
IntermediateCuneiform = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
LateralCuneiform = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
Metatarsal1 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
Metatarsal2 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
Metatarsal3 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
Metatarsal4 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
Metatarsal5 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
ProximalPhalange1 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
ProximalPhalange2 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
ProximalPhalange3 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
ProximalPhalange4 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
ProximalPhalange5 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
MiddlePhalange2 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
MiddlePhalange3 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
MiddlePhalange4 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
MiddlePhalange5 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
DistalPhalange1 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
DistalPhalange2 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
DistalPhalange3 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
DistalPhalange4 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};
DistalPhalange5 = {
  AnyFunTransform3D &Scale = .Scale;
  AnyFunTransform3D& GeomScale = .GeomScale;
};

