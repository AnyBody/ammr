//This file adds ellipsoids and contact segments for the metatarsal head contact.

//The constraints take away 4 dof among the following:
//- metatarsal 1 abduction
//- metatarsal 2 abduction
//- metatarsal 3 abduction
//- metatarsal 4 abduction
//- metatarsal 5 abduction

//One of those five dof have to be driven, the four others are handled by the contact definition.


AnyFolder InterMetatarsalHeadContact = {
  
  AnyFolder &Seg = ...Seg.Foot;
  
  
  
  
  
  Seg.Metatarsal1 = {
    
    AnyRefNode EllipsoidNode = {
      sRel = .Scale({0.001296368, -0.06409144, ......Sign*-0.01477801})*.FootType.MetaScale;
      ARel = RotMat(sRel, .CenterNode.sRel, .EllipsoidNodeLateral.sRel)*RotMat(-pi/2,x)*RotMat(-pi/2,z);
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
      
      AnySurfEllipsoid ContactEllipsoid = 
      {
        AnyVar Rx = Rz;
        AnyVar Ry = vnorm(..EllipsoidNodeProximal.sRel - .sRel);
        AnyVar Rz = vnorm(..EllipsoidNodeLateral.sRel - .sRel);
        
        AnyVar Rad_min=min({Rx, Ry, Rz});
        Radius = {Rad_min, Rad_min, Rad_min};
        //        AnyDrawParamSurf Draw = 
        //        {
        //          //Visible = On;
        //          Opacity = 0.5;
        //          //RGB = {0.65, 0.65, 0.65};
        //        };
      };
    };
    
    AnyRefNode EllipsoidNodeProximal = {
      sRel = .Scale({0.007225016, -0.04708267, ......Sign*-0.01346605})*.FootType.MetaScale;
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,1,0};};
    };
    
    AnyRefNode EllipsoidNodeLateral = {
      sRel = .Scale({0.001899362, -0.06332667, ......Sign*0.001112996})*.FootType.MetaScale;
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
    };
    
  }; //Meta1
  
  
  
  
  
  Seg.Metatarsal2 = {
    
    AnyRefNode EllipsoidNode = {
      sRel = .Scale({0.0002816948, -0.06622209, ......Sign*0.01054948});
      ARel = RotMat(sRel, .CenterNode.sRel, .EllipsoidNodeLateral.sRel)*RotMat(-pi/2,x)*RotMat(-pi/2,z);
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
      
      AnySurfEllipsoid ContactEllipsoid = 
      {
        AnyVar Rx = Rz;
        AnyVar Ry = vnorm(..EllipsoidNodeProximal.sRel - .sRel);
        AnyVar Rz = vnorm(..EllipsoidNodeLateral.sRel - .sRel);
        
        AnyVar Rad_min=min({Rx, Ry, Rz});
        Radius = {Rad_min, Rad_min, Rad_min};
        //        AnyDrawParamSurf Draw = 
        //        {
        //          //Visible = On;
        //          Opacity = 0.5;
        //          //RGB = {0.65, 0.65, 0.65};
        //        };
      };
    };
    
    AnyRefNode EllipsoidNodeProximal = {
      sRel = .Scale({0.006816386, -0.05002128, ......Sign*0.01004108});
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,1,0};};
    };
    
    AnyRefNode EllipsoidNodeLateral = {
      sRel = .Scale({-0.0006564377, -0.06486035, ......Sign*0.01962616});
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
    };
    
  }; //Meta2
  
  
  
  
  Seg.Metatarsal3 = {
    
    AnyRefNode EllipsoidNode = {
      sRel = .Scale({-0.002381542, -0.06134695, ......Sign*0.0261922});
      ARel = RotMat(sRel, .CenterNode.sRel, .EllipsoidNodeLateral.sRel)*RotMat(-pi/2,x)*RotMat(-pi/2,z);
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
      
      AnySurfEllipsoid ContactEllipsoid = 
      {
        AnyVar Rx = Rz;
        AnyVar Ry = vnorm(..EllipsoidNodeProximal.sRel - .sRel);
        AnyVar Rz = vnorm(..EllipsoidNodeLateral.sRel - .sRel);
        
        AnyVar Rad_min=min({Rx, Ry, Rz});
        Radius = {Rad_min, Rad_min, Rad_min};
        //        AnyDrawParamSurf Draw = 
        //        {
        //          //Visible = On;
        //          Opacity = 0.5;
        //          //RGB = {0.65, 0.65, 0.65};
        //        };
      };
    };
    
    AnyRefNode EllipsoidNodeProximal = {
      sRel = .Scale({0.003322051, -0.04316743, ......Sign*0.02276845});
      //  AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,1,0};};
    };
    
    AnyRefNode EllipsoidNodeLateral = {
      sRel = .Scale({-0.004940128, -0.05907216, ......Sign*(0.03278368+0.002)});
      //    AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
    };
    
  }; //Meta3
  
  
  
  
  
  Seg.Metatarsal4 = {
    
    AnyRefNode EllipsoidNode = {
      sRel = .Scale({-0.003879266, -0.05017785, ......Sign*0.03955787});
      ARel = RotMat(sRel, .CenterNode.sRel, .EllipsoidNodeLateral.sRel)*RotMat(-pi/2,x)*RotMat(-pi/2,z);
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
      
      AnySurfEllipsoid ContactEllipsoid = 
      {
        AnyVar Rx = Rz;
        AnyVar Ry = vnorm(..EllipsoidNodeProximal.sRel - .sRel);
        AnyVar Rz = vnorm(..EllipsoidNodeLateral.sRel - .sRel);
        
        AnyVar Rad_min=min({Rx, Ry, Rz});
        Radius = {Rad_min, Rad_min, Rad_min};
        //        AnyDrawParamSurf Draw = 
        //        {
        //          //Visible = On;
        //          Opacity = 0.5;
        //          //RGB = {0.65, 0.65, 0.65};
        //        };
      };
    };
    
    AnyRefNode EllipsoidNodeProximal = {
      sRel = .Scale({-9.301424e-005, -0.03447814, ......Sign*0.03524464});
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,1,0};};
    };
    
    AnyRefNode EllipsoidNodeLateral = {
      sRel = .Scale({-0.003880698, -0.04813679, ......Sign*0.04806923});
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
    };
    
  }; //Meta4
  
  
  
  
  
  Seg.Metatarsal5 = {
    
    AnyRefNode EllipsoidNode = {
      sRel = .Scale({-0.007556852, (-0.03623505-0.001), ......Sign*(0.05233189)});
      ARel = RotMat(sRel, .CenterNode.sRel, .EllipsoidNodeLateral.sRel)*RotMat(-pi/2,x)*RotMat(-pi/2,z);
      //      AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
      
      AnySurfEllipsoid ContactEllipsoid = 
      {
        AnyVar Rx = Rz;
        AnyVar Ry = vnorm(..EllipsoidNodeProximal.sRel - .sRel);
        AnyVar Rz = vnorm(..EllipsoidNodeLateral.sRel - .sRel);
        
        AnyVar Rad_min=min({Rx, Ry, Rz});
        Radius = {Rad_min, Rad_min, Rad_min};
        //        AnyDrawParamSurf Draw = 
        //        {
        //          //Visible = On;
        //          Opacity = 0.5;
        //          //RGB = {0.65, 0.65, 0.65};
        //        };
      };
    };
    
    AnyRefNode EllipsoidNodeProximal = {
      sRel = .Scale({-0.003026798, -0.01951657, ......Sign*0.04689558});
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,1,0};};
    };
    
    AnyRefNode EllipsoidNodeLateral = {
      sRel = .Scale({-0.007613315, -0.03255657, ......Sign*0.06054568});
      //AnyDrawRefFrame drw={ScaleXYZ={0.01,0.01,0.01};RGB={1,0,0};};
    };
    
  }; //Meta5
  
  
  
  
  
  
  
  
  AnyKinEqSimpleDriver ContactSegM1M2Driver = {
    AnyKinLinear Line ={
      AnyRefNode &EllipRef1 = ..Seg.Metatarsal1.EllipsoidNode;
      AnyRefNode &EllipRef2 = ..Seg.Metatarsal2.EllipsoidNode;
      Ref=0;
    };
    MeasureOrganizer ={2};
    DriverPos={Line.EllipRef1.ContactEllipsoid.Rad_min+Line.EllipRef2.ContactEllipsoid.Rad_min };
    DriverVel ={0};
    Reaction.Type={Off};
    Reaction ={#include "DrawForceInJoint.any"};
  };
  
  AnyFolder Contact_M1M2  ={
    
    AnyRecruitedActuator RecAct1 =  {
      AnyKinMeasureOrg linz ={
        AnyKinLinear  &ref =...ContactSegM1M2Driver .Line; 
        MeasureOrganizer ={2};
      };
      Type = NonNegative;
      Strength ??= 3000;
      SET_DEFAULT_ACTUATOR_VOLUME;
      #include "DrawForceInJoint.any"
    };
    
  };
  
  
  AnyKinEqSimpleDriver ContactSegM2M3Driver = {
    AnyKinLinear Line ={
      AnyRefNode &EllipRef1 = ..Seg.Metatarsal2.EllipsoidNode;
      AnyRefNode &EllipRef2 = ..Seg.Metatarsal3.EllipsoidNode;
      Ref=0;
    };
    MeasureOrganizer ={2};   
    DriverPos={Line.EllipRef1.ContactEllipsoid.Rad_min+Line.EllipRef2.ContactEllipsoid.Rad_min };
    DriverVel ={0};
    Reaction.Type={Off};
    Reaction ={#include "DrawForceInJoint.any"};
  };
  
  AnyFolder Contact_M2M3  ={
    AnyRecruitedActuator RecAct1 =  {
      AnyKinMeasureOrg linz ={
        AnyKinLinear  &ref =...ContactSegM2M3Driver .Line; 
        MeasureOrganizer ={2};
      };
      Type = NonNegative;
      Strength ??= 3000;
      SET_DEFAULT_ACTUATOR_VOLUME;
      #include "DrawForceInJoint.any"
    };
    
  };
  
  
  AnyKinEqSimpleDriver ContactSegM3M4Driver = {
    AnyKinLinear Line ={
      AnyRefNode &EllipRef1 = ..Seg.Metatarsal3.EllipsoidNode;
      AnyRefNode &EllipRef2 = ..Seg.Metatarsal4.EllipsoidNode;
      Ref=0;
    };
    MeasureOrganizer ={2};
    DriverPos={Line.EllipRef1.ContactEllipsoid.Rad_min+Line.EllipRef2.ContactEllipsoid.Rad_min };
    DriverVel ={0};
    Reaction.Type={Off};
    Reaction ={#include "DrawForceInJoint.any"};
  };
  
  AnyFolder Contact_M3M4  ={
    AnyRecruitedActuator RecAct1 =  {
      AnyKinMeasureOrg linz ={
        AnyKinLinear  &ref =...ContactSegM3M4Driver .Line; 
        MeasureOrganizer ={2};
      };
      Type = NonNegative;
      Strength ??= 3000;
      SET_DEFAULT_ACTUATOR_VOLUME;
      #include "DrawForceInJoint.any"
    };
  };
  
  
  
  AnyKinEqSimpleDriver ContactSegM4M5Driver = {
    AnyKinLinear Line ={
      AnyRefNode &EllipRef1 = ..Seg.Metatarsal4.EllipsoidNode;
      AnyRefNode &EllipRef2 = ..Seg.Metatarsal5.EllipsoidNode;
      Ref=0;
    };
    MeasureOrganizer ={2};          
    DriverPos={Line.EllipRef1.ContactEllipsoid.Rad_min+Line.EllipRef2.ContactEllipsoid.Rad_min };
    DriverVel ={0};
    Reaction.Type={Off};
    Reaction ={#include "DrawForceInJoint.any"};
  };
  
  AnyFolder Contact_M4M5  ={
    AnyRecruitedActuator RecAct1 =  {
      AnyKinMeasureOrg linz ={
        AnyKinLinear  &ref =...ContactSegM4M5Driver .Line; 
        MeasureOrganizer ={2};
      };
      Type = NonNegative;
      Strength ??= 3000;
      SET_DEFAULT_ACTUATOR_VOLUME;
      #include "DrawForceInJoint.any"
    };
  };
};//InterMetatarsalHeadContact