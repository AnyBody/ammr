/**^
This folder implements the simple muscle models for the shoulder arm model.
Anatomical muscles are in many cases split into
several branches (elements). Strength parameters are split between the branches,
typically by uniform split.
*/

DEFAULT_PARAMETER_FOLDER SubjectMusPar(
    NPARAM = 1,
    PARAM_1 = PCSAfactor, PARAM_1_TYPE = AnyVar
) = {
  Default.PCSAfactor = ......HumanModel.StrengthParameters.SpecificMuscleTensionShoulderArm; // = PCSAfactor in N/cm^2 , the PCSA itself is given in cm^2 so F0 is in Newton`s.

  // Subject specific (scaled) muscle parameters.
  #include "SubjectMusPar.any"

};



{% for name, param in muscles.items() %}
{% set nelem = param['elements'] %}
{%- if param["condition"] %}
#if {{param["condition"]}}
{%-endif %}
//{{ '/' * (name|length + 23)  }}//
//     {{ name }} ({{nelem}} element{{ 's' if nelem>1 else ' '}})     //
//{{ '/' * (name|length + 23)  }}//
{% for MuscleNo in range(param['elements']) -%}
AnyMuscleModel {{ name }}{{"_" + loop.index|string if loop.length > 1}} =
{
  AnyFolder& MuscleParameters = .SubjectMusPar.{{name}};
  AnyIntVar MuscleElemNo = {{loop.index}}; ///< The number of this element of the muscle
  AnyIntVar MuscleElemAmount = MuscleParameters.MuscleElemAmount; ///< The total amount of elements for this muscle
  F0 = .SubjectMusPar.PCSAfactor*PCSA; ///< Maximum force output at optimum fiber length
  Lf0 = MuscleParameters.OptimalFiberlength / cos(pi/180*MuscleParameters.Pennationangle); //< Optimal fiber length corrected by pennation angle
  AnyVar PCSA = 1e-2*MuscleParameters.MuscleVolume/(
  {%- if loop.length == 1 -%}
    Lf0
  {%- else  -%} 
    {%- for mus_no in range(param['elements']) -%}
     .{{ name + "_" + loop.index|string }}.Lf0 {{"+" if not loop.last}}
    {%- endfor -%}    
  {%- endif -%}
  ); //< PCSA (cm2) of the individual element is total volumen divided by the sum of muscle element fiber lengths.
  Vol0 = PCSA * Lf0; // New calculation of the vol for the specific muscle branch
  {#-{%- if param["distribution"] -%}
  {%- set vol_fraction = param["distribution"].split(",")[loop.index0] | float -%}
  Vol0 = 1e-6*MuscleParameters.MuscleVolume * {{vol_fraction}}; ///< Muscle volume in (m3)
  {%- else -%}
  Vol0 = 1e-6*MuscleParameters.MuscleVolume/MuscleElemAmount; ///< Muscle volume in (m3)
  {%- endif -%}#}
  {#-AnyVar PCSA = 1e4*Vol0/Lf0;///< PCSA (cm2) is calculated as muscle volume divided between muscle branches and divided by fiber length
  #}
};
 
{% endfor %}
{%- if param["condition"] %}
#endif
{%-endif %}

{% endfor %}


