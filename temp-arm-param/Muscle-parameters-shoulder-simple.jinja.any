/**^
This folder implements the simple muscle models for the shoulder arm model.
Anatomical muscles are in many cases split into
several branches (elements). Strength parameters are split between the branches,
typically by uniform split.
*/

AnyFolder DefaultMusPar = {
  AnyVar PCSAfactor ??= ......HumanModel.StrengthParameters.SpecificMuscleTensionShoulderArm; ///< PCSAfactor in N/cm^2 , the PCSA itself is given in cm^2 so F0 is in Newton`s.
};

AnyVar StrengthScaleHumerus =  .StrengthScaling.Humerus.StrengthScale;
AnyVar StrengthScaleUlna = .StrengthScaling.Ulna.StrengthScale;
AnyVar StrengthScaleHand = .StrengthScaling.Hand.StrengthScale;


{% for name, param in muscles.items() %}
{% set nelem = param['elements'] %}
{%- if param["condition"] %}
#if {{param["condition"]}}
{%-endif %}
//{{ '/' * (name|length + 23)  }}//
//     {{ name }} ({{nelem}} element{{ 's' if nelem>1 else ' '}})     //
//{{ '/' * (name|length + 23)  }}//
{% for MuscleNo in range(param['elements']) -%}
AnyMuscleModel {{ name }}{{"_" + loop.index|string if loop.length > 1}} =
{
  AnyFolder& MuscleParameters = ..ModelParameters.Muscles.{{name}};
  AnyIntVar MuscleElemNo = {{loop.index}}; ///< The number of this element of the muscle
  AnyIntVar MuscleElemAmount = MuscleParameters.MuscleElemAmount; ///< The total amount of elements for this muscle
  F0 ??= .DefaultMusPar.PCSAfactor*PCSA; ///< Maximum force output at optimum fiber length
  Lf0 ??= MuscleParameters.OptimalFiberlength / cos(pi/180*MuscleParameters.Pennationangle); //< Optimal fiber length corrected by pennation angle
  AnyVar PCSA ??= 1e4*.StrengthScale{{param['scaling']}}*MuscleParameters.MuscleVolumeSIScaled/(
  {%- if loop.length == 1 -%}
    Lf0
  {%- else  -%} 
    {%- for mus_no in range(param['elements']) -%}
     .{{ name + "_" + loop.index|string }}.Lf0 {{"+" if not loop.last}}
    {%- endfor -%}    
  {%- endif -%}
  ); ///< PCSA (cm2) of the individual element is total volumen divided by the sum of muscle element fiber lengths.
  Vol0 ??= 1e-4 * PCSA * Lf0; // New calculation of the vol for the specific muscle branch (m^3)
};
 
{% endfor %}
{%- if param["condition"] %}
#endif
{%-endif %}

{% endfor %}


