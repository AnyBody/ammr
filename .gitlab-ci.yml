
variables:
  GIT_STRATEGY: fetch


BM_combination_tests:
  stage: test
  script:
    - pytest "Tests/BM combinations" -n 2
  except:
    -  /^docs.*$/
  tags:
    - ams

other_tests:
  stage: test
  script:
    - pytest "--ignore=Tests/BM combinations" "--ignore=Tests/Application Tests"
  except:
    -  /^docs.*$/
  tags:
    - ams

Application_tests:
  stage: test
  script:
    - pytest --ff Tests/Applications -n 4
  except:
    -  /^docs.*$/
  tags:
    - ams

    
.job_template: &setup_docs_build_env
  before_script:
    - export CONDA_PKGS_DIRS="conda-cache"
    #- wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    #- bash miniconda.sh -b -p $HOME/miniconda
    #- export PATH="$HOME/miniconda/bin:$PATH"
    #- hash -r
    - conda config --set always_yes yes --set changeps1 no
    - conda config --add channels conda-forge # For sphinxcontrib.autoprogram
    #- conda update -q conda
    - conda update conda 
    - conda info -a
    - conda create -n doc-build-environment python=3.6 sphinx cloud_sptheme pygments_anyscript
    #- conda create -q -n doc-build-environment python=3.6 sphinx cloud_sptheme pygments_anyscript
    - source activate doc-build-environment
    - pip install sphinxcontrib-fulltoc
  cache:
    paths:
      - conda-cache
  tags:
    - docker
    - linux
  allow_failure: false



test_docs:
  image:
    name: continuumio/miniconda3
    #entrypoint: ["/bin/bash", "-c"]

  <<: *setup_docs_build_env
  script:
    - set -e
    - cd Docs
    - make html
    - cd ..
    - mkdir -p .public/dev
    - cp -r Docs/_build/html/* .public/dev
    - mv .public public
  only:
    - branches

  artifacts:
    paths:
    - public
    expire_in: 1 hour


deploy_docs:
  stage: deploy
  environment:
    name: staging
    #url: https://docs.gitlab.com
  before_script:
    - gem install dpl
  script:
    - ls public
    - dpl --provider=pages --repo="AnyBody/ammr-doc" --target-branch=master --local-dir="public" --skip_cleanup --github-token=$GITHUB_TOKEN 
  #when: manual
  tags:
    - docker
    - ruby

#  git remote add https://{TOKEN}@github.com/AnyBody/ammr-doc.git
# git pull -s  recursive -X ours doctr_remote master




# deploy_docs:
#   stage: deploy
#   script:
#     - cd Docs/_build/html
#     - ls
#   only: 
#     - tags
#   except:
#     - branches
#   tags:
#     - docker
#     - linux

